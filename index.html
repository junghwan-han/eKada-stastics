<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµìœ¡ì‹¤ì  ê´€ë¦¬ë„êµ¬ 2026 â€” KADA ë„í•‘ë°©ì§€êµìœ¡</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --kada-blue: #1a4b8c;
      --kada-light: #e8f0fb;
      --accent: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #d1d5db;
      --bg: #f8fafc;
      --surface: #fff;
      --text: #1e293b;
      --muted: #64748b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
    }

    /* â”€â”€ Navbar â”€â”€ */
    .navbar {
      background: var(--kada-blue);
      color: #fff;
      padding: 0 20px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-brand {
      font-size: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navbar-brand span.badge {
      background: #60a5fa;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-stat {
      font-size: 12px;
      color: #93c5fd;
    }

    /* â”€â”€ Toolbar â”€â”€ */
    .toolbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toolbar .sep {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-success:hover {
      background: #15803d;
    }

    .btn-outline {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-outline:hover {
      background: var(--kada-light);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-sm {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 4px;
    }

    /* â”€â”€ Filter bar â”€â”€ */
    .filter-bar {
      background: var(--kada-light);
      border-bottom: 1px solid #bfdbfe;
      padding: 8px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-bar input[type="text"] {
      padding: 5px 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      background: #fff;
      width: 200px;
    }

    .filter-bar input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* â”€â”€ Stats bar â”€â”€ */
    .stats-bar {
      background: #fff;
      border-bottom: 2px solid var(--border);
      padding: 8px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .stat-label {
      font-size: 10px;
      color: var(--muted);
      font-weight: 600;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--kada-blue);
    }

    /* â”€â”€ Table â”€â”€ */
    .table-wrap {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
      position: relative;
    }

    table {
      border-collapse: collapse;
      white-space: nowrap;
    }

    /* ì»¬ëŸ¼ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */
    thead th {
      position: relative;
    }

    .col-resizer {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: transparent;
      z-index: 5;
    }

    .col-resizer:hover,
    .col-resizer.dragging {
      background: rgba(255, 255, 255, 0.4);
    }

    thead tr {
      background: var(--kada-blue);
      color: #fff;
    }

    thead th {
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      border-right: 1px solid rgba(255, 255, 255, .2);
      position: sticky;
      z-index: 10;
      background: var(--kada-blue);
      /* sticky ì…€ì— ë°˜ë“œì‹œ ì§ì ‘ ë°°ê²½ ì§€ì • */
    }

    /* ì´ê³„ í–‰: ìµœìƒë‹¨ ê³ ì • */
    #tableTotalRow th {
      top: 0;
      z-index: 12;
      background: #1e3a5f;
    }

    /* ì»¬ëŸ¼ í—¤ë” í–‰: ì´ê³„ í–‰ ì•„ë˜ ê³ ì • (JSë¡œ top ì§ì ‘ ì„¤ì •) */
    #tableHeader th {
      top: 30px;
      z-index: 10;
      background: var(--kada-blue);
    }

    /* ì²« ë²ˆì§¸ ì—´ ì¢Œì¸¡ ê³ ì • */
    #tableTotalRow th:first-child {
      left: 0;
      z-index: 13;
      background: #162f5e;
    }

    #tableHeader th:first-child {
      left: 0;
      z-index: 11;
      background: #162f5e;
    }

    thead .th-target {
      background: #1e4a8a;
      font-size: 10px;
      min-width: 50px;
    }

    thead .th-total {
      background: #b45309;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .1s;
    }

    tbody tr:hover {
      background: var(--kada-light);
    }

    tbody td {
      padding: 6px 10px;
      text-align: center;
      border-right: 1px solid #f1f5f9;
    }

    tbody td:first-child {
      position: sticky;
      left: 0;
      background: #f8fafc;
      border-right: 2px solid var(--border);
      z-index: 5;
    }

    tbody tr:hover td:first-child {
      background: var(--kada-light);
    }

    td.name-cell {
      text-align: left;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    td.num-cell {
      color: var(--accent);
      font-weight: 600;
    }

    td.total-cell {
      color: #b45309;
      font-weight: 700;
      background: #fef3c7 !important;
    }

    td.zero {
      color: #cbd5e1;
    }

    #tableTotalRow th {
      background: #1e3a5f !important;
      color: #e0eaff;
      font-weight: 700;
      font-size: 12px;
      padding: 6px 6px;
      border-bottom: 2px solid #3b6cb7;
      text-align: center;
      white-space: nowrap;
    }

    #tableTotalRow th.foot-label {
      color: #93c5fd;
      font-size: 11px;
      font-weight: 400;
    }

    #tableTotalRow th.foot-participant {
      color: #60a5fa;
      font-size: 13px;
    }

    #tableTotalRow th.foot-target {
      color: #86efac;
    }

    #tableTotalRow th.foot-total {
      color: #fbbf24;
      font-size: 13px;
    }

    /* â”€â”€ Modal overlay â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .modal-box {
      background: #fff;
      border-radius: 10px;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
      overflow: hidden;
    }

    .modal-header {
      background: var(--kada-blue);
      color: #fff;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 15px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
    }

    .modal-body {
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-footer {
      background: #f8fafc;
      padding: 14px 20px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      border-top: 1px solid var(--border);
    }

    /* â”€â”€ Form sections â”€â”€ */
    .form-section {
      margin-bottom: 20px;
    }

    .form-section-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--kada-blue);
      padding: 6px 12px;
      background: var(--kada-light);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      margin-bottom: 12px;
    }

    /* ì ê¸ˆ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .section-locked {
      position: relative;
    }

    .section-locked::after {
      content: 'ğŸ”’ ê°œë°œì ìˆ˜ì • ë²„íŠ¼ìœ¼ë¡œ ì ê¸ˆ í•´ì œ';
      position: absolute;
      inset: 0;
      background: rgba(248, 250, 252, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      border-radius: 6px;
      pointer-events: none;
      border: 2px dashed #cbd5e1;
    }

    .section-locked input,
    .section-locked select,
    .section-locked textarea {
      pointer-events: none;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .form-grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .form-grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group.span-2 {
      grid-column: span 2;
    }

    .form-group.span-3 {
      grid-column: span 3;
    }

    .form-group.span-4 {
      grid-column: span 4;
    }

    .form-group label {
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 12px;
      font-family: inherit;
      transition: border .15s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, .15);
    }

    .form-group input[type="number"] {
      text-align: right;
    }

    /* Target columns grid */
    .target-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .target-group-title {
      grid-column: 1 / -1;
      font-size: 10px;
      font-weight: 700;
      color: #6b7280;
      padding: 4px 0;
      border-bottom: 1px solid #e5e7eb;
      margin-top: 4px;
    }

    .target-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .target-item label {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
    }

    .target-item input {
      padding: 4px 6px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
      font-family: inherit;
    }

    .target-item input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .target-item input.has-value {
      background: #eff6ff;
      border-color: #93c5fd;
      font-weight: 700;
    }

    /* Total auto-display */
    .total-display {
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 6px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .total-display label {
      font-size: 12px;
      font-weight: 700;
      color: #92400e;
    }

    .total-display .total-num {
      font-size: 22px;
      font-weight: 700;
      color: #b45309;
    }

    /* Import modal */
    .import-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      color: var(--muted);
      cursor: pointer;
      transition: all .2s;
    }

    .import-area:hover,
    .import-area.dragover {
      border-color: var(--accent);
      background: var(--kada-light);
    }

    .import-area .icon {
      font-size: 36px;
      margin-bottom: 8px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .empty-state h3 {
      font-size: 15px;
      margin-bottom: 6px;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: #1e293b;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
      animation: slide-in .2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.success {
      background: #15803d;
    }

    .toast.error {
      background: #dc2626;
    }

    @keyframes slide-in {
      from {
        transform: translateX(100px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 7px;
      height: 7px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Checkbox filter â”€â”€ chip ìŠ¤íƒ€ì¼ */
    .filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-divider {
      width: 1px;
      height: 20px;
      background: #bfdbfe;
      flex-shrink: 0;
    }

    .filter-group .filter-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--kada-blue);
      background: #dbeafe;
      border-radius: 4px;
      padding: 3px 7px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .filter-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .filter-check {
      position: relative;
    }

    .filter-check input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
      pointer-events: none;
    }

    .filter-check label {
      display: inline-block;
      font-size: 11px;
      font-weight: 500;
      padding: 3px 9px;
      border-radius: 20px;
      border: 1px solid #bfdbfe;
      background: #fff;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
      transition: all .15s;
      line-height: 1.4;
    }

    .filter-check label:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: #eff6ff;
    }

    .filter-check input[type="checkbox"]:checked+label {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      font-weight: 600;
    }

    /* Modal tabs â”€â”€ */
    .modal-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }

    .modal-tab {
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .2s;
    }

    .modal-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .modal-tab:hover {
      color: var(--text);
    }

    .modal-tab-content {
      display: none;
    }

    .modal-tab-content.active {
      display: block;
    }

    /* Log modal â”€â”€ */
    .log-item {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      display: grid;
      grid-template-columns: 120px 150px 1fr 140px;
      gap: 12px;
      font-size: 11px;
      align-items: start;
    }

    .log-item:hover {
      background: var(--kada-light);
    }

    .log-id {
      font-weight: 600;
      color: var(--accent);
    }

    .log-field {
      color: var(--muted);
    }

    .log-change {
      word-break: break-all;
    }

    .log-time {
      color: var(--muted);
      text-align: right;
    }

    /* Grouped view â”€â”€ */
    .group-section {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .group-header {
      background: var(--kada-light);
      padding: 10px 14px;
      font-weight: 600;
      color: var(--kada-blue);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .group-header:hover {
      background: #d4e4f7;
    }

    .group-content {
      display: none;
      padding: 0;
    }

    .group-content.expanded {
      display: block;
    }

    .group-table {
      width: 100%;
      border-collapse: collapse;
    }

    .group-table thead th {
      background: #f8fafc;
      padding: 6px 10px;
      font-size: 10px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }

    .group-table tbody td {
      padding: 6px 10px;
      border-bottom: 1px solid #f1f5f9;
      text-align: center;
      font-size: 11px;
    }

    .group-table tbody tr:hover {
      background: var(--kada-light);
    }

    /* Participants list â”€â”€ */
    .participant-item {
      padding: 8px 12px;
      border-bottom: 1px solid #f1f5f9;
      display: grid;
      grid-template-columns: 80px 100px 100px 1fr;
      gap: 12px;
      font-size: 11px;
      align-items: center;
    }

    .participant-item:hover {
      background: var(--kada-light);
    }

    .participant-name {
      font-weight: 600;
    }

    .participant-role {
      color: var(--muted);
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBM0qMUnSO1WbhSRcsfl4vjWKoXN0a8HzU",
      authDomain: "ekada-2026.firebaseapp.com",
      projectId: "ekada-2026",
      storageBucket: "ekada-2026.firebasestorage.app",
      messagingSenderId: "1014383340723",
      appId: "1:1014383340723:web:77b626f4913df72a4294c6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-brand">
      <span>ğŸ“Š</span>
      êµìœ¡ì‹¤ì  ê´€ë¦¬ë„êµ¬
      <span class="badge" id="yearBadge">2026</span>
    </div>
    <div class="navbar-right">
      <span class="nav-stat" id="navStat">ë°ì´í„° ì—†ìŒ</span>
    </div>
  </nav>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn btn-primary" onclick="checkAdminAction(() => openAddModal())">â• ìƒˆ ë ˆì½”ë“œ ì¶”ê°€</button>
    <div class="sep"></div>
    <button class="btn btn-outline" onclick="checkAdminAction(() => document.getElementById('importFile').click())">ğŸ“‚
      Excel ê°€ì ¸ì˜¤ê¸°</button>
    <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none" onchange="importExcel(this)">
    <button class="btn btn-outline"
      onclick="checkAdminAction(() => document.getElementById('importJsonFile').click())">ğŸ“¥ JSON ê°€ì ¸ì˜¤ê¸°</button>
    <input type="file" id="importJsonFile" accept=".json" style="display:none" onchange="importJsonFile(this)">
    <button class="btn btn-outline" onclick="checkAdminAction(() => openBookmarkletModal())">ğŸ”— eKADA ë¶™ì—¬ë„£ê¸°</button>
    <div class="sep"></div>
    <button class="btn btn-success" onclick="exportExcel()">â¬‡ï¸ Excel ë‚´ë³´ë‚´ê¸°</button>
    <div class="sep"></div>
    <button class="btn btn-outline" onclick="openLogsModal()">ğŸ“‹ ë¡œê·¸ë³´ê¸°</button>
    <button class="btn btn-outline" onclick="openGroupedView()">ğŸ‘¥ ëŒ€ìƒë³„ ë³´ê¸°</button>
    <div class="sep"></div>
    <button id="btnMigrate" class="btn btn-outline" onclick="migrateFromLocalStorage()" style="display:none">ğŸ“¤
      ì €ì¥í•˜ê¸°</button>
    <button class="btn btn-outline" onclick="clearAllData()" style="color:#dc2626">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <!-- 1í–‰: ê²€ìƒ‰ + ìœ í˜• + ìì› -->
    <div class="filter-row">
      <div style="display:flex;align-items:center;gap:6px">
        <span style="font-size:11px;font-weight:700;color:var(--muted)">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="êµìœ¡ëª… ê²€ìƒ‰..." oninput="renderTable()">
      </div>
      <div class="filter-divider"></div>
      <div class="filter-group">
        <span class="filter-label">ìœ í˜•</span>
        <div class="filter-checkboxes" id="filterTypeGroup"></div>
      </div>
      <div class="filter-divider"></div>
      <div class="filter-group">
        <span class="filter-label">ìì›</span>
        <div class="filter-checkboxes" id="filterJawonGroup"></div>
      </div>
    </div>
    <!-- 2í–‰: ì›” -->
    <div class="filter-row">
      <div class="filter-group">
        <span class="filter-label">ì›”</span>
        <div class="filter-checkboxes" id="filterMonthGroup"></div>
      </div>
    </div>
    <!-- 3í–‰: ê¶Œì—­ -->
    <div class="filter-row">
      <div class="filter-group">
        <span class="filter-label">ê¶Œì—­</span>
        <div class="filter-checkboxes" id="filterRegionGroup"></div>
      </div>
    </div>
  </div>

  <!-- Stats bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-label">ì´ êµìœ¡ ê±´ìˆ˜</span>
      <span class="stat-value" id="statCount">0</span>
    </div>
    <div style="width:1px;height:36px;background:var(--border)"></div>
    <div class="stat-item">
      <span class="stat-label">ì°¸ì—¬ì ì´ê³„</span>
      <span class="stat-value" style="color:#2563eb" id="statParticipant">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ê°•ì‚¬ìˆ˜</span>
      <span class="stat-value" style="color:#0891b2" id="statInstructor">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ëŒ€ìƒë³„ í•©ê³„</span>
      <span class="stat-value" style="color:#7c3aed" id="statTargetTotal">0</span>
    </div>
    <div style="width:1px;height:36px;background:var(--border)"></div>
    <div class="stat-item">
      <span class="stat-label">ê¸°ê¸ˆ</span>
      <span class="stat-value" style="color:#15803d" id="statGifund">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ìì²´</span>
      <span class="stat-value" style="color:#7c3aed" id="statJache">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ê¸°íƒ€</span>
      <span class="stat-value" style="color:#d97706" id="statEtc">0</span>
    </div>
    <div style="flex:1"></div>
    <span style="font-size:11px;color:var(--muted)" id="filterStatus">í•„í„°: ì—†ìŒ</span>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table id="mainTable">
      <thead>
        <tr id="tableTotalRow"></tr>
        <tr id="tableHeader"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="empty-state" id="emptyState" style="display:none">
      <div class="icon">ğŸ“‹</div>
      <h3>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p style="font-size:12px">ìƒˆ ë ˆì½”ë“œë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ Excel íŒŒì¼ì„ ê°€ì ¸ì˜¤ì„¸ìš”.</p>
    </div>
  </div>

  <!-- ===== EDIT MODAL ===== -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2 id="modalTitle">ìƒˆ êµìœ¡ ë ˆì½”ë“œ ì¶”ê°€</h2>
        <button class="modal-close" onclick="closeModal('editModal')">âœ•</button>
      </div>
      <div class="modal-body" id="editModalBody">
        <!-- ê¸°ë³¸ ì •ë³´ íƒ­ -->
        <div id="tab-info" class="modal-tab-content active">

          <!-- ê¸°ë³¸ ì •ë³´ -->
          <div class="form-section" id="section-basic">
            <div class="form-section-title">ğŸ“Œ ê¸°ë³¸ ì •ë³´</div>
            <div class="form-grid form-grid-2" style="margin-bottom:10px">
              <div class="form-group span-2">
                <label>êµìœ¡ëª… *</label>
                <input type="text" id="f_name" placeholder="êµìœ¡ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
              </div>
            </div>
            <div class="form-grid" style="grid-template-columns: repeat(4,1fr)">
              <div class="form-group">
                <label>êµìœ¡ì¼ *</label>
                <input type="date" id="f_date" oninput="autoMonth()">
              </div>
              <div class="form-group">
                <label>ì›” (ìë™)</label>
                <input type="number" id="f_month" placeholder="ìë™" readonly style="background:#f1f5f9">
              </div>
              <div class="form-group">
                <label>ì§€ì—­(ê¶Œì—­) *</label>
                <select id="f_region">
                  <option value="">ì„ íƒ</option>
                  <option>ì„œìš¸</option>
                  <option>ë¶€ì‚°</option>
                  <option>ì¸ì²œ</option>
                  <option>ëŒ€êµ¬</option>
                  <option>ëŒ€ì „</option>
                  <option>ê´‘ì£¼</option>
                  <option>ìš¸ì‚°</option>
                  <option>ì„¸ì¢…</option>
                  <option>ê²½ê¸°</option>
                  <option>ê°•ì›</option>
                  <option>ì¶©ë¶</option>
                  <option>ì¶©ë‚¨</option>
                  <option>ì „ë¶</option>
                  <option>ì „ë‚¨</option>
                  <option>ê²½ë¶</option>
                  <option>ê²½ë‚¨</option>
                  <option>ì œì£¼</option>
                </select>
              </div>
              <div class="form-group">
                <label>êµìœ¡ìœ í˜• *</label>
                <select id="f_type">
                  <option value="">ì„ íƒ</option>
                  <option>ê°•ì˜í˜•(ëŒ€ë©´)êµìœ¡</option>
                  <option>ì˜¨ë¼ì¸ ì‹¤ì‹œê°„</option>
                  <option>ì²´í—˜í˜•</option>
                  <option>ì•„ì›ƒë¦¬ì¹˜</option>
                </select>
              </div>
              <div class="form-group">
                <label>ìì›(ì¬ì›)</label>
                <select id="f_jawon">
                  <option value="">ì„ íƒ</option>
                  <option>ê¸°ê¸ˆ</option>
                  <option>ìì²´</option>
                  <option>ê¸°íƒ€</option>
                </select>
              </div>
              <div class="form-group">
                <label>ë‹´ë‹¹ì</label>
                <input type="text" id="f_manager" placeholder="ë‹´ë‹¹ìëª…">
              </div>
              <div class="form-group">
                <label>ê¸°ê´€ëª…</label>
                <input type="text" id="f_org" list="orgList" placeholder="ê¸°ê´€ëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ">
                <datalist id="orgList">
                  <option>ëŒ€í•œì²´ìœ¡íšŒ</option>
                  <option>íšŒì›ì¢…ëª©ë‹¨ì²´</option>
                  <option>ëŒ€í•œì¥ì• ì¸ì²´ìœ¡íšŒ</option>
                  <option>ê°€ë§¹ê²½ê¸°ë‹¨ì²´</option>
                  <option>ì‹œë„ì²´ìœ¡íšŒ</option>
                  <option>ì‹œë„ì¥ì• ì¸ì²´ìœ¡íšŒ</option>
                  <option>í”„ë¡œìŠ¤í¬ì¸ ë‹¨ì²´</option>
                  <option>ì‹œë„êµìœ¡(ì§€ì›)ì²­</option>
                  <option>ì²´ìœ¡ì¤‘ê³ </option>
                  <option>í•™êµìš´ë™ë¶€</option>
                  <option>ì²´ìœ¡ì§€ë„ì ìê²©ì—°ìˆ˜ê¸°ê´€</option>
                  <option>ê¸°íƒ€</option>
                </datalist>
              </div>
              <div class="form-group span-2" style="grid-column:span 1">
                <label>êµìœ¡ì¥ì†Œ</label>
                <input type="text" id="f_place" placeholder="êµìœ¡ì¥ì†Œ">
              </div>
            </div>
          </div>

          <!-- ê°•ì‚¬ ì •ë³´ -->
          <div class="form-section" id="section-instructor">
            <div class="form-section-title">ğŸ‘¨â€ğŸ« ê°•ì‚¬ ì •ë³´</div>
            <div class="form-grid" style="grid-template-columns: 80px repeat(9,1fr)">
              <div class="form-group">
                <label>ê°•ì‚¬ ìˆ˜</label>
                <input type="number" id="f_instr_cnt" min="0" value="0">
              </div>
              <div class="form-group"><label>ê°•ì‚¬1</label><input type="text" id="f_i1" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬2</label><input type="text" id="f_i2" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬3</label><input type="text" id="f_i3" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬4</label><input type="text" id="f_i4" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬5</label><input type="text" id="f_i5" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬6</label><input type="text" id="f_i6" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬7</label><input type="text" id="f_i7" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬8</label><input type="text" id="f_i8" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬9</label><input type="text" id="f_i9" list="instrList"></div>
            </div>
            <datalist id="instrList">
              <option>ê°•ëª…ì‹ </option>
              <option>ê°•ë¯¼ìš°</option>
              <option>ê°•íš¨ì°¬</option>
              <option>ê³½ìƒìˆ˜</option>
              <option>ê¶Œì§„ìˆ™</option>
              <option>ê¶Œí˜„ì„</option>
              <option>ê¸°ë³´ë°°</option>
              <option>ê¹€ë‚˜ë¼</option>
              <option>ê¹€ë¯¼ì •</option>
              <option>ê¹€ë¯¼ì£¼</option>
              <option>ê¹€ë°˜ì„</option>
              <option>ê¹€ìƒí›ˆ</option>
              <option>ê¹€ì„í˜„</option>
              <option>ê¹€ì˜ë¯¸</option>
              <option>ê¹€ì¸ìˆ™</option>
              <option>ê¹€ì¼ì‚¼</option>
              <option>ê¹€ì§€ì˜</option>
              <option>ê¹€ì§„í›ˆ</option>
              <option>ê¹€í˜„ì£¼</option>
              <option>ê¹€í¬ì •</option>
              <option>ë‚¨ìƒì„¤</option>
              <option>ë‚¨ì„±ë¯¼</option>
              <option>ë‚¨íƒì–¸</option>
              <option>ë¬¸ìì›</option>
              <option>ë¬¸ì •í¬</option>
              <option>ë°•ì„ ê¸°</option>
              <option>ë°•ì†Œì—°</option>
              <option>ë°•ì¢…ëª…</option>
              <option>ë°•íƒœì¤€</option>
              <option>ë°•í¬ì§„</option>
              <option>ë°©ì€ì¤€</option>
              <option>ë°±ìŠ¹ì´</option>
              <option>ì„œì •í™”</option>
              <option>ì†¡ë‚˜ê²½</option>
              <option>ì‹ ìœ¤ì•„</option>
              <option>ì–‘ì˜ì§„</option>
              <option>ì—°ì•„ë¦„</option>
              <option>ì—¼ì§€í˜„</option>
              <option>ì˜¤ì •ê·œ</option>
              <option>ìœ ìœ¤ì§€</option>
              <option>ì´ê·œë…•</option>
              <option>ì´ë™í›ˆ</option>
              <option>ì´ëª…ìˆ˜</option>
              <option>ì´ì€ì˜</option>
              <option>ì´ì¬ìˆ™</option>
              <option>ì„ì±„ë²”</option>
              <option>ì¥ì„ ì›…</option>
              <option>ì „ìœ¤ê±¸</option>
              <option>ì •ì˜í›ˆ</option>
              <option>ì •í¬íƒ</option>
              <option>ì¡°ê²½í¬</option>
              <option>ì£¼ì² ê·œ</option>
              <option>ì§„ì¢…ì˜¤</option>
              <option>ì±„ë´‰êµ°</option>
              <option>ìµœê²½ì›</option>
              <option>ìµœì¤€í˜</option>
              <option>í•œì€ìˆ™</option>
              <option>í—ˆí–¥ìˆ™</option>
              <option>í™ìƒë¯¼</option>
              <option>í™ì„ë§Œ</option>
              <option>í™ì •í˜¸</option>
              <option>í™©ì¸ë¯¸</option>
              <option>ì„œë¯¼ì •</option>
              <option>ì‹ ë¬¸ê·œ</option>
              <option>í™ì„±ì¤€</option>
              <option>ê¹€ë³´ê²½</option>
              <option>í•œì •í™˜</option>
              <option>í™ìœ ì§„</option>
              <option>ë‚˜í•œêµ­</option>
            </datalist>
          </div>

          <!-- í•™ìŠµ ëŒ€ìƒ (41 columns) -->
          <div class="form-section">
            <div class="form-section-title">ğŸ¯ í•™ìŠµ ëŒ€ìƒë³„ ì¸ì›ìˆ˜ <span style="font-weight:400;color:var(--muted)">(í•µì‹¬ ì…ë ¥
                í•­ëª©)</span></div>
            <div class="target-grid" id="targetGrid">
              <!-- ëŒ€í‘œì„ ìˆ˜ -->
              <div class="target-group-title">ğŸ… ëŒ€í‘œì„ ìˆ˜</div>
              <div class="target-item"><label>êµ­ê°€ëŒ€í‘œ</label><input type="number" id="t_êµ­ê°€ëŒ€í‘œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>êµ­ê°€ëŒ€í‘œí›„ë³´</label><input type="number" id="t_êµ­ê°€ëŒ€í‘œí›„ë³´" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì²­ì†Œë…„ëŒ€í‘œ</label><input type="number" id="t_ì²­ì†Œë…„ëŒ€í‘œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê¿ˆë‚˜ë¬´ì„ ìˆ˜</label><input type="number" id="t_ê¿ˆë‚˜ë¬´ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>RTP/TP</label><input type="number" id="t_RTPTP" min="0"
                  oninput="updateTotal()"></div>
              <!-- ì‹¤ì—…/ì¥ì•  -->
              <div class="target-group-title">ğŸ¢ ì‹¤ì—…íŒ€Â·ì¥ì• ì¸</div>
              <div class="target-item"><label>ì œì¬í›„ë³µê·€</label><input type="number" id="t_ì œì¬í›„ë³µê·€ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì§ì¥ìš´ë™ê²½ê¸°ë¶€</label><input type="number" id="t_ì§ì¥ìš´ë™ê²½ê¸°ë¶€" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¥ì• ì¸êµ­ê°€ëŒ€í‘œ</label><input type="number" id="t_ì¥ì• ì¸êµ­ê°€ëŒ€í‘œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¥ì• ì¸ì„ ìˆ˜</label><input type="number" id="t_ì¥ì• ì¸ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¥ì• ì¸ì§€ì›ìš”ì›</label><input type="number" id="t_ì¥ì• ì¸ì„ ìˆ˜ì§€ì›ìš”ì›" min="0"
                  oninput="updateTotal()"></div>
              <!-- í•™êµì²´ìœ¡ -->
              <div class="target-group-title">ğŸ« í•™êµì²´ìœ¡</div>
              <div class="target-item"><label>ì´ˆë“±ì„ ìˆ˜</label><input type="number" id="t_ì´ˆë“±ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¤‘ë“±ì„ ìˆ˜</label><input type="number" id="t_ì¤‘ë“±ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê³ ë“±ì„ ìˆ˜</label><input type="number" id="t_ê³ ë“±ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì²´ìœ¡ì¤‘</label><input type="number" id="t_ì²´ìœ¡ì¤‘" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì²´ìœ¡ê³ </label><input type="number" id="t_ì²´ìœ¡ê³ " min="0"
                  oninput="updateTotal()"></div>
              <!-- ëŒ€í•™/í´ëŸ½ -->
              <div class="target-group-title">ğŸ“ ëŒ€í•™Â·í´ëŸ½</div>
              <div class="target-item"><label>í”„ë¡œìœ ìŠ¤</label><input type="number" id="t_í”„ë¡œìœ ìŠ¤" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ëŒ€í•™ì„ ìˆ˜</label><input type="number" id="t_ëŒ€í•™ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í´ëŸ½ì„ ìˆ˜ë°˜</label><input type="number" id="t_í´ëŸ½ì„ ìˆ˜ë°˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>êµì‚¬</label><input type="number" id="t_êµì‚¬" min="0" oninput="updateTotal()">
              </div>
              <div class="target-item"><label>í•™ë¶€ëª¨</label><input type="number" id="t_í•™ë¶€ëª¨" min="0"
                  oninput="updateTotal()"></div>
              <!-- í”„ë¡œ -->
              <div class="target-group-title">âš½ í”„ë¡œ ìŠ¤í¬ì¸ </div>
              <div class="target-item"><label>í”„ë¡œ(KBL)</label><input type="number" id="t_í”„ë¡œKBL" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KOVO)</label><input type="number" id="t_í”„ë¡œKOVO" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KBO)</label><input type="number" id="t_í”„ë¡œKBO" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(WKBL)</label><input type="number" id="t_í”„ë¡œWKBL" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KLPGA)</label><input type="number" id="t_í”„ë¡œKLPGA" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KPGA)</label><input type="number" id="t_í”„ë¡œKPGA" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(Kë¦¬ê·¸)</label><input type="number" id="t_í”„ë¡œKë¦¬ê·¸" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê²½ë¥œê²½ì •</label><input type="number" id="t_ê²½ë¥œê²½ì •" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"></div>
              <!-- ì§€ë„ì ìê²© -->
              <div class="target-group-title">ğŸ“œ ì§€ë„ì ìê²©ì—°ìˆ˜</div>
              <div class="target-item"><label>1ê¸‰ì „ë¬¸</label><input type="number" id="t_1ê¸‰ì „ë¬¸" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>2ê¸‰ì „ë¬¸</label><input type="number" id="t_2ê¸‰ì „ë¬¸" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>1ê¸‰ì¥ì• </label><input type="number" id="t_1ê¸‰ì¥ì• " min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>2ê¸‰ì¥ì• </label><input type="number" id="t_2ê¸‰ì¥ì• " min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>1ê¸‰ìƒí™œ</label><input type="number" id="t_1ê¸‰ìƒí™œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>2ê¸‰ìƒí™œ</label><input type="number" id="t_2ê¸‰ìƒí™œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê±´ìš´ì‚¬</label><input type="number" id="t_ê±´ìš´ì‚¬" min="0"
                  oninput="updateTotal()"></div>
              <!-- ê¸°íƒ€ -->
              <div class="target-group-title">ğŸ‘¥ ê¸°íƒ€</div>
              <div class="target-item"><label>ë…¸ì¸</label><input type="number" id="t_ë…¸ì¸" min="0" oninput="updateTotal()">
              </div>
              <div class="target-item"><label>ìœ ì†Œë…„</label><input type="number" id="t_ìœ ì†Œë…„" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í–‰ì •ê°€</label><input type="number" id="t_í–‰ì •ê°€" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì§€ë„ì</label><input type="number" id="t_ì§€ë„ì" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>íŠ¸ë ˆì´ë„ˆ</label><input type="number" id="t_íŠ¸ë ˆì´ë„ˆ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê¸°íƒ€</label><input type="number" id="t_ê¸°íƒ€" min="0" oninput="updateTotal()">
              </div>
            </div>
            <div class="total-display">
              <label>í•©ê³„ (ìë™ ê³„ì‚°)</label>
              <span class="total-num" id="totalDisplay">0 ëª…</span>
            </div>
            <!-- ì›ë³¸ ë©”ëª¨ í•„ë“œ -->
            <div class="form-group" style="margin-top:10px">
              <label>ğŸ“ í˜„ì¥ í•™ìŠµì ì¸ì› ë©”ëª¨ (ì‚¬ì´íŠ¸ ì›ë¬¸)</label>
              <textarea id="f_memo_target" rows="2"
                placeholder="edu.kada.or.kr ì›ë¬¸ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸° (ì˜ˆ: ë³¼ë§ í•™ìƒì„ ìˆ˜ 88ëª…(í•™ìƒì„ ìˆ˜74ëª…/ì§€ë„ì14ëª…))"></textarea>
            </div>
          </div>

          <!-- ê¸°íƒ€ -->
          <div class="form-section">
            <div class="form-section-title">ğŸ“ ê¸°íƒ€</div>
            <div class="form-grid form-grid-2">
              <div class="form-group span-2">
                <label>ë¹„ê³ </label>
                <textarea id="f_note" rows="2" placeholder="ë¹„ê³ "></textarea>
              </div>
            </div>
          </div>

        </div><!-- End tab-info -->

      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnDevUnlock" onclick="devUnlock()"
          style="display:none;color:#7c3aed;border-color:#7c3aed">ğŸ”“ ê°œë°œì ìˆ˜ì •</button>
        <div style="flex:1"></div>
        <button class="btn btn-outline" onclick="closeModal('editModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveRecord()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ===== BOOKMARKLET MODAL ===== -->
  <div class="modal-overlay" id="bkmModal">
    <div class="modal-box" style="max-width:640px">
      <div class="modal-header">
        <h2>ğŸ”— eKADA ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h2>
        <button class="modal-close" onclick="closeModal('bkmModal')">âœ•</button>
      </div>
      <div class="modal-body">
        <p style="font-size:12px;color:var(--muted);margin-bottom:14px">
          edu.kada.or.kr í†µê³„ í˜ì´ì§€ì—ì„œ ë³µì‚¬í•œ JSON ë°ì´í„°ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br>
          ë˜ëŠ” ì•„ë˜ ë¶ë§ˆí¬ë¦¿ ì½”ë“œë¥¼ ë¸Œë¼ìš°ì € ë¶ë§ˆí¬ì— ì €ì¥í•´ì„œ ì‚¬ìš©í•˜ì„¸ìš”.
        </p>
        <div class="form-section">
          <div class="form-section-title">ğŸ“‹ ë¶ë§ˆí¬ë¦¿ ì½”ë“œ (ë¸Œë¼ìš°ì € ë¶ë§ˆí¬ URLë¡œ ì €ì¥)</div>
          <textarea readonly rows="5" id="bookmarkletCode"
            style="width:100%;font-size:10px;padding:8px;border:1px solid var(--border);border-radius:4px;background:#f8fafc;font-family:monospace"></textarea>
          <button class="btn btn-outline" style="margin-top:6px" onclick="copyBookmarklet()">ğŸ“‹ ì½”ë“œ ë³µì‚¬</button>
        </div>
        <div class="form-section">
          <div class="form-section-title">ğŸ“¥ JSON ë°ì´í„° ë¶™ì—¬ë„£ê¸°</div>
          <textarea id="jsonPasteArea" rows="8"
            style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:monospace"
            placeholder='[{"êµìœ¡ëª…":"...","êµìœ¡ì¼":"2026-01-01","ê¶Œì—­":"ì„œìš¸",...}]'></textarea>
          <button class="btn btn-primary" style="margin-top:8px" onclick="importFromJSON()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('bkmModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ===== LOGS MODAL ===== -->
  <div class="modal-overlay" id="logsModal">
    <div class="modal-box" style="max-width:1000px">
      <div class="modal-header">
        <h2>ğŸ“‹ ìˆ˜ì • ë¡œê·¸ íˆìŠ¤í† ë¦¬</h2>
        <button class="modal-close" onclick="closeModal('logsModal')">âœ•</button>
      </div>
      <div class="modal-body" style="padding:0">
        <div id="logsContainer" style="max-height:600px;overflow-y:auto">
          <div style="padding:40px;text-align:center;color:var(--muted)">ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="clearLogsData()" style="display:none">ë¡œê·¸ ì´ˆê¸°í™”</button>
        <button class="btn btn-outline" onclick="closeModal('logsModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ===== PARTICIPANTS VIEW MODAL (ì‚¬ìš© ì•ˆí•¨ â€“ hidden) ===== -->
  <div class="modal-overlay" id="participantsModal" style="display:none">
    <div class="modal-box" style="max-width:560px">
      <div class="modal-header">
        <h2 id="participantsModalTitle">ğŸ“Š ëŒ€ìƒë³„ ì˜ˆìƒ ì¸ì›</h2>
        <button class="modal-close" onclick="closeModal('participantsModal')">âœ•</button>
      </div>
      <div class="modal-body" style="padding:0">
        <div id="participantsViewList" style="max-height:520px;overflow-y:auto"></div>
      </div>
      <div class="modal-footer">
        <span style="font-size:11px;color:var(--muted)">â€» ì˜ˆìƒ ì¸ì› ê¸°ì¤€ (ì½ê¸° ì „ìš©)</span>
        <button class="btn btn-outline" onclick="closeModal('participantsModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ===== GROUPED VIEW MODAL ===== -->
  <div class="modal-overlay" id="groupedModal">
    <div class="modal-box" style="max-width:1200px">
      <div class="modal-header">
        <h2>ğŸ‘¥ ëŒ€ìƒë³„ êµ¬ë¶„ ë³´ê¸°</h2>
        <button class="modal-close" onclick="closeModal('groupedModal')">âœ•</button>
      </div>
      <div class="modal-body" id="groupedContent" style="max-height:75vh;overflow-y:auto">
        <div style="text-align:center;color:var(--muted);padding:40px">
          ëŒ€ìƒë³„ë¡œ ê·¸ë£¹í™”ëœ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ================================================================
    // DATA MODEL
    // ================================================================
    const STORAGE_KEY = 'kada_edu_2026';
    const LOGS_KEY = 'kada_edu_logs_2026';
    let currentSort = { key: 'êµìœ¡ì¼', dir: 'desc' };

    function setSortKey(key) {
      if (currentSort.key === key) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = key;
        currentSort.dir = 'desc';
      }
      saveColWidths();
      buildHeader();
      restoreColWidths();
      renderTable();
    }

    function saveColWidths() {
      savedColWidths = Array.from(document.querySelectorAll('#tableHeader th')).map(th => th.style.width || '');
    }

    function restoreColWidths() {
      if (!savedColWidths.length) return;
      requestAnimationFrame(() => {
        document.querySelectorAll('#tableHeader th').forEach((th, i) => {
          if (savedColWidths[i]) {
            th.style.width = savedColWidths[i];
            th.style.minWidth = savedColWidths[i];
          }
        });
      });
    }
    const MONTHS = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
    const REGIONS = ['ì„œìš¸', 'ë¶€ì‚°', 'ì¸ì²œ', 'ëŒ€êµ¬', 'ëŒ€ì „', 'ê´‘ì£¼', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼'];
    const TYPES = ['ê°•ì˜í˜•(ëŒ€ë©´)êµìœ¡', 'ì˜¨ë¼ì¸ ì‹¤ì‹œê°„', 'ì²´í—˜í˜•', 'ì•„ì›ƒë¦¬ì¹˜'];
    const JAWONS = ['ê¸°ê¸ˆ', 'ìì²´', 'ê¸°íƒ€'];
    const TARGET_KEYS = [
      'êµ­ê°€ëŒ€í‘œ', 'êµ­ê°€ëŒ€í‘œí›„ë³´', 'ì²­ì†Œë…„ëŒ€í‘œ', 'ê¿ˆë‚˜ë¬´ì„ ìˆ˜', 'RTPTP',
      'ì œì¬í›„ë³µê·€ì„ ìˆ˜', 'ì§ì¥ìš´ë™ê²½ê¸°ë¶€', 'ì¥ì• ì¸êµ­ê°€ëŒ€í‘œ', 'ì¥ì• ì¸ì„ ìˆ˜', 'ì¥ì• ì¸ì„ ìˆ˜ì§€ì›ìš”ì›',
      'ì´ˆë“±ì„ ìˆ˜', 'ì¤‘ë“±ì„ ìˆ˜', 'ê³ ë“±ì„ ìˆ˜', 'ì²´ìœ¡ì¤‘', 'ì²´ìœ¡ê³ ',
      'í”„ë¡œìœ ìŠ¤', 'ëŒ€í•™ì„ ìˆ˜', 'í´ëŸ½ì„ ìˆ˜ë°˜', 'êµì‚¬', 'í•™ë¶€ëª¨',
      'í”„ë¡œKBL', 'í”„ë¡œKOVO', 'í”„ë¡œKBO', 'í”„ë¡œWKBL', 'í”„ë¡œKLPGA', 'í”„ë¡œKPGA', 'í”„ë¡œKë¦¬ê·¸', 'ê²½ë¥œê²½ì •',
      '1ê¸‰ì „ë¬¸', '2ê¸‰ì „ë¬¸', '1ê¸‰ì¥ì• ', '2ê¸‰ì¥ì• ', '1ê¸‰ìƒí™œ', '2ê¸‰ìƒí™œ', 'ê±´ìš´ì‚¬',
      'ë…¸ì¸', 'ìœ ì†Œë…„', 'í–‰ì •ê°€', 'ì§€ë„ì', 'íŠ¸ë ˆì´ë„ˆ', 'ê¸°íƒ€'
    ];
    // Excel column headers (Row 3)
    const TARGET_LABELS = [
      'êµ­ê°€ëŒ€í‘œ', 'êµ­ê°€ëŒ€í‘œ\ní›„ë³´', 'ì²­ì†Œë…„ëŒ€í‘œ', 'ê¿ˆë‚˜ë¬´ì„ ìˆ˜', 'RTP/TP',
      'ì œì¬ í›„ \në³µê·€ì„ ìˆ˜', 'ì§ì¥ìš´ë™\nê²½ê¸°ë¶€', 'ì¥ì• ì¸\nêµ­ê°€ëŒ€í‘œ', 'ì¥ì• ì¸\nì„ ìˆ˜', 'ì¥ì• ì¸\nì„ ìˆ˜ì§€ì›ìš”ì›',
      'ì´ˆë“±ì„ ìˆ˜', 'ì¤‘ë“±ì„ ìˆ˜', 'ê³ ë“±ì„ ìˆ˜', 'ì²´ìœ¡ì¤‘', 'ì²´ìœ¡ê³ ',
      'í”„ë¡œìœ ìŠ¤ ', 'ëŒ€í•™ì„ ìˆ˜', 'í´ëŸ½ ì„ ìˆ˜ë°˜', 'êµì‚¬', 'í•™ë¶€ëª¨',
      'í”„ë¡œ\n(KBL)', 'í”„ë¡œ\n(KOVO)', 'í”„ë¡œ\n(KBO)', 'í”„ë¡œ\n(WKBL)', 'í”„ë¡œ\n(KLPGA)', 'í”„ë¡œ\n(KPGA)', 'í”„ë¡œ\n(Kë¦¬ê·¸)', 'ê²½ë¥œ ê²½ì •',
      '1ê¸‰ ì „ë¬¸', '2ê¸‰ ì „ë¬¸', '1ê¸‰ ì¥ì• ', '2ê¸‰ ì¥ì• ', '1ê¸‰ ìƒí™œ', '2ê¸‰ ìƒí™œ', 'ê±´ìš´ì‚¬',
      'ë…¸ì¸', 'ìœ ì†Œë…„', 'í–‰ì •ê°€', 'ì§€ë„ì', 'íŠ¸ë ˆì´ë„ˆ', 'ê¸°íƒ€'
    ];

    let records = [];
    let editingId = null; // ìˆ˜ì • ì¤‘ì¸ ë ˆì½”ë“œì˜ Firestore document ID
    let logs = [];
    let savedColWidths = []; // ì‚¬ìš©ìê°€ ì¡°ì ˆí•œ ì»¬ëŸ¼ ë„ˆë¹„ ì €ì¥

    // â”€â”€ Firestore ì—°ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FS_COL = 'ekada2026';       // êµìœ¡ ë ˆì½”ë“œ ì»¬ë ‰ì…˜ (ë¬¸ì„œ 1ê°œ = ë ˆì½”ë“œ 1ê°œ)
    const FS_LOG_DOC = 'logs';        // ë¡œê·¸ ì „ìš© ë¬¸ì„œëª… (ì‚¬ìš©ì ìš”ì²­ ê²½ë¡œ: ekada2026/logs)

    // saveDataëŠ” ë” ì´ìƒ ì „ì²´ ë°°ì—´ì„ ì €ì¥í•˜ì§€ ì•ŠìŒ (ê°œë³„ ì €ì¥ ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
    // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ë‚¨ê²¨ë‘  (import í•¨ìˆ˜ì—ì„œ ë°°ì¹˜ ì €ì¥ í›„ ë¶ˆí•„ìš”)
    function saveData() { /* no-op: ê°œë³„ Firestore ì €ì¥ ë°©ì‹ ì‚¬ìš© */ }

    function saveLogs() {
      // ì‚¬ìš©ì ìš”ì²­ ì£¼ì†Œì¸ ekada2026/logs ì— ì €ì¥ë˜ë„ë¡ ì„¤ì •
      db.collection(FS_COL).doc(FS_LOG_DOC).set({ logs: logs })
        .catch(e => console.error('saveLogs ì˜¤ë¥˜:', e));
    }

    // ì—¬ëŸ¬ ë ˆì½”ë“œ í•œë²ˆì— Firestoreì— ì¶”ê°€ (import ìš©)
    function saveBatchToFirestore(newRecords) {
      const batch = db.batch();
      newRecords.forEach(rec => {
        const ref = db.collection(FS_COL).doc(); // ìë™ ID
        batch.set(ref, rec);
      });
      return batch.commit();
    }

    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ: ì»¬ë ‰ì…˜ ì „ì²´ êµ¬ë… â†’ ëˆ„ê°€ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œí•´ë„ ëª¨ë‘ ìë™ ë°˜ì˜
    function initFirestore() {
      // ë¡œê·¸ ë¡œë“œ (ì‚¬ìš©ì ìš”ì²­ ì£¼ì†Œì¸ ekada2026/logs ì—ì„œ ì½ì–´ì˜´)
      db.collection(FS_COL).doc(FS_LOG_DOC).get().then(doc => {
        if (doc.exists) logs = doc.data().logs || [];
      });
      // êµìœ¡ ë°ì´í„°: ì»¬ë ‰ì…˜ ë‹¨ìœ„ ì‹¤ì‹œê°„ êµ¬ë…
      db.collection(FS_COL).onSnapshot(snap => {
        let allRecords = [];
        snap.docs.forEach(doc => {
          if (doc.id === FS_LOG_DOC) return;

          const data = doc.data();
          let rawList = [];
          if (data.records && Array.isArray(data.records)) {
            rawList = data.records.map((r, i) => ({ _id: doc.id + '_' + i, ...r }));
          } else {
            rawList = [{ _id: doc.id, ...data }];
          }

          // ë°ì´í„° ì •ê·œí™” (ë³´ì •)
          rawList.forEach(r => {
            // 1. ì›”(Month) ë³´ì •: ì›” í•„ë“œê°€ ì—†ìœ¼ë©´ êµìœ¡ì¼ì—ì„œ ì¶”ì¶œ
            if (!r.ì›” && r.êµìœ¡ì¼) {
              const d = new Date(r.êµìœ¡ì¼);
              if (!isNaN(d.getTime())) r.ì›” = d.getMonth() + 1;
            }
            // 2. ê°•ì‚¬ ë³´ì •: 'ê°•ì‚¬' í•„ë“œë§Œ ìˆê³  'ê°•ì‚¬1'ì´ ì—†ìœ¼ë©´ ë³µì‚¬
            if (r.ê°•ì‚¬ && !r.ê°•ì‚¬1) r.ê°•ì‚¬1 = r.ê°•ì‚¬;
            // 3. ìœ í˜• ë³´ì •: 'ìœ í˜•'ê³¼ 'êµìœ¡ìœ í˜•' í˜¼ìš© ëŒ€ì‘
            if (r.ìœ í˜• && !r.êµìœ¡ìœ í˜•) r.êµìœ¡ìœ í˜• = r.ìœ í˜•;
            if (r.êµìœ¡ìœ í˜• && !r.ìœ í˜•) r.ìœ í˜• = r.êµìœ¡ìœ í˜•;

            allRecords.push(r);
          });
        });

        records = allRecords;
        renderTable();
      }, err => {
        console.error('Firestore ì˜¤ë¥˜:', err);
        showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error');
      });
    }
    function addLog(field, change, value) {
      logs.push({
        timestamp: new Date().toLocaleString('ko-KR'),
        field: field,
        change: change,
        value: value
      });
      saveLogs();
    }

    // ================================================================
    // TABLE RENDERING
    // ================================================================
    function buildHeader() {
      const tr = document.getElementById('tableHeader');
      const targetShort = ['êµ­ëŒ€', 'êµ­í›„', 'ì²­ì†Œë…„', 'ê¿ˆë‚˜ë¬´', 'RTP', 'ì œì¬ë³µ', 'ì§ì¥', 'ì¥êµ­', 'ì¥ì„ ', 'ì¥ì§€',
        'ì´ˆë“±', 'ì¤‘ë“±', 'ê³ ë“±', 'ì²´ì¤‘', 'ì²´ê³ ', 'ìœ ìŠ¤', 'ëŒ€í•™', 'í´ëŸ½', 'êµì‚¬', 'í•™ë¶€ëª¨',
        'KBL', 'KOVO', 'KBO', 'WKBL', 'KLPGA', 'KPGA', 'Kë¦¬ê·¸', 'ê²½ë¥œ',
        '1ì „', '2ì „', '1ì¥', '2ì¥', '1ìƒ', '2ìƒ', 'ê±´ìš´', 'ë…¸ì¸', 'ìœ ì†Œ', 'í–‰ì •', 'ì§€ë„', 'íŠ¸ë ˆ', 'ê¸°íƒ€'];

      function sortTh(label, key) {
        const active = currentSort.key === key;
        const icon = active ? (currentSort.dir === 'asc' ? 'â–²' : 'â–¼') : 'â‡…';
        const style = active ? 'cursor:pointer;background:#0f3470;white-space:nowrap' : 'cursor:pointer;white-space:nowrap';
        return `<th style="${style}" onclick="setSortKey('${key}')">${label} <span style="font-size:9px;opacity:.85">${icon}</span></th>`;
      }

      let html = '<th>No</th>'
        + sortTh('êµìœ¡ëª…', 'êµìœ¡ëª…')
        + sortTh('êµìœ¡ì¼', 'êµìœ¡ì¼')
        + '<th>ê¶Œì—­</th><th>ìì›</th><th>ìœ í˜•</th><th>ë‹´ë‹¹ì</th><th>ê°•ì‚¬</th><th>ê¸°ê´€ëª…</th><th>ì°¸ì—¬ì</th>';
      html += targetShort.map(c => `<th class="th-target">${c}</th>`).join('');
      html += '<th class="th-total">í•©ê³„</th><th>ì‘ì—…</th>';
      tr.innerHTML = html;
      // ê° thì— ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì‚½ì…
      tr.querySelectorAll('th').forEach(th => {
        const handle = document.createElement('div');
        handle.className = 'col-resizer';
        th.appendChild(handle);
        initColResize(th, handle);
      });
    }

    function initColResize(th, handle) {
      let startX, startW, didDrag = false;

      handle.addEventListener('mousedown', e => {
        e.preventDefault();
        e.stopPropagation();
        didDrag = false;
        startX = e.pageX;

        // ë“œë˜ê·¸ ì‹œì‘ ì „ ëª¨ë“  ì»¬ëŸ¼ ë„ˆë¹„ë¥¼ í˜„ì¬ í”½ì…€ê°’ìœ¼ë¡œ ê³ ì • â†’ ë¦¬í”Œë¡œìš° ë°©ì§€
        const allThs = document.querySelectorAll('#tableHeader th');
        allThs.forEach(t => {
          const w = t.getBoundingClientRect().width;
          t.style.width = w + 'px';
          t.style.minWidth = w + 'px';
        });
        startW = th.getBoundingClientRect().width;

        handle.classList.add('dragging');

        const onMove = ev => {
          didDrag = true;
          const w = Math.max(30, startW + ev.pageX - startX);
          th.style.width = w + 'px';
          th.style.minWidth = w + 'px';
        };

        const onUp = () => {
          handle.classList.remove('dragging');
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });

      // ë“œë˜ê·¸ í›„ click(ì •ë ¬) ë°œë™ ì°¨ë‹¨
      handle.addEventListener('click', e => {
        e.stopPropagation();
        e.preventDefault();
      });
    }

    function getTotal(r) {
      return TARGET_KEYS.reduce((s, k) => s + (parseInt(r[k]) || 0), 0);
    }

    function getSelectedFilters() {
      const months = Array.from(document.querySelectorAll('[name="filter_month"]:checked')).map(c => c.value);
      const regions = Array.from(document.querySelectorAll('[name="filter_region"]:checked')).map(c => c.value);
      const types = Array.from(document.querySelectorAll('[name="filter_type"]:checked')).map(c => c.value);
      const jawons = Array.from(document.querySelectorAll('[name="filter_jawon"]:checked')).map(c => c.value);
      return { months, regions, types, jawons };
    }

    function filteredRecords() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const filters = getSelectedFilters();
      let result = records.map((r, i) => ({ r, i })).filter(({ r }) => {
        if (q && !((r.êµìœ¡ëª… || '').toLowerCase().includes(q))) return false;
        if (filters.months.length > 0 && !filters.months.includes(String(r.ì›”))) return false;
        if (filters.regions.length > 0 && !filters.regions.includes(r.ê¶Œì—­)) return false;
        if (filters.types.length > 0 && !filters.types.includes(r.êµìœ¡ìœ í˜•)) return false;
        if (filters.jawons.length > 0 && !filters.jawons.includes(r.ìì›)) return false;
        return true;
      });
      // ì •ë ¬
      const { key, dir } = currentSort;
      result.sort((a, b) => {
        const va = (a.r[key] || '');
        const vb = (b.r[key] || '');
        const cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return dir === 'asc' ? cmp : -cmp;
      });
      return result;
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const emptyState = document.getElementById('emptyState');

      const searchVal = document.getElementById('searchInput').value.toLowerCase().trim();
      if (searchVal && window.lastSearchTerm !== searchVal) {
        window.lastSearchTerm = searchVal;
        addLog('ê²€ìƒ‰', 'ê²€ìƒ‰ì–´', searchVal);
      }

      const filtered = filteredRecords();
      updateStats(filtered.map(f => f.r));

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';

      // â”€â”€ ì´ê³„ í–‰ (ë°ì´í„° ìœ„ì— í‘œì‹œ) â”€â”€
      const rows = filtered.map(f => f.r);
      const ftParticipant = rows.reduce((s, r) => s + (parseInt(r.ì°¸ì—¬ììˆ˜) || parseInt(r.ì¸ì›_ê³„) || 0), 0);
      const ftInstructor = rows.filter(r => r.ê°•ì‚¬1 && String(r.ê°•ì‚¬1).trim()).length;
      const ftTargets = TARGET_KEYS.map(k => rows.reduce((s, r) => s + (parseInt(r[k]) || 0), 0));
      const ftGrandTotal = ftTargets.reduce((a, b) => a + b, 0);
      const ftTargetThs = ftTargets.map(v => `<th class="foot-target">${v || ''}</th>`).join('');
      document.getElementById('tableTotalRow').innerHTML =
        `<th class="foot-label">í•©ê³„</th>
     <th class="foot-label">${rows.length}ê±´</th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label">${ftInstructor}ëª…</th>
     <th class="foot-label"></th>
     <th class="foot-participant">${ftParticipant || ''}</th>
     ${ftTargetThs}
     <th class="foot-total">${ftGrandTotal || ''}</th>
     <th></th>`;

      const dataRows = filtered.map(({ r, i }, rowNo) => {
        const total = getTotal(r);
        const tCells = TARGET_KEYS.map(k => {
          const v = parseInt(r[k]) || 0;
          return `<td class="${v ? 'num-cell' : 'zero'}">${v || ''}</td>`;
        }).join('');
        const dateStr = r.êµìœ¡ì¼ ? String(r.êµìœ¡ì¼).substring(0, 10) : '';
        return `<tr>
      <td>${rowNo + 1}</td>
      <td class="name-cell" title="${r.êµìœ¡ëª… || ''}">${r.êµìœ¡ëª… || ''}</td>
      <td>${dateStr}</td>
      <td>${r.ê¶Œì—­ || ''}</td>
      <td>${r.ìì› || ''}</td>
      <td>${r.êµìœ¡ìœ í˜• || ''}</td>
      <td>${r.ë‹´ë‹¹ì || ''}</td>
      <td style="white-space:normal;min-width:80px">${[r.ê°•ì‚¬1, r.ê°•ì‚¬2, r.ê°•ì‚¬3, r.ê°•ì‚¬4, r.ê°•ì‚¬5, r.ê°•ì‚¬6, r.ê°•ì‚¬7, r.ê°•ì‚¬8, r.ê°•ì‚¬9].filter(Boolean).join(', ')}</td>
      <td style="max-width:100px;overflow:hidden;text-overflow:ellipsis">${r.ê¸°ê´€ëª… || ''}</td>
      <td style="text-align:center;font-weight:600">${r.ì°¸ì—¬ììˆ˜ != null ? r.ì°¸ì—¬ììˆ˜ : (r.ì¸ì›_ê³„ || '')}</td>
      ${tCells}
      <td class="total-cell">${total || ''}</td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="openEditModal('${r._id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRecord('${r._id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
      }).join('');

      tbody.innerHTML = dataRows;

      // ì´ê³„ í–‰ ë†’ì´ ì¸¡ì • í›„ ì»¬ëŸ¼ í—¤ë” top ì§ì ‘ ì„¤ì •
      function fixHeaderTop() {
        const totalRow = document.getElementById('tableTotalRow');
        const headerRow = document.getElementById('tableHeader');
        if (!totalRow || !headerRow) return;
        const h = totalRow.offsetHeight;
        if (h > 0) {
          Array.from(headerRow.querySelectorAll('th')).forEach(th => {
            th.style.top = h + 'px';
          });
        }
      }
      requestAnimationFrame(() => requestAnimationFrame(fixHeaderTop));

      // Filter status
      const activeFilters = getSelectedFilters();
      const filters = [];
      if (document.getElementById('searchInput').value) filters.push('ê²€ìƒ‰');
      if (activeFilters.months.length > 0) filters.push(activeFilters.months.join(',') + 'ì›”');
      if (activeFilters.regions.length > 0) filters.push(activeFilters.regions.join(','));
      if (activeFilters.types.length > 0) filters.push(activeFilters.types.join(','));
      if (activeFilters.jawons.length > 0) filters.push(activeFilters.jawons.join(','));
      document.getElementById('filterStatus').textContent = filters.length ? 'í•„í„°: ' + filters.join(', ') : 'í•„í„°: ì—†ìŒ';
    }

    function updateStats(recs) {
      const sumParticipant = recs.reduce((s, r) => s + (parseInt(r.ì°¸ì—¬ììˆ˜) || parseInt(r.ì¸ì›_ê³„) || 0), 0);
      const sumInstructor = recs.filter(r => r.ê°•ì‚¬1 && String(r.ê°•ì‚¬1).trim()).length;
      const sumTargetTotal = recs.reduce((s, r) => s + getTotal(r), 0);
      document.getElementById('statCount').textContent = recs.length;
      document.getElementById('statParticipant').textContent = sumParticipant.toLocaleString();
      document.getElementById('statInstructor').textContent = sumInstructor;
      document.getElementById('statTargetTotal').textContent = sumTargetTotal.toLocaleString();
      document.getElementById('statGifund').textContent = recs.filter(r => r.ìì› === 'ê¸°ê¸ˆ').length;
      document.getElementById('statJache').textContent = recs.filter(r => r.ìì› === 'ìì²´').length;
      document.getElementById('statEtc').textContent = recs.filter(r => r.ìì› === 'ê¸°íƒ€').length;
      document.getElementById('navStat').textContent = `ì´ ${records.length}ê±´ / ${sumParticipant.toLocaleString()}ëª…`;
    }

    // ================================================================
    // MODAL MANAGEMENT
    // ================================================================
    function openAddModal() {
      addLog('ë²„íŠ¼í´ë¦­', 'ìƒˆ ë ˆì½”ë“œ ì¶”ê°€', '-');
      editingId = null;
      document.getElementById('modalTitle').textContent = 'ìƒˆ êµìœ¡ ë ˆì½”ë“œ ì¶”ê°€';
      clearForm();
      // ì‹ ê·œ ì¶”ê°€: ì ê¸ˆ ì—†ìŒ, ê°œë°œì ë²„íŠ¼ ìˆ¨ê¹€
      lockBasicSections(false);
      document.getElementById('btnDevUnlock').style.display = 'none';
      document.getElementById('editModal').classList.add('active');
    }

    function openEditModal(_id) {
      editingId = _id;
      const r = records.find(rec => rec._id === _id);
      document.getElementById('modalTitle').textContent = 'êµìœ¡ ë ˆì½”ë“œ ìˆ˜ì •';
      clearForm();
      // Fill basic
      document.getElementById('f_name').value = r.êµìœ¡ëª… || '';
      document.getElementById('f_date').value = r.êµìœ¡ì¼ ? String(r.êµìœ¡ì¼).substring(0, 10) : '';
      document.getElementById('f_month').value = r.ì›” || '';
      document.getElementById('f_region').value = r.ê¶Œì—­ || '';
      document.getElementById('f_type').value = r.êµìœ¡ìœ í˜• || '';
      document.getElementById('f_jawon').value = r.ìì› || '';
      document.getElementById('f_manager').value = r.ë‹´ë‹¹ì || '';
      document.getElementById('f_org').value = r.ê¸°ê´€ëª… || '';
      document.getElementById('f_place').value = r.êµìœ¡ì¥ì†Œ || '';
      document.getElementById('f_instr_cnt').value = r.ê°•ì‚¬ìˆ˜ || 0;
      for (let i = 1; i <= 9; i++) document.getElementById('f_i' + i).value = r['ê°•ì‚¬' + i] || '';
      // Fill targets
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        if (el) {
          el.value = r[k] || '';
          el.classList.toggle('has-value', !!(r[k]));
        }
      });
      document.getElementById('f_memo_target').value = r.ë©”ëª¨_í˜„ì¥ì¸ì› || '';
      document.getElementById('f_note').value = r.ë¹„ê³  || '';
      updateTotal();
      // ìˆ˜ì • ëª¨ë“œ: ê¸°ë³¸ì •ë³´/ê°•ì‚¬ì •ë³´ ì ê¸ˆ, ê°œë°œì ë²„íŠ¼ í‘œì‹œ
      lockBasicSections(true);
      document.getElementById('btnDevUnlock').style.display = 'inline-flex';
      document.getElementById('editModal').classList.add('active');
    }

    function lockBasicSections(lock) {
      ['section-basic', 'section-instructor'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('section-locked', lock);
      });
    }

    function devUnlock() {
      const pw = prompt('ê°œë°œì ìˆ˜ì • ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw === null) return;
      if (pw !== '0318@') { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error'); return; }
      lockBasicSections(false);
      document.getElementById('btnDevUnlock').textContent = 'ğŸ”“ ì ê¸ˆ í•´ì œë¨';
      document.getElementById('btnDevUnlock').style.color = '#16a34a';
      document.getElementById('btnDevUnlock').style.borderColor = '#16a34a';
      document.getElementById('btnDevUnlock').disabled = true;
      showToast('ê¸°ë³¸ì •ë³´ ë° ê°•ì‚¬ì •ë³´ ìˆ˜ì • ê°€ëŠ¥', 'success');
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥ ì‹¤í–‰ ì „ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    function checkAdminAction(callback) {
      const pw = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw === '0318@') {
        callback();
      } else if (pw !== null) {
        showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'error');
      }
    }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function switchModalTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.modal-tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));

      // Show selected tab
      const tabEl = document.getElementById('tab-' + tabName);
      if (tabEl) {
        tabEl.classList.add('active');
        const tabBtn = document.querySelector(`.modal-tab:nth-child(${tabName === 'info' ? '1' : '2'})`);
        if (tabBtn) tabBtn.classList.add('active');

        // Load participants if switching to that tab
        if (tabName === 'participants' && editingId) {
          loadParticipants(records.find(r => r._id === editingId));
        }
      }
    }

    function clearForm() {
      document.getElementById('f_name').value = '';
      document.getElementById('f_date').value = '';
      document.getElementById('f_month').value = '';
      document.getElementById('f_region').value = '';
      document.getElementById('f_type').value = '';
      document.getElementById('f_jawon').value = '';
      document.getElementById('f_manager').value = '';
      document.getElementById('f_org').value = '';
      document.getElementById('f_place').value = '';
      document.getElementById('f_instr_cnt').value = 0;
      for (let i = 1; i <= 9; i++) document.getElementById('f_i' + i).value = '';
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        if (el) { el.value = ''; el.classList.remove('has-value'); }
      });
      document.getElementById('f_memo_target').value = '';
      document.getElementById('f_note').value = '';
      document.getElementById('totalDisplay').textContent = '0 ëª…';
    }

    function autoMonth() {
      const d = document.getElementById('f_date').value;
      if (d) {
        const m = new Date(d).getMonth() + 1;
        document.getElementById('f_month').value = m;
      }
    }

    function updateTotal() {
      let sum = 0;
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        if (el) {
          const v = parseInt(el.value) || 0;
          sum += v;
          el.classList.toggle('has-value', v > 0);
        }
      });
      document.getElementById('totalDisplay').textContent = sum.toLocaleString() + ' ëª…';
    }

    function saveRecord() {
      const name = document.getElementById('f_name').value.trim();
      if (!name) { showToast('êµìœ¡ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

      const r = {
        êµìœ¡ëª…: name,
        êµìœ¡ì¥ì†Œ: document.getElementById('f_place').value,
        êµìœ¡ì¼: document.getElementById('f_date').value,
        ì›”: parseInt(document.getElementById('f_month').value) || null,
        ê¶Œì—­: document.getElementById('f_region').value,
        ìì›: document.getElementById('f_jawon').value,
        êµìœ¡ìœ í˜•: document.getElementById('f_type').value,
        ë‹´ë‹¹ì: document.getElementById('f_manager').value,
        ê°•ì‚¬ìˆ˜: parseInt(document.getElementById('f_instr_cnt').value) || 0,
        ê¸°ê´€ëª…: document.getElementById('f_org').value,
        ë¹„ê³ : document.getElementById('f_note').value,
        ë©”ëª¨_í˜„ì¥ì¸ì›: document.getElementById('f_memo_target').value,
      };
      for (let i = 1; i <= 9; i++) r['ê°•ì‚¬' + i] = document.getElementById('f_i' + i).value;
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        const v = el ? (parseInt(el.value) || 0) : 0;
        r[k] = v || null;
      });

      if (editingId) {
        // ìˆ˜ì •: ê¸°ì¡´ ë ˆì½”ë“œì˜ Firestore ë¬¸ì„œë§Œ ì—…ë°ì´íŠ¸
        const oldRecord = records.find(rec => rec._id === editingId);
        const updated = { ...oldRecord, ...r }; // í¼ì— ì—†ëŠ” í•„ë“œ(ì°¸ì—¬ììˆ˜ ë“±) ë³´ì¡´

        // ë°ì´í„° ë³€ê²½ ë¡œê·¸ ë‚¨ê¸°ê¸°
        for (const key in r) {
          if (JSON.stringify(oldRecord[key]) !== JSON.stringify(r[key])) {
            const before = oldRecord[key] == null ? '' : oldRecord[key];
            const after = r[key] == null ? '' : r[key];
            addLog(oldRecord.êµìœ¡ëª…, key, String(before) + ' â†’ ' + String(after));
          }
        }

        if (editingId.includes('_')) {
          // ë²Œí¬ ë°ì´í„°(ë°°ì—´) ë‚´ì˜ ë ˆì½”ë“œ ìˆ˜ì • ì²˜ë¦¬
          const [docId, index] = editingId.split('_');
          const idx = parseInt(index);
          db.collection(FS_COL).doc(docId).get().then(doc => {
            if (doc.exists) {
              const data = doc.data();
              if (data.records && Array.isArray(data.records)) {
                data.records[idx] = { ...data.records[idx], ...r };
                return db.collection(FS_COL).doc(docId).set(data);
              }
            }
            // ì˜ˆì™¸ ìƒí™© ëŒ€ë¹„í•˜ì—¬ ê°œë³„ ë¬¸ì„œë¡œë¼ë„ ì €ì¥ (ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ editingId ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            return db.collection(FS_COL).doc(editingId).set(updated);
          })
            .then(() => showToast('ìˆ˜ì • ì™„ë£Œ', 'success'))
            .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'));
        } else {
          // ê°œë³„ ë¬¸ì„œ ìˆ˜ì •
          db.collection(FS_COL).doc(editingId).set(updated)
            .then(() => showToast('ìˆ˜ì • ì™„ë£Œ', 'success'))
            .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'));
        }
      } else {
        // ì‹ ê·œ: ìƒˆ Firestore ë¬¸ì„œ ì¶”ê°€ (ìë™ ID)
        addLog('ì‹ ê·œì¶”ê°€', 'êµìœ¡ëª…', name);
        db.collection(FS_COL).add(r)
          .then(() => showToast('ì¶”ê°€ ì™„ë£Œ', 'success'))
          .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'));
      }
      // renderTableì€ onSnapshotì´ ìë™ ì²˜ë¦¬
      closeModal('editModal');
    }

    function deleteRecord(_id) {
      const rec = records.find(r => r._id === _id);
      if (!confirm('ì´ ë ˆì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      addLog(rec ? rec.êµìœ¡ëª… : '', 'ì‚­ì œ', '');
      db.collection(FS_COL).doc(_id).delete()
        .then(() => showToast('ì‚­ì œë¨'))
        .catch(e => showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error'));
      // renderTableì€ onSnapshotì´ ìë™ ì²˜ë¦¬
    }

    function clearAllData() {
      const pw = prompt('ì „ì²´ ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw === null) return;
      if (pw !== '0318@') { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error'); return; }
      if (!confirm(`ì „ì²´ ${records.length}ê±´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      addLog('ë²„íŠ¼í´ë¦­', 'ì „ì²´ì‚­ì œ', '-');
      db.collection(FS_COL).get().then(snap => {
        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      }).then(() => {
        logs = [];
        saveLogs();
        showToast('ì „ì²´ ì‚­ì œë¨');
      }).catch(e => showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error'));
    }

    // ================================================================
    // IMPORT / EXPORT
    // ================================================================
    function importExcel(input) {
      addLog('ë²„íŠ¼í´ë¦­', 'Excel ê°€ì ¸ì˜¤ê¸°', '-');
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const wb = XLSX.read(e.target.result, { type: 'binary', cellDates: true });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

          // Find header row (row 3 in original = index 2)
          let headerRow = -1;
          for (let i = 0; i < Math.min(data.length, 10); i++) {
            if (data[i].includes('êµìœ¡ëª…') || data[i].includes('êµìœ¡ì¼')) { headerRow = i; break; }
          }
          if (headerRow < 0) { showToast('í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

          const headers = data[headerRow].map(h => String(h || '').trim().replace(/\n/g, ''));
          let imported = 0;
          const toAdd = [];
          for (let i = headerRow + 1; i < data.length; i++) {
            const row = data[i];
            if (!row[0] && !row[5]) continue; // skip empty
            const r = {};
            headers.forEach((h, ci) => { if (h) r[h] = row[ci] !== undefined ? row[ci] : ''; });
            const mapped = mapImportedRow(r, headers, row);
            if (mapped.êµìœ¡ëª…) {
              toAdd.push(mapped);
              imported++;
            }
          }
          if (toAdd.length > 0) {
            saveBatchToFirestore(toAdd)
              .then(() => {
                showToast(`${imported}ê±´ Firestore ì €ì¥ ì™„ë£Œ`, 'success');
                // renderTableì€ onSnapshotì´ ìë™ ì²˜ë¦¬í•˜ë¯€ë¡œ ëª…ì‹œì  í˜¸ì¶œ ë¶ˆí•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜ í™•ì¸ìš©ìœ¼ë¡œ ë‚¨ê¹€
                renderTable();
              })
              .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'));
          } else {
            showToast('ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
          }
        } catch (e) {
          showToast('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + e.message, 'error');
        }
      };
      reader.readAsBinaryString(file);
      input.value = '';
    }

    function mapImportedRow(r, headers, rowArr) {
      // Map from original Excel column positions
      const colIdx = (name) => headers.findIndex(h => h.includes(name));
      const get = (idx) => idx >= 0 ? rowArr[idx] : '';

      const mapped = {
        êµìœ¡ëª…: String(get(0) || '').trim(),
        êµìœ¡ì¥ì†Œ: String(get(4) || '').trim(),
        êµìœ¡ì¼: formatDate(get(5)),
        ì›”: parseInt(get(6)) || null,
        ê¶Œì—­: String(get(7) || '').trim(),
        ìì›: String(get(8) || '').trim(),
        êµìœ¡ìœ í˜•: String(get(9) || '').trim(),
        ë‹´ë‹¹ì: String(get(10) || '').trim(),
        ê°•ì‚¬ìˆ˜: parseInt(get(11)) || 0,
        ê¸°ê´€ëª…: String(get(21) || '').trim(),
        ë¹„ê³ : String(get(64) || '').trim(),
      };
      for (let i = 1; i <= 9; i++) mapped['ê°•ì‚¬' + i] = String(get(11 + i) || '').trim();
      TARGET_KEYS.forEach((k, ki) => {
        const v = parseInt(get(22 + ki)) || 0;
        mapped[k] = v || null;
      });
      return mapped;
    }

    function formatDate(v) {
      if (!v) return '';
      if (v instanceof Date) return v.toISOString().substring(0, 10);
      const s = String(v);
      if (s.includes('-') || s.includes('/')) return s.substring(0, 10);
      return s;
    }

    function exportExcel() {
      addLog('ë²„íŠ¼í´ë¦­', 'Excel ë‚´ë³´ë‚´ê¸°', '-');
      if (records.length === 0) { showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

      const wb = XLSX.utils.book_new();

      // â”€â”€ Sheet 1: 2026ë…„ êµìœ¡ì‹¤ì  â”€â”€
      const wsData = [];

      // Row 1: Group codes (empty for now, simplified)
      const row1 = new Array(65).fill('');
      [22, 23, 24, 25, 26].forEach(i => row1[i] = 2);
      [27, 28, 29, 30].forEach(i => row1[i] = 1);
      [31, 32].forEach(i => row1[i] = 3);
      [33, 34, 35, 37, 38].forEach(i => row1[i] = 4);
      [36].forEach(i => row1[i] = 3);
      [39].forEach(i => row1[i] = 6);
      row1.unshift('');
      wsData.push(row1);

      // Row 2: Section labels
      const row2 = new Array(66).fill('');
      row2[0] = 'êµìœ¡êµ¬ë¶„';
      row2[11] = 'ê°•ì‚¬ì •ë³´';
      const subtotalCols = TARGET_KEYS.map((_, ki) => 22 + ki);
      subtotalCols.forEach((ci, ki) => {
        const col = XLSX.utils.encode_col(ci);
        row2[ci] = { f: `SUBTOTAL(9,${col}4:${col}3044)` };
      });
      const lastTargetCol = XLSX.utils.encode_col(22 + TARGET_KEYS.length - 1);
      row2[63] = { f: `SUM(W2:${lastTargetCol}2)` };
      wsData.push(row2);

      // Row 3: Column headers
      const headers3 = [
        'êµìœ¡ëª…', 'êµìœ¡ì¼ ì„ë°• ë¶ˆì°¸ê±´\n(ê°ì )', 'ì˜ì–´êµìœ¡ ê±´\n(ê°€ì )', 'ê¸´ê¸‰ì¶”ì§„ ê±´\n(ê°€ì )', 'êµìœ¡ì¥ì†Œ\n(ìƒì„¸)',
        'êµìœ¡ì¼', 'ì›”', 'ì§€ì—­\n(ê¶Œì—­)', 'ìì›', 'êµìœ¡ìœ í˜•', 'ë‹´ë‹¹ì',
        'ê°•ì‚¬ ìˆ˜\n(ì „ë¬¸ê°•ì‚¬ìˆ˜)', 'ê°•ì‚¬1', 'ê°•ì‚¬2', 'ê°•ì‚¬3', 'ê°•ì‚¬4', 'ê°•ì‚¬5', 'ê°•ì‚¬6', 'ê°•ì‚¬7', 'ê°•ì‚¬8', 'ê°•ì‚¬9',
        'ê¸°ê´€ëª…',
        ...TARGET_LABELS,
        'í•©ê³„', 'ë¹„ê³ '
      ];
      wsData.push(headers3);

      // Data rows
      records.forEach((r, ri) => {
        const rowNum = ri + 4;
        const row = [
          r.êµìœ¡ëª… || '',
          '', '', '',
          r.êµìœ¡ì¥ì†Œ || '',
          r.êµìœ¡ì¼ || '',
          r.êµìœ¡ì¼ ? { f: `MONTH(F${rowNum})` } : '',
          r.ê¶Œì—­ || '',
          r.ìì› || '',
          r.êµìœ¡ìœ í˜• || '',
          r.ë‹´ë‹¹ì || '',
          r.ê°•ì‚¬ìˆ˜ || 0,
          r.ê°•ì‚¬1 || '', r.ê°•ì‚¬2 || '', r.ê°•ì‚¬3 || '', r.ê°•ì‚¬4 || '', r.ê°•ì‚¬5 || '',
          r.ê°•ì‚¬6 || '', r.ê°•ì‚¬7 || '', r.ê°•ì‚¬8 || '', r.ê°•ì‚¬9 || '',
          r.ê¸°ê´€ëª… || '',
          ...TARGET_KEYS.map(k => parseInt(r[k]) || 0),
          { f: `SUBTOTAL(9,W${rowNum}:BK${rowNum})` },
          r.ë¹„ê³  || ''
        ];
        wsData.push(row);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // Merged cells
      if (!ws['!merges']) ws['!merges'] = [];
      ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 5 } }); // A2:F2
      ws['!merges'].push({ s: { r: 1, c: 11 }, e: { r: 1, c: 20 } }); // L2:U2

      // Column widths
      const colWidths = [{ wch: 40 }, { wch: 6 }, { wch: 6 }, { wch: 6 }, { wch: 20 },
      { wch: 12 }, { wch: 4 }, { wch: 8 }, { wch: 6 }, { wch: 10 }, { wch: 8 },
      { wch: 6 }, ...Array(9).fill({ wch: 8 }), { wch: 12 },
      ...Array(41).fill({ wch: 5 }), { wch: 6 }, { wch: 20 }];
      ws['!cols'] = colWidths;

      XLSX.utils.book_append_sheet(wb, ws, '2026ë…„ êµìœ¡ì‹¤ì ');

      // â”€â”€ Sheet 2: BASE â”€â”€
      const baseData = [
        ['ì¬ì›', 'ê¶Œì—­', 'ê¸°ê´€ëª…', 'êµìœ¡ìœ í˜•', 'ê°•ì‚¬ëª…', 'ëŒ€ìƒ', 'ì¢…ëª©ë‹¨ì²´ëª…'],
        ['ê¸°ê¸ˆ', 'ì„œìš¸', 'ëŒ€í•œì²´ìœ¡íšŒ', 'ê°•ì˜í˜•(ëŒ€ë©´)êµìœ¡', 'ê°•ëª…ì‹ ', 'ì´ˆë“±ì„ ìˆ˜', 'Kë¦¬ê·¸'],
        ['ìì²´', 'ë¶€ì‚°', 'íšŒì›ì¢…ëª©ë‹¨ì²´', 'ì˜¨ë¼ì¸ ì‹¤ì‹œê°„', 'ê°•ë¯¼ìš°', 'ì¤‘ë“±ì„ ìˆ˜', 'KBO'],
        ['ê¸°íƒ€', 'ì¸ì²œ', 'ëŒ€í•œì¥ì• ì¸ì²´ìœ¡íšŒ', 'ì²´í—˜í˜•', 'ê°•íš¨ì°¬', 'ê³ ë“±ì„ ìˆ˜', 'KOVO'],
        ['', 'ëŒ€êµ¬', 'ê°€ë§¹ê²½ê¸°ë‹¨ì²´', 'ì•„ì›ƒë¦¬ì¹˜', 'ê³½ìƒìˆ˜', 'ëŒ€í•™ì„ ìˆ˜', 'KBL'],
        ['', 'ëŒ€ì „', 'ì‹œë„ì²´ìœ¡íšŒ', '', 'ê¶Œì§„ìˆ™', 'í´ëŸ½ ì„ ìˆ˜ë°˜', 'WKBL'],
        ['', 'ê´‘ì£¼', 'ì‹œë„ì¥ì• ì¸ì²´ìœ¡íšŒ', '', 'ê¶Œí˜„ì„', 'í•™êµìš´ë™ë¶€ì§€ë„ì', 'KPGA'],
        ['', 'ìš¸ì‚°', 'í”„ë¡œìŠ¤í¬ì¸ ë‹¨ì²´', '', 'ê¸°ë³´ë°°', 'í•™ë¶€ëª¨', 'KLPGA'],
        ['', 'ì„¸ì¢…', 'ì‹œë„êµìœ¡(ì§€ì›)ì²­', '', 'ê¹€ë‚˜ë¼', 'ì§ì¥ìš´ë™ê²½ê¸°ë¶€', ''],
        ['', 'ê²½ê¸°', 'ì²´ìœ¡ì¤‘ê³ ', '', 'ê¹€ë¯¼ì •', 'êµ­ê°€ëŒ€í‘œ', ''],
        ['', 'ê°•ì›', 'í•™êµìš´ë™ë¶€', '', 'ê¹€ë¯¼ì£¼', 'êµ­ê°€ëŒ€í‘œí›„ë³´ì„ ìˆ˜', ''],
        ['', 'ì¶©ë¶', 'ì²´ìœ¡ì§€ë„ì ìê²©ì—°ìˆ˜ê¸°ê´€', '', 'ê¹€ë°˜ì„', 'ì²­ì†Œë…„ëŒ€í‘œ', ''],
        ['', 'ì¶©ë‚¨', 'ê¸°íƒ€', '', 'ê¹€ìƒí›ˆ', 'ê¿ˆë‚˜ë¬´ì„ ìˆ˜', ''],
        ['', 'ì „ë¶', '', '', 'ê¹€ì„í˜„', 'RTPTP', ''],
        ['', 'ì „ë‚¨', '', '', 'ê¹€ì˜ë¯¸', 'ì œì¬í›„ë³µê·€ì„ ìˆ˜', ''],
        ['', 'ê²½ë¶', '', '', 'ê¹€ì¸ìˆ™', 'ì‹¬íŒì§€ë„ìê°•ìŠµíšŒ', ''],
        ['', 'ê²½ë‚¨', '', '', 'ê¹€ì¼ì‚¼', 'ì¥ì• ì„ ìˆ˜', ''],
        ['', 'ì œì£¼', '', '', 'ê¹€ì§€ì˜', 'ì¥ì• ì„ ìˆ˜ì§€ì›ìš”ì›', ''],
        ['', '', '', '', 'ê¹€ì§„í›ˆ', 'í”„ë¡œì„ ìˆ˜', ''],
        ['', '', '', '', 'ê¹€í˜„ì£¼', 'í”„ë¡œì‹ ì¸ì„ ìˆ˜', ''],
        ['', '', '', '', 'ê¹€í¬ì •', 'í”„ë¡œìœ ì†Œë…„ì„ ìˆ˜', ''],
        ['', '', '', '', 'ë‚¨ìƒì„¤', 'ìŠ¤í¬ì¸ ì§€ë„ìì—°ìˆ˜ìƒ', ''],
        ['', '', '', '', 'ë‚¨ì„±ë¯¼', 'ìŠ¤í¬ì¸ í–‰ì •ê°€', ''],
        ['', '', '', '', 'ë‚¨íƒì–¸', 'ê²€ì‚¬ëŒ€ìƒì ì‚¬ì „êµìœ¡', ''],
      ];
      const wsBase = XLSX.utils.aoa_to_sheet(baseData);
      XLSX.utils.book_append_sheet(wb, wsBase, 'BASE');

      const date = new Date().toISOString().substring(0, 10).replace(/-/g, '');
      XLSX.writeFile(wb, `êµìœ¡ì‹¤ì _2026_${date}.xlsx`);
      showToast(`${records.length}ê±´ Excel ë‚´ë³´ë‚´ê¸° ì™„ë£Œ`, 'success');
    }

    // ================================================================
    // BOOKMARKLET
    // ================================================================
    function openBookmarkletModal() {
      addLog('ë²„íŠ¼í´ë¦­', 'eKADA ë¶™ì—¬ë„£ê¸°', '-');
      const code = `javascript:(function(){
var rows=document.querySelectorAll('tr.lecture-user');
var out=[];
rows.forEach(function(tr){
  var id=tr.querySelector('[data-id]');
  if(id)out.push({id:id.getAttribute('data-id'),
    êµìœ¡ëª…:(tr.querySelector('td:nth-child(2)')||{}).innerText||''
  });
});
prompt('edu.kada.or.kr ë ˆì½”ë“œ ëª©ë¡',JSON.stringify(out));
})();`;
      document.getElementById('bookmarkletCode').value = code;
      document.getElementById('bkmModal').classList.add('active');
    }

    function copyBookmarklet() {
      document.getElementById('bookmarkletCode').select();
      document.execCommand('copy');
      showToast('ë³µì‚¬ë¨', 'success');
    }

    function extractArrayFromJson(data) {
      // 1) ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ
      if (Array.isArray(data)) return data;
      // 2) {êµìœ¡ëª©ë¡:[...]} ë˜í¼ êµ¬ì¡° (eKADA ì¶”ì¶œë°ì´í„° í˜•ì‹)
      if (data && Array.isArray(data.êµìœ¡ëª©ë¡)) return data.êµìœ¡ëª©ë¡;
      // 3) ë‹¨ì¼ ê°ì²´ë©´ ë°°ì—´ë¡œ
      return [data];
    }

    function importJsonFile(input) {
      addLog('ë²„íŠ¼í´ë¦­', 'JSON íŒŒì¼ ê°€ì ¸ì˜¤ê¸°', '-');
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = JSON.parse(e.target.result);
          const arr = extractArrayFromJson(data);
          let cnt = 0;
          const toAdd = [];
          arr.forEach(item => {
            if (item.êµìœ¡ëª… || item.name) {
              const r = { êµìœ¡ëª…: item.êµìœ¡ëª… || item.name || '', ...item };
              delete r._id; // ê¸°ì¡´ _id ì œê±° (Firestoreê°€ ìƒˆë¡œ ë¶€ì—¬)
              toAdd.push(r);
              cnt++;
            }
          });
          saveBatchToFirestore(toAdd)
            .then(() => showToast(`${cnt}ê±´ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`, 'success'))
            .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'));
        } catch (err) {
          showToast('JSON íŒŒì‹± ì˜¤ë¥˜: ' + err.message, 'error');
        }
        input.value = '';
      };
      reader.readAsText(file, 'utf-8');
    }

    function importFromJSON() {
      addLog('ë²„íŠ¼í´ë¦­', 'JSON ì§ì ‘ ë¶™ì—¬ë„£ê¸°', '-');
      try {
        const text = document.getElementById('jsonPasteArea').value.trim();
        if (!text) return;
        const data = JSON.parse(text);
        const arr = extractArrayFromJson(data);
        let cnt = 0;
        const toAdd = [];
        arr.forEach(item => {
          if (item.êµìœ¡ëª… || item.name) {
            const r = { êµìœ¡ëª…: item.êµìœ¡ëª… || item.name || '', ...item };
            delete r._id;
            toAdd.push(r);
            cnt++;
          }
        });
        saveBatchToFirestore(toAdd)
          .then(() => {
            closeModal('bkmModal');
            showToast(`${cnt}ê±´ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ`, 'success');
          })
          .catch(e => showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error'));
      } catch (e) {
        showToast('JSON íŒŒì‹± ì˜¤ë¥˜: ' + e.message, 'error');
      }
    }

    // ================================================================
    // TOAST
    // ================================================================
    function showToast(msg, type = '') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = 'toast ' + type;
      const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      t.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // ================================================================
    // FILTER INITIALIZATION
    // ================================================================
    function initFilters() {
      // Initialize month checkboxes
      const monthGroup = document.getElementById('filterMonthGroup');
      for (let i = 1; i <= 12; i++) {
        const div = document.createElement('div');
        div.className = 'filter-check';
        div.innerHTML = `<input type="checkbox" id="filter_m${i}" name="filter_month" value="${i}" onchange="renderTable()">
      <label for="filter_m${i}">${i}ì›”</label>`;
        monthGroup.appendChild(div);
      }

      // Initialize region checkboxes
      const regionGroup = document.getElementById('filterRegionGroup');
      REGIONS.forEach(region => {
        const div = document.createElement('div');
        div.className = 'filter-check';
        const id = 'filter_r_' + region;
        div.innerHTML = `<input type="checkbox" id="${id}" name="filter_region" value="${region}" onchange="renderTable()">
      <label for="${id}">${region}</label>`;
        regionGroup.appendChild(div);
      });

      // Initialize type checkboxes
      const typeGroup = document.getElementById('filterTypeGroup');
      TYPES.forEach(type => {
        const div = document.createElement('div');
        div.className = 'filter-check';
        const id = 'filter_t_' + type.replace(/\s/g, '_');
        div.innerHTML = `<input type="checkbox" id="${id}" name="filter_type" value="${type}" onchange="renderTable()">
      <label for="${id}">${type}</label>`;
        typeGroup.appendChild(div);
      });

      // Initialize jawon checkboxes
      const jawonGroup = document.getElementById('filterJawonGroup');
      JAWONS.forEach(jawon => {
        const div = document.createElement('div');
        div.className = 'filter-check';
        const id = 'filter_j_' + jawon;
        div.innerHTML = `<input type="checkbox" id="${id}" name="filter_jawon" value="${jawon}" onchange="renderTable()">
      <label for="${id}">${jawon}</label>`;
        jawonGroup.appendChild(div);
      });
    }

    // ================================================================
    // LOGS MANAGEMENT
    // ================================================================
    function openLogsModal() {
      addLog('ë²„íŠ¼í´ë¦­', 'ë¡œê·¸ë³´ê¸°', '-');
      const container = document.getElementById('logsContainer');
      // ëª¨ë“  ë¡œê·¸ í‘œì‹œ (ìµœì‹ ìˆœ)
      const allLogs = [...logs].reverse();

      if (allLogs.length === 0) {
        container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">ë¡œê·¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        let html = '<table class="logs-table"><thead><tr><th>ì¼ì‹œ</th><th>ë‚´ìš©/í•­ëª©</th><th>ë¶„ë¥˜/ë™ì‘</th><th>ê°’/ìƒì„¸</th></tr></thead><tbody>';
        allLogs.forEach(log => {
          html += `<tr>
            <td>${log.timestamp}</td>
            <td style="font-weight:700">${log.field || '-'}</td>
            <td style="color:var(--accent)">${log.change || '-'}</td>
            <td style="white-space:pre-wrap">${log.value || '-'}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }
      openModal('logsModal');
    }

    function clearLogsData() {
      if (!confirm('ëª¨ë“  ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      logs = [];
      saveLogs();
      openLogsModal();
      showToast('ë¡œê·¸ ì´ˆê¸°í™”ë¨', 'success');
    }

    // ================================================================
    // GROUPED VIEW
    // ================================================================
    function openGroupedView() {
      const grouped = {};
      const filtered = filteredRecords();

      filtered.forEach(({ r }) => {
        const key = r.ë©”ëª¨_í˜„ì¥ì¸ì› || '[ë¶„ë¥˜ ì—†ìŒ]';
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(r);
      });

      let html = '';
      for (const group in grouped) {
        const groupRecs = grouped[group];
        const groupTotal = groupRecs.reduce((s, r) => s + getTotal(r), 0);
        html += `
      <div class="group-section">
        <div class="group-header" onclick="this.nextElementSibling.classList.toggle('expanded')">
          <span>${group} (${groupRecs.length}ê±´, ${groupTotal}ëª…)</span>
          <span style="font-size:14px">â–¶</span>
        </div>
        <div class="group-content expanded">
          <table class="group-table">
            <thead>
              <tr>
                <th>êµìœ¡ëª…</th>
                <th>êµìœ¡ì¼</th>
                <th>ê¶Œì—­</th>
                <th>ê¸°ê´€ëª…</th>
                <th>í•©ê³„</th>
              </tr>
            </thead>
            <tbody>
              ${groupRecs.map(r => `
                <tr>
                  <td>${r.êµìœ¡ëª… || ''}</td>
                  <td>${r.êµìœ¡ì¼ ? String(r.êµìœ¡ì¼).substring(0, 10) : ''}</td>
                  <td>${r.ê¶Œì—­ || ''}</td>
                  <td>${r.ê¸°ê´€ëª… || ''}</td>
                  <td style="font-weight:600;color:var(--accent)">${getTotal(r)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
      }

      if (!html) html = '<div style="text-align:center;padding:40px;color:var(--muted)">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      document.getElementById('groupedContent').innerHTML = html;
      document.getElementById('groupedModal').classList.add('active');
    }

    // ================================================================
    // PARTICIPANTS LOADING
    // ================================================================
    async function loadParticipants(record) {
      const listEl = document.getElementById('participantsList');
      listEl.innerHTML = '<div style="padding:20px;text-align:center"><div class="loading-spinner"></div> eKADAì—ì„œ ì°¸ì—¬ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      // ë¹„ê³  í•„ë“œì—ì„œ eKADA ID ì¶”ì¶œ ("eKADA ID: 985" í˜•ì‹)
      const idMatch = (record.ë¹„ê³  || '').match(/eKADA ID:\s*(\d+)/);
      if (!idMatch) {
        listEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">eKADA IDê°€ ì—†ìŠµë‹ˆë‹¤. (ë¹„ê³  í•„ë“œ í™•ì¸)</div>';
        return;
      }
      const ekadaId = idMatch[1];

      try {
        const resp = await fetch(`https://edu.kada.or.kr/educations/manager/players/?education=${ekadaId}`, { credentials: 'include' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const html = await resp.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const rows = [...doc.querySelectorAll('tbody tr')];

        if (rows.length === 0) {
          listEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">ì°¸ì—¬ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        const tableRows = rows.map(row => {
          const tds = [...row.querySelectorAll('td')];
          const name = tds[0]?.innerText.trim() || '';
          const userid = tds[1]?.innerText.trim() || '';
          const gender = tds[2]?.innerText.trim() || '';
          const phone = tds[3]?.innerText.trim() || '';
          const email = tds[4]?.innerText.trim() || '';
          const count = tds[5]?.innerText.trim() || '';
          if (!name) return '';
          return `<tr>
        <td style="padding:5px 8px;font-weight:600">${name}</td>
        <td style="padding:5px 8px;color:var(--muted)">${userid}</td>
        <td style="padding:5px 8px;text-align:center">${gender}</td>
        <td style="padding:5px 8px">${phone}</td>
        <td style="padding:5px 8px;color:var(--muted);font-size:10px">${email}</td>
        <td style="padding:5px 8px;text-align:center;color:var(--accent);font-weight:600">${count}íšŒ</td>
      </tr>`;
        }).filter(Boolean).join('');

        listEl.innerHTML = `
      <div style="padding:8px 12px;background:var(--kada-light);font-size:11px;color:var(--muted);border-bottom:1px solid var(--border)">
        ğŸ“‹ eKADA ID: ${ekadaId} / ì´ ${rows.length}ëª…
      </div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="background:#f1f5f9;border-bottom:2px solid var(--border)">
              <th style="padding:6px 8px;text-align:left">ì´ë¦„</th>
              <th style="padding:6px 8px;text-align:left">ì•„ì´ë””</th>
              <th style="padding:6px 8px;text-align:center">ì„±ë³„</th>
              <th style="padding:6px 8px;text-align:left">ì—°ë½ì²˜</th>
              <th style="padding:6px 8px;text-align:left">ì´ë©”ì¼</th>
              <th style="padding:6px 8px;text-align:center">2026êµìœ¡</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>`;
      } catch (e) {
        listEl.innerHTML = `<div style="padding:20px;text-align:center;color:var(--danger)">
      ë¡œë“œ ì‹¤íŒ¨: ${e.message}<br>
      <span style="font-size:10px;color:var(--muted)">edu.kada.or.kr ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
    </div>`;
      }
    }

    // ================================================================
    // PARTICIPANTS VIEW (main table â€“ ëŒ€ìƒë³„ ì˜ˆìƒ ì¸ì› ë¡œì»¬ í‘œì‹œ)
    // ================================================================
    function openParticipantsView(idx) {
      const record = records[idx];
      const eduName = record.êµìœ¡ëª… || '';
      document.getElementById('participantsModalTitle').textContent = 'ğŸ“Š ëŒ€ìƒë³„ ì˜ˆìƒ ì¸ì› â€” ' + eduName;
      document.getElementById('participantsModal').classList.add('active');
      const listEl = document.getElementById('participantsViewList');

      // ê·¸ë£¹ ì •ì˜
      const GROUPS = [
        { label: 'ğŸ† ëŒ€í‘œì„ ìˆ˜', keys: ['êµ­ê°€ëŒ€í‘œ', 'êµ­ê°€ëŒ€í‘œí›„ë³´', 'ì²­ì†Œë…„ëŒ€í‘œ', 'ê¿ˆë‚˜ë¬´ì„ ìˆ˜', 'RTPTP', 'ì œì¬í›„ë³µê·€ì„ ìˆ˜'] },
        { label: 'ğŸ‹ï¸ ì‹¤ì—…Â·ì§ì¥', keys: ['ì§ì¥ìš´ë™ê²½ê¸°ë¶€'] },
        { label: 'â™¿ ì¥ì• ì¸', keys: ['ì¥ì• ì¸êµ­ê°€ëŒ€í‘œ', 'ì¥ì• ì¸ì„ ìˆ˜', 'ì¥ì• ì¸ì„ ìˆ˜ì§€ì›ìš”ì›'] },
        { label: 'ğŸ« í•™êµì²´ìœ¡', keys: ['ì´ˆë“±ì„ ìˆ˜', 'ì¤‘ë“±ì„ ìˆ˜', 'ê³ ë“±ì„ ìˆ˜', 'ì²´ìœ¡ì¤‘', 'ì²´ìœ¡ê³ ', 'í”„ë¡œìœ ìŠ¤', 'ëŒ€í•™ì„ ìˆ˜', 'í´ëŸ½ì„ ìˆ˜ë°˜'] },
        { label: 'ğŸ‘©â€ğŸ« êµìœ¡ê´€ê³„ì', keys: ['êµì‚¬', 'í•™ë¶€ëª¨'] },
        { label: 'âš½ í”„ë¡œìŠ¤í¬ì¸ ', keys: ['í”„ë¡œKBL', 'í”„ë¡œKOVO', 'í”„ë¡œKBO', 'í”„ë¡œWKBL', 'í”„ë¡œKLPGA', 'í”„ë¡œKPGA', 'í”„ë¡œKë¦¬ê·¸', 'ê²½ë¥œê²½ì •'] },
        { label: 'ğŸ“‹ ì§€ë„ì ìê²©', keys: ['1ê¸‰ì „ë¬¸', '2ê¸‰ì „ë¬¸', '1ê¸‰ì¥ì• ', '2ê¸‰ì¥ì• ', '1ê¸‰ìƒí™œ', '2ê¸‰ìƒí™œ', 'ê±´ìš´ì‚¬'] },
        { label: 'ğŸŒ± ê¸°íƒ€', keys: ['ë…¸ì¸', 'ìœ ì†Œë…„', 'í–‰ì •ê°€', 'ì§€ë„ì', 'íŠ¸ë ˆì´ë„ˆ', 'ê¸°íƒ€'] }
      ];

      // KEY â†’ LABEL ë§¤í•‘ (TARGET_LABELS ìˆœì„œì— ë§ê²Œ)
      const KEY_LABEL = {};
      TARGET_KEYS.forEach((k, i) => {
        KEY_LABEL[k] = TARGET_LABELS[i].replace(/\n/g, ' ');
      });

      let totalSum = 0;
      let groupHtml = '';

      GROUPS.forEach(group => {
        const rows = group.keys
          .map(k => ({ key: k, label: KEY_LABEL[k] || k, val: parseInt(record[k]) || 0 }))
          .filter(item => item.val > 0);
        if (rows.length === 0) return;

        const groupSum = rows.reduce((s, r) => s + r.val, 0);
        totalSum += groupSum;

        groupHtml += `
      <div style="margin-bottom:2px">
        <div style="padding:5px 12px;background:#f1f5f9;font-size:11px;font-weight:700;color:var(--kada-blue);
                    border-left:3px solid var(--accent);display:flex;justify-content:space-between;align-items:center">
          <span>${group.label}</span>
          <span style="color:var(--accent)">${groupSum}ëª…</span>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px">
          ${rows.map((item, ri) => `
          <tr style="background:${ri % 2 === 0 ? '#fff' : '#fafafa'}">
            <td style="padding:5px 12px 5px 20px;color:var(--text)">${item.label}</td>
            <td style="padding:5px 12px;text-align:right;font-weight:600;color:var(--accent);width:70px">${item.val}ëª…</td>
          </tr>`).join('')}
        </table>
      </div>`;
      });

      // ê°’ì´ í•˜ë‚˜ë„ ì—†ëŠ” ê²½ìš°
      if (totalSum === 0) {
        listEl.innerHTML = `<div style="padding:30px;text-align:center;color:var(--muted)">
      <div style="font-size:28px;margin-bottom:8px">ğŸ“­</div>
      <div>ì…ë ¥ëœ ëŒ€ìƒë³„ ì¸ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <div style="font-size:11px;margin-top:4px">êµìœ¡ ìˆ˜ì •ì—ì„œ ëŒ€ìƒë³„ ì¸ì›ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
    </div>`;
        return;
      }

      listEl.innerHTML = `
    <div style="padding:8px 12px;background:var(--kada-light);font-size:11px;
                color:var(--muted);border-bottom:1px solid var(--border);
                display:flex;justify-content:space-between;align-items:center">
      <span>ğŸ“Œ <strong style="color:var(--text)">${eduName}</strong></span>
      <span>ì˜ˆìƒ í•©ê³„ <strong style="color:var(--accent);font-size:13px">${totalSum}ëª…</strong></span>
    </div>
    ${groupHtml}
    <div style="padding:8px 12px;background:#f8fafc;border-top:2px solid var(--border);
                display:flex;justify-content:flex-end;align-items:center;font-size:13px;font-weight:700">
      <span style="color:var(--muted);margin-right:8px">ì „ì²´ í•©ê³„</span>
      <span style="color:var(--accent);font-size:15px">${totalSum}ëª…</span>
    </div>`;
    }

    // ================================================================
    // ë¡œì»¬ ë°ì´í„° â†’ Firestore ë§ˆì´ê·¸ë ˆì´ì…˜
    // ================================================================
    function migrateFromLocalStorage() {
      const OLD_KEY = 'kada_edu_2026';
      const OLD_LOG_KEY = 'kada_edu_logs_2026';
      const localData = localStorage.getItem(OLD_KEY);
      if (!localData) {
        showToast('ë¡œì»¬ì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }
      const localRecords = JSON.parse(localData);
      const localLogs = JSON.parse(localStorage.getItem(OLD_LOG_KEY) || '[]');

      if (!confirm(`ë¡œì»¬ ë°ì´í„° ${localRecords.length}ê±´ì„ Firestoreë¡œ ì˜¬ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ Firestore ë°ì´í„°ì— ì¶”ê°€ë©ë‹ˆë‹¤)`)) return;

      // ë°°ì¹˜ë¡œ ë ˆì½”ë“œ 1ê°œ = ë¬¸ì„œ 1ê°œì”© ì €ì¥
      const batch = db.batch();
      localRecords.forEach(rec => {
        const ref = db.collection(FS_COL).doc(); // ìƒˆ ìë™ ID
        const clean = { ...rec };
        delete clean._id; // ê¸°ì¡´ _id ì œê±°
        batch.set(ref, clean);
      });
      batch.commit()
        .then(() => db.collection(FS_LOG).doc('main').set({ logs: localLogs }))
        .then(() => {
          showToast(`âœ… ${localRecords.length}ê±´ Firestore ì—…ë¡œë“œ ì™„ë£Œ!`, 'success');
          document.getElementById('btnMigrate').style.display = 'none';
        })
        .catch(e => showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'));
    }

    function checkMigrateButton() {
      const OLD_KEY = 'kada_edu_2026';
      if (localStorage.getItem(OLD_KEY)) {
        const btn = document.getElementById('btnMigrate');
        if (btn) btn.style.display = 'inline-flex';
      }
    }

    // ================================================================
    // INIT
    // ================================================================
    document.addEventListener('DOMContentLoaded', () => {
      initFilters();
      buildHeader();
      renderTable(); // ì´ˆê¸° ë¹ˆ í…Œì´ë¸” ë¨¼ì € í‘œì‹œ
      initFirestore(); // Firestore ì‹¤ì‹œê°„ ì—°ê²° (ë°ì´í„° ì˜¤ë©´ ìë™ renderTable)
      // checkMigrateButton(); // ë¡œì»¬ ë°ì´í„° ìˆìœ¼ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„íŠ¼ í‘œì‹œ
    });

    // (ì°¸ì—¬ìëª…ë‹¨ íƒ­ ì œê±°ë¡œ modal-tab ì´ë²¤íŠ¸ ë°”ì¸ë”© ë¶ˆí•„ìš”)

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.classList.remove('active');
      });
    });
  </script>
</body>

</html>