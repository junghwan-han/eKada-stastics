<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµìœ¡ì‹¤ì  ê´€ë¦¬ë„êµ¬ 2026 â€” KADA ë„í•‘ë°©ì§€êµìœ¡</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root {
      --kada-blue: #1a4b8c;
      --kada-light: #e8f0fb;
      --accent: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #d1d5db;
      --bg: #f8fafc;
      --surface: #fff;
      --text: #1e293b;
      --muted: #64748b;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
    }

    /* â”€â”€ Navbar â”€â”€ */
    .navbar {
      background: var(--kada-blue);
      color: #fff;
      padding: 0 20px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-brand {
      font-size: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navbar-brand span.badge {
      background: #60a5fa;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-stat {
      font-size: 12px;
      color: #93c5fd;
    }

    /* â”€â”€ Toolbar â”€â”€ */
    .toolbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .toolbar .sep {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-success:hover {
      background: #15803d;
    }

    .btn-outline {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-outline:hover {
      background: var(--kada-light);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .btn-sm {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 4px;
    }

    /* â”€â”€ Filter bar â”€â”€ */
    .filter-bar {
      background: var(--kada-light);
      border-bottom: 1px solid #bfdbfe;
      padding: 8px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* â”€â”€ Filter bar ë“œë¡­ë‹¤ìš´ ë°©ì‹ â”€â”€ */
    .filter-bar {
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 8px 16px;
    }

    .filter-toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-search-wrap {
      display: flex;
      align-items: center;
      gap: 7px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 7px;
      padding: 5px 10px;
      width: 220px;
      transition: border-color .15s, box-shadow .15s;
    }

    .filter-search-wrap:focus-within {
      border-color: var(--accent);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .08);
    }

    .filter-search-wrap input[type="text"] {
      border: none;
      outline: none;
      font-size: 12.5px;
      background: transparent;
      width: 100%;
      color: #1e293b;
    }

    .filter-search-wrap input::placeholder {
      color: #94a3b8;
    }

    .filter-sep {
      width: 1px;
      height: 22px;
      background: #e2e8f0;
      flex-shrink: 0;
    }

    .filter-dropdown-group {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ë“œë¡­ë‹¤ìš´ ì»¨í…Œì´ë„ˆ */
    .fdd {
      position: relative;
    }

    .fdd-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 7px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      font-size: 12px;
      font-weight: 500;
      color: #475569;
      cursor: pointer;
      user-select: none;
      transition: all .12s;
      white-space: nowrap;
    }

    .fdd-btn:hover {
      border-color: #93c5fd;
      background: #eff6ff;
      color: var(--accent);
    }

    .fdd.open .fdd-btn {
      border-color: var(--accent);
      background: #eff6ff;
      color: var(--accent);
      font-weight: 600;
    }

    .fdd-badge {
      display: none;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 9px;
      padding: 1px 6px;
      line-height: 1.4;
    }

    .fdd-badge.active {
      display: inline-block;
    }

    /* ë“œë¡­ë‹¤ìš´ íŒ¨ë„ */
    .fdd-panel {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      z-index: 200;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .1);
      min-width: 220px;
      max-width: 360px;
    }

    .fdd-panel-wide {
      max-width: 480px;
    }

    .fdd.open .fdd-panel {
      display: block;
    }

    .filter-reset-btn {
      font-size: 11px;
      padding: 5px 11px;
      border-radius: 7px;
      border: 1px solid #fca5a5;
      background: #fff5f5;
      color: #ef4444;
      cursor: pointer;
      font-weight: 600;
      transition: all .12s;
      white-space: nowrap;
    }

    .filter-reset-btn:hover {
      background: #fee2e2;
    }

    /* â”€â”€ Stats bar â”€â”€ */
    .stats-bar {
      background: #fff;
      border-bottom: 2px solid var(--border);
      padding: 8px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .stat-label {
      font-size: 10px;
      color: var(--muted);
      font-weight: 600;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--kada-blue);
    }

    /* â”€â”€ Table â”€â”€ */
    .table-wrap {
      overflow-x: auto;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
      position: relative;
    }

    table {
      border-collapse: collapse;
      white-space: nowrap;
    }

    /* ì»¬ëŸ¼ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */
    thead th {
      position: relative;
    }

    .col-resizer {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      cursor: col-resize;
      background: transparent;
      z-index: 5;
    }

    .col-resizer:hover,
    .col-resizer.dragging {
      background: rgba(255, 255, 255, 0.4);
    }

    thead tr {
      background: var(--kada-blue);
      color: #fff;
    }

    thead th {
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      border-right: 1px solid rgba(255, 255, 255, .2);
      position: sticky;
      z-index: 10;
      background: var(--kada-blue);
      /* sticky ì…€ì— ë°˜ë“œì‹œ ì§ì ‘ ë°°ê²½ ì§€ì • */
    }

    /* ì´ê³„ í–‰: ìµœìƒë‹¨ ê³ ì • â€” ë”°ëœ»í•œ amber/teal ê³„ì—´ë¡œ í—¤ë”ì™€ ëª…í™•íˆ êµ¬ë¶„ */
    #tableTotalRow th {
      top: 0;
      z-index: 12;
      background: #0f4c35;
    }

    /* ì»¬ëŸ¼ í—¤ë” í–‰: ì´ê³„ í–‰ ì•„ë˜ ê³ ì • */
    #tableHeader th {
      top: 30px;
      z-index: 10;
      background: #1e3a5f;
    }

    /* ì²« ë²ˆì§¸ ì—´ ì¢Œì¸¡ ê³ ì • */
    #tableTotalRow th:first-child {
      left: 0;
      z-index: 13;
      background: var(--success) !important;
    }

    #tableHeader th:first-child {
      left: 0;
      z-index: 11;
      background: #162f5e;
    }

    thead .th-target {
      background: #1e4a8a;
      font-size: 10px;
      min-width: 50px;
    }

    thead .th-total {
      background: var(--success) !important;
      color: #fff;
      font-weight: 700;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .1s;
    }

    tbody tr:hover {
      background: var(--kada-light);
    }

    tbody td {
      padding: 6px 10px;
      text-align: center;
      border-right: 1px solid #f1f5f9;
    }

    tbody td:first-child {
      position: sticky;
      left: 0;
      background: #f8fafc;
      border-right: 2px solid var(--border);
      z-index: 5;
    }

    tbody tr:hover td:first-child {
      background: var(--kada-light);
    }

    td.name-cell {
      text-align: left;
      max-width: 240px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    td.num-cell {
      color: var(--accent);
      font-weight: 600;
    }

    td.total-cell {
      color: #fff;
      font-weight: 700;
      background: var(--success) !important;
    }

    td.zero {
      color: #cbd5e1;
    }

    #tableTotalRow th {
      background: var(--success) !important;
      color: #fff;
      font-weight: 700;
      font-size: 12px;
      padding: 6px 6px;
      border-bottom: 2px solid #065f46;
      text-align: center;
      white-space: nowrap;
    }

    #tableTotalRow th:first-child {
      color: #fff !important;
    }

    #tableTotalRow th.foot-participant {
      color: #fff;
      font-weight: 700;
      font-size: 13px;
    }

    #tableTotalRow th.foot-target {
      color: #fff;
      font-weight: 700;
    }

    #tableTotalRow th.foot-total {
      background: var(--success) !important;
      color: #fff;
      font-weight: 700;
      font-size: 13px;
    }

    /* â”€â”€ Modal overlay â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .modal-box {
      background: #fff;
      border-radius: 10px;
      width: 100%;
      max-width: 900px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .3);
      overflow: hidden;
    }

    .modal-header {
      background: var(--kada-blue);
      color: #fff;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 15px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
    }

    .modal-body {
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-footer {
      background: #f8fafc;
      padding: 14px 20px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      border-top: 1px solid var(--border);
    }

    /* â”€â”€ Form sections â”€â”€ */
    .form-section {
      margin-bottom: 20px;
    }

    .form-section-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--kada-blue);
      padding: 6px 12px;
      background: var(--kada-light);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      margin-bottom: 12px;
    }

    /* ì ê¸ˆ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .section-locked {
      position: relative;
    }

    .section-locked::after {
      content: 'ğŸ”’ ê°œë°œì ìˆ˜ì • ë²„íŠ¼ìœ¼ë¡œ ì ê¸ˆ í•´ì œ';
      position: absolute;
      inset: 0;
      background: rgba(248, 250, 252, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      border-radius: 6px;
      pointer-events: none;
      border: 2px dashed #cbd5e1;
    }

    .section-locked input,
    .section-locked select,
    .section-locked textarea {
      pointer-events: none;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .form-grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .form-grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .form-group.span-2 {
      grid-column: span 2;
    }

    .form-group.span-3 {
      grid-column: span 3;
    }

    .form-group.span-4 {
      grid-column: span 4;
    }

    .form-group label {
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 5px;
      font-size: 12px;
      font-family: inherit;
      transition: border .15s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, .15);
    }

    .form-group input[type="number"] {
      text-align: right;
    }

    /* Target columns grid */
    .target-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
    }

    .target-group-title {
      grid-column: 1 / -1;
      font-size: 10px;
      font-weight: 700;
      color: #6b7280;
      padding: 4px 0;
      border-bottom: 1px solid #e5e7eb;
      margin-top: 4px;
    }

    .target-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .target-item label {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
    }

    .target-item input {
      padding: 4px 6px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
      font-family: inherit;
    }

    .target-item input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .target-item input.has-value {
      background: #eff6ff;
      border-color: #93c5fd;
      font-weight: 700;
    }

    /* Total auto-display */
    .total-display {
      background: var(--success) !important;
      border: 1px solid var(--success);
      border-radius: 6px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .total-display label {
      font-size: 12px;
      font-weight: 700;
      color: #fff;
    }

    .total-display .total-num {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
    }

    /* Import modal */
    .import-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      color: var(--muted);
      cursor: pointer;
      transition: all .2s;
    }

    .import-area:hover,
    .import-area.dragover {
      border-color: var(--accent);
      background: var(--kada-light);
    }

    .import-area .icon {
      font-size: 36px;
      margin-bottom: 8px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .empty-state h3 {
      font-size: 15px;
      margin-bottom: 6px;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      background: #1e293b;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .3);
      animation: slide-in .2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.success {
      background: #15803d;
    }

    .toast.error {
      background: #dc2626;
    }

    @keyframes slide-in {
      from {
        transform: translateX(100px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 7px;
      height: 7px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Checkbox filter â”€â”€ chip ìŠ¤íƒ€ì¼ */
    .filter-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: center;
    }

    .filter-check {
      position: relative;
    }

    .filter-check input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
      pointer-events: none;
    }

    .filter-check label {
      display: inline-block;
      font-size: 11.5px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      color: #475569;
      cursor: pointer;
      user-select: none;
      transition: all .1s;
      line-height: 1.4;
      white-space: nowrap;
    }

    .filter-check label:hover {
      border-color: #93c5fd;
      color: var(--accent);
      background: #eff6ff;
    }

    .filter-check input[type="checkbox"]:checked+label {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      font-weight: 600;
    }

    /* Modal tabs â”€â”€ */
    .modal-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }

    .modal-tab {
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all .2s;
    }

    .modal-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .modal-tab:hover {
      color: var(--text);
    }

    .modal-tab-content {
      display: none;
    }

    .modal-tab-content.active {
      display: block;
    }

    /* Log modal â”€â”€ */
    .log-item {
      padding: 10px 12px;
      border-bottom: 1px solid #f1f5f9;
      display: grid;
      grid-template-columns: 120px 150px 1fr 140px;
      gap: 12px;
      font-size: 11px;
      align-items: start;
    }

    .log-item:hover {
      background: var(--kada-light);
    }

    .log-id {
      font-weight: 600;
      color: var(--accent);
    }

    .log-field {
      color: var(--muted);
    }

    .log-change {
      word-break: break-all;
    }

    .log-time {
      color: var(--muted);
      text-align: right;
    }

    /* Grouped view â”€â”€ */
    .group-section {
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
    }

    .group-header {
      background: var(--kada-light);
      padding: 10px 14px;
      font-weight: 600;
      color: var(--kada-blue);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .group-header:hover {
      background: #d4e4f7;
    }

    .group-content {
      display: none;
      padding: 0;
    }

    .group-content.expanded {
      display: block;
    }

    .group-table {
      width: 100%;
      border-collapse: collapse;
    }

    .group-table thead th {
      background: #f8fafc;
      padding: 6px 10px;
      font-size: 10px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }

    .group-table tbody td {
      padding: 6px 10px;
      border-bottom: 1px solid #f1f5f9;
      text-align: center;
      font-size: 11px;
    }

    .group-table tbody tr:hover {
      background: var(--kada-light);
    }

    /* Participants list â”€â”€ */
    .participant-item {
      padding: 8px 12px;
      border-bottom: 1px solid #f1f5f9;
      display: grid;
      grid-template-columns: 80px 100px 100px 1fr;
      gap: 12px;
      font-size: 11px;
      align-items: center;
    }

    .participant-item:hover {
      background: var(--kada-light);
    }

    .participant-name {
      font-weight: 600;
    }

    .participant-role {
      color: var(--muted);
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .backup-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      transition: background 0.2s;
    }

    .backup-item:hover {
      background: #f8fafc;
    }

    .backup-item:last-child {
      border-bottom: none;
    }

    .backup-date {
      font-weight: 700;
      font-size: 13px;
      color: var(--text);
    }

    .backup-meta {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .backup-info-box {
      background: #eff6ff;
      padding: 14px;
      border-radius: 8px;
      font-size: 12px;
      color: #1e40af;
      border-left: 4px solid #3b82f6;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .backup-list-container {
      border: 1px solid var(--border);
      border-radius: 6px;
      overflow: hidden;
      background: #fdfdfd;
    }

    /* â”€â”€ Infographic Modal â”€â”€ */
    .infographic-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 4px;
    }

    .infographic-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, .04);
    }

    .infographic-card.full-width {
      grid-column: 1 / -1;
    }

    .infographic-card h3 {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 14px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chart-wrap {
      position: relative;
      width: 100%;
    }

    .chart-wrap canvas {
      width: 100% !important;
    }

    /* Korea map SVG */
    .korea-map-wrap {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .korea-map-wrap svg {
      max-height: 340px;
      width: auto;
    }

    .map-region-label {
      font-size: 9px;
      font-weight: 700;
      fill: #1e293b;
      pointer-events: none;
    }

    .map-region-count {
      font-size: 8px;
      font-weight: 600;
      fill: var(--accent);
      pointer-events: none;
    }

    .map-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      justify-content: center;
    }

    .map-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      color: var(--text);
    }

    .map-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    /* ëŒ€ìƒ ì„ íƒ ì¹© */
    .target-chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 12px;
    }

    .target-chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      color: #475569;
      cursor: pointer;
      user-select: none;
      transition: all .15s;
    }

    .target-chip:hover {
      border-color: #93c5fd;
      background: #eff6ff;
    }

    .target-chip.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      font-weight: 600;
    }

    .target-chip-actions {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }

    .target-chip-actions button {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #fff;
      color: var(--muted);
      cursor: pointer;
    }

    .target-chip-actions button:hover {
      background: var(--kada-light);
      color: var(--accent);
    }

    @media (max-width: 800px) {
      .infographic-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBM0qMUnSO1WbhSRcsfl4vjWKoXN0a8HzU",
      authDomain: "ekada-2026.firebaseapp.com",
      projectId: "ekada-2026",
      storageBucket: "ekada-2026.firebasestorage.app",
      messagingSenderId: "1014383340723",
      appId: "1:1014383340723:web:77b626f4913df72a4294c6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-brand">
      <span>ğŸ“Š</span>
      êµìœ¡ì‹¤ì  ê´€ë¦¬ë„êµ¬
      <span class="badge" id="yearBadge">2026</span>
    </div>
    <div class="navbar-right">
      <span class="nav-stat" id="navStat">ë°ì´í„° ì—†ìŒ</span>
    </div>
  </nav>

  <!-- Toolbar -->
  <div class="toolbar">
    <button class="btn btn-primary" onclick="checkAdminAction(() => openAddModal())">â• ìƒˆ ë ˆì½”ë“œ ì¶”ê°€</button>
    <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none" onchange="importExcel(this)">
    <input type="file" id="importJsonFile" accept=".json" style="display:none" onchange="importJsonFile(this)">
    <button class="btn btn-success" onclick="exportExcel()">â¬‡ï¸ Excel ë‚´ë³´ë‚´ê¸°</button>
    <button class="btn btn-outline" onclick="openInfographicModal()" style="color:#7c3aed;border-color:#7c3aed">ğŸ“Š
      ì¸í¬ê·¸ë˜í”½</button>
    <div class="sep"></div>
    <button class="btn btn-outline" onclick="checkAdminAction(() => openBackupModal())">ğŸ’¾ ë°±ì—…/ë³µêµ¬</button>
    <button class="btn btn-outline" onclick="checkAdminAction(() => openLogsModal())">ğŸ“‹ ë¡œê·¸ë³´ê¸°</button>
    <div class="sep"></div>
    <button class="btn btn-outline" onclick="clearAllData()" style="color:#dc2626">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <div class="filter-toolbar">
      <!-- ê²€ìƒ‰ -->
      <div class="filter-search-wrap">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰..."
          oninput="renderTable(); updateFilterBadges(getSelectedFilters())">
      </div>

      <div class="filter-sep"></div>

      <!-- ë“œë¡­ë‹¤ìš´ í•„í„° ë²„íŠ¼ë“¤ -->
      <div class="filter-dropdown-group">

        <div class="fdd" id="fdd_type">
          <button class="fdd-btn" onclick="toggleFdd('fdd_type')">
            ìœ í˜• <span class="fdd-badge" id="badge_type"></span>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="fdd-panel">
            <div class="filter-checkboxes" id="filterTypeGroup"></div>
          </div>
        </div>

        <div class="fdd" id="fdd_jawon">
          <button class="fdd-btn" onclick="toggleFdd('fdd_jawon')">
            ìì› <span class="fdd-badge" id="badge_jawon"></span>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="fdd-panel">
            <div class="filter-checkboxes" id="filterJawonGroup"></div>
          </div>
        </div>

        <div class="fdd" id="fdd_month">
          <button class="fdd-btn" onclick="toggleFdd('fdd_month')">
            ì›” <span class="fdd-badge" id="badge_month"></span>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="fdd-panel">
            <div class="filter-checkboxes" id="filterMonthGroup"></div>
          </div>
        </div>

        <div class="fdd" id="fdd_region">
          <button class="fdd-btn" onclick="toggleFdd('fdd_region')">
            ê¶Œì—­ <span class="fdd-badge" id="badge_region"></span>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="fdd-panel">
            <div class="filter-checkboxes" id="filterRegionGroup"></div>
          </div>
        </div>

        <div class="fdd" id="fdd_target">
          <button class="fdd-btn" onclick="toggleFdd('fdd_target')">
            ëŒ€ìƒ <span class="fdd-badge" id="badge_target"></span>
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="fdd-panel fdd-panel-wide">
            <div class="filter-checkboxes" id="filterTargetGroup"></div>
          </div>
        </div>

      </div>

      <!-- ì´ˆê¸°í™” -->
      <button class="filter-reset-btn" onclick="resetAllFilters()" id="filterResetBtn" style="display:none">âœ•
        ì´ˆê¸°í™”</button>
    </div>
  </div>

  <!-- Stats bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-label">ì´ êµìœ¡ ê±´ìˆ˜</span>
      <span class="stat-value" id="statCount">0</span>
    </div>
    <div style="width:1px;height:36px;background:var(--border)"></div>
    <div class="stat-item">
      <span class="stat-label">ì°¸ì—¬ì ì´ê³„</span>
      <span class="stat-value" style="color:#2563eb" id="statParticipant">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ê°•ì‚¬ìˆ˜</span>
      <span class="stat-value" style="color:#0891b2" id="statInstructor">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ëŒ€ìƒë³„ í•©ê³„</span>
      <span class="stat-value" style="color:#7c3aed" id="statTargetTotal">0</span>
    </div>
    <div style="width:1px;height:36px;background:var(--border)"></div>
    <div class="stat-item">
      <span class="stat-label">ê¸°ê¸ˆ</span>
      <span class="stat-value" style="color:#15803d" id="statGifund">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ìì²´</span>
      <span class="stat-value" style="color:#7c3aed" id="statJache">0</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">ê¸°íƒ€</span>
      <span class="stat-value" style="color:#d97706" id="statEtc">0</span>
    </div>
    <div style="flex:1"></div>
  </div>

  <!-- Table -->
  <div class="table-wrap">
    <table id="mainTable">
      <thead>
        <tr id="tableTotalRow"></tr>
        <tr id="tableHeader"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="empty-state" id="emptyState" style="display:none">
      <div class="icon">ğŸ“‹</div>
      <h3>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p style="font-size:12px">ìƒˆ ë ˆì½”ë“œë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ Excel íŒŒì¼ì„ ê°€ì ¸ì˜¤ì„¸ìš”.</p>
    </div>
  </div>

  <!-- ===== EDIT MODAL ===== -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-box">
      <div class="modal-header">
        <h2 id="modalTitle">ìƒˆ êµìœ¡ ë ˆì½”ë“œ ì¶”ê°€</h2>
        <button class="modal-close" onclick="closeModal('editModal')">âœ•</button>
      </div>
      <div class="modal-body" id="editModalBody">
        <!-- ê¸°ë³¸ ì •ë³´ íƒ­ -->
        <div id="tab-info" class="modal-tab-content active">

          <!-- ê¸°ë³¸ ì •ë³´ -->
          <div class="form-section" id="section-basic">
            <div class="form-section-title">ğŸ“Œ ê¸°ë³¸ ì •ë³´</div>
            <div class="form-grid form-grid-2" style="margin-bottom:10px">
              <div class="form-group span-2">
                <label>êµìœ¡ëª… *</label>
                <input type="text" id="f_name" placeholder="êµìœ¡ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
              </div>
            </div>
            <div class="form-grid" style="grid-template-columns: repeat(4,1fr)">
              <div class="form-group">
                <label>êµìœ¡ì¼ *</label>
                <input type="date" id="f_date" oninput="autoMonth()">
              </div>
              <div class="form-group">
                <label>ì›” (ìë™)</label>
                <input type="number" id="f_month" placeholder="ìë™" readonly style="background:#f1f5f9">
              </div>
              <div class="form-group">
                <label>ì§€ì—­(ê¶Œì—­) *</label>
                <select id="f_region">
                  <option value="">ì„ íƒ</option>
                  <option>ì„œìš¸</option>
                  <option>ë¶€ì‚°</option>
                  <option>ì¸ì²œ</option>
                  <option>ëŒ€êµ¬</option>
                  <option>ëŒ€ì „</option>
                  <option>ê´‘ì£¼</option>
                  <option>ìš¸ì‚°</option>
                  <option>ì„¸ì¢…</option>
                  <option>ê²½ê¸°</option>
                  <option>ê°•ì›</option>
                  <option>ì¶©ë¶</option>
                  <option>ì¶©ë‚¨</option>
                  <option>ì „ë¶</option>
                  <option>ì „ë‚¨</option>
                  <option>ê²½ë¶</option>
                  <option>ê²½ë‚¨</option>
                  <option>ì œì£¼</option>
                </select>
              </div>
              <div class="form-group">
                <label>êµìœ¡ìœ í˜• *</label>
                <select id="f_type">
                  <option value="">ì„ íƒ</option>
                  <option>ê°•ì˜í˜•(ëŒ€ë©´)êµìœ¡</option>
                  <option>ì˜¨ë¼ì¸ ì‹¤ì‹œê°„</option>
                  <option>ì²´í—˜í˜•</option>
                  <option>ì•„ì›ƒë¦¬ì¹˜</option>
                  <option>FPG</option>
                </select>
              </div>
              <div class="form-group">
                <label>ìì›(ì¬ì›)</label>
                <select id="f_jawon">
                  <option value="">ì„ íƒ</option>
                  <option>ê¸°ê¸ˆ</option>
                  <option>ìì²´</option>
                  <option>ê¸°íƒ€</option>
                </select>
              </div>
              <div class="form-group">
                <label>ë‹´ë‹¹ì</label>
                <input type="text" id="f_manager" placeholder="ë‹´ë‹¹ìëª…">
              </div>
              <div class="form-group">
                <label>ê¸°ê´€ëª…</label>
                <input type="text" id="f_org" list="orgList" placeholder="ê¸°ê´€ëª… ì…ë ¥ ë˜ëŠ” ì„ íƒ">
                <datalist id="orgList">
                  <option>ëŒ€í•œì²´ìœ¡íšŒ</option>
                  <option>íšŒì›ì¢…ëª©ë‹¨ì²´</option>
                  <option>ëŒ€í•œì¥ì• ì¸ì²´ìœ¡íšŒ</option>
                  <option>ê°€ë§¹ê²½ê¸°ë‹¨ì²´</option>
                  <option>ì‹œë„ì²´ìœ¡íšŒ</option>
                  <option>ì‹œë„ì¥ì• ì¸ì²´ìœ¡íšŒ</option>
                  <option>í”„ë¡œìŠ¤í¬ì¸ ë‹¨ì²´</option>
                  <option>ì‹œë„êµìœ¡(ì§€ì›)ì²­</option>
                  <option>ì²´ìœ¡ì¤‘ê³ </option>
                  <option>í•™êµìš´ë™ë¶€</option>
                  <option>ì²´ìœ¡ì§€ë„ì ìê²©ì—°ìˆ˜ê¸°ê´€</option>
                  <option>ê¸°íƒ€</option>
                </datalist>
              </div>
              <div class="form-group span-2" style="grid-column:span 1">
                <label>êµìœ¡ì¥ì†Œ</label>
                <input type="text" id="f_place" placeholder="êµìœ¡ì¥ì†Œ">
              </div>
            </div>
          </div>

          <!-- ê°•ì‚¬ ì •ë³´ -->
          <div class="form-section" id="section-instructor">
            <div class="form-section-title">ğŸ‘¨â€ğŸ« ê°•ì‚¬ ì •ë³´</div>
            <div class="form-grid" style="grid-template-columns: 80px repeat(9,1fr)">
              <div class="form-group">
                <label>ê°•ì‚¬ ìˆ˜</label>
                <input type="number" id="f_instr_cnt" min="0" value="0">
              </div>
              <div class="form-group"><label>ê°•ì‚¬1</label><input type="text" id="f_i1" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬2</label><input type="text" id="f_i2" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬3</label><input type="text" id="f_i3" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬4</label><input type="text" id="f_i4" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬5</label><input type="text" id="f_i5" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬6</label><input type="text" id="f_i6" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬7</label><input type="text" id="f_i7" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬8</label><input type="text" id="f_i8" list="instrList"></div>
              <div class="form-group"><label>ê°•ì‚¬9</label><input type="text" id="f_i9" list="instrList"></div>
            </div>
            <datalist id="instrList">
              <option>ê°•ëª…ì‹ </option>
              <option>ê°•ë¯¼ìš°</option>
              <option>ê°•íš¨ì°¬</option>
              <option>ê³½ìƒìˆ˜</option>
              <option>ê¶Œì§„ìˆ™</option>
              <option>ê¶Œí˜„ì„</option>
              <option>ê¸°ë³´ë°°</option>
              <option>ê¹€ë‚˜ë¼</option>
              <option>ê¹€ë¯¼ì •</option>
              <option>ê¹€ë¯¼ì£¼</option>
              <option>ê¹€ë°˜ì„</option>
              <option>ê¹€ìƒí›ˆ</option>
              <option>ê¹€ì„í˜„</option>
              <option>ê¹€ì˜ë¯¸</option>
              <option>ê¹€ì¸ìˆ™</option>
              <option>ê¹€ì¼ì‚¼</option>
              <option>ê¹€ì§€ì˜</option>
              <option>ê¹€ì§„í›ˆ</option>
              <option>ê¹€í˜„ì£¼</option>
              <option>ê¹€í¬ì •</option>
              <option>ë‚¨ìƒì„¤</option>
              <option>ë‚¨ì„±ë¯¼</option>
              <option>ë‚¨íƒì–¸</option>
              <option>ë¬¸ìì›</option>
              <option>ë¬¸ì •í¬</option>
              <option>ë°•ì„ ê¸°</option>
              <option>ë°•ì†Œì—°</option>
              <option>ë°•ì¢…ëª…</option>
              <option>ë°•íƒœì¤€</option>
              <option>ë°•í¬ì§„</option>
              <option>ë°©ì€ì¤€</option>
              <option>ë°±ìŠ¹ì´</option>
              <option>ì„œì •í™”</option>
              <option>ì†¡ë‚˜ê²½</option>
              <option>ì‹ ìœ¤ì•„</option>
              <option>ì–‘ì˜ì§„</option>
              <option>ì—°ì•„ë¦„</option>
              <option>ì—¼ì§€í˜„</option>
              <option>ì˜¤ì •ê·œ</option>
              <option>ìœ ìœ¤ì§€</option>
              <option>ì´ê·œë…•</option>
              <option>ì´ë™í›ˆ</option>
              <option>ì´ëª…ìˆ˜</option>
              <option>ì´ì€ì˜</option>
              <option>ì´ì¬ìˆ™</option>
              <option>ì„ì±„ë²”</option>
              <option>ì¥ì„ ì›…</option>
              <option>ì „ìœ¤ê±¸</option>
              <option>ì •ì˜í›ˆ</option>
              <option>ì •í¬íƒ</option>
              <option>ì¡°ê²½í¬</option>
              <option>ì£¼ì² ê·œ</option>
              <option>ì§„ì¢…ì˜¤</option>
              <option>ì±„ë´‰êµ°</option>
              <option>ìµœê²½ì›</option>
              <option>ìµœì¤€í˜</option>
              <option>í•œì€ìˆ™</option>
              <option>í—ˆí–¥ìˆ™</option>
              <option>í™ìƒë¯¼</option>
              <option>í™ì„ë§Œ</option>
              <option>í™ì •í˜¸</option>
              <option>í™©ì¸ë¯¸</option>
              <option>ì„œë¯¼ì •</option>
              <option>ì‹ ë¬¸ê·œ</option>
              <option>í™ì„±ì¤€</option>
              <option>ê¹€ë³´ê²½</option>
              <option>í•œì •í™˜</option>
              <option>í™ìœ ì§„</option>
              <option>ë‚˜í•œêµ­</option>
            </datalist>
          </div>

          <!-- í•™ìŠµ ëŒ€ìƒ (41 columns) -->
          <div class="form-section">
            <div class="form-section-title">ğŸ¯ í•™ìŠµ ëŒ€ìƒë³„ ì¸ì›ìˆ˜ <span style="font-weight:400;color:var(--muted)">(í•µì‹¬ ì…ë ¥
                í•­ëª©)</span></div>
            <div class="target-grid" id="targetGrid">
              <!-- ëŒ€í‘œì„ ìˆ˜ -->
              <div class="target-group-title">ğŸ… ëŒ€í‘œì„ ìˆ˜</div>
              <div class="target-item"><label>êµ­ê°€ëŒ€í‘œ</label><input type="number" id="t_êµ­ê°€ëŒ€í‘œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>êµ­ê°€ëŒ€í‘œí›„ë³´</label><input type="number" id="t_êµ­ê°€ëŒ€í‘œí›„ë³´" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì²­ì†Œë…„ëŒ€í‘œ</label><input type="number" id="t_ì²­ì†Œë…„ëŒ€í‘œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê¿ˆë‚˜ë¬´ì„ ìˆ˜</label><input type="number" id="t_ê¿ˆë‚˜ë¬´ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>RTP/TP</label><input type="number" id="t_RTPTP" min="0"
                  oninput="updateTotal()"></div>
              <!-- ì‹¤ì—…/ì¥ì•  -->
              <div class="target-group-title">ğŸ¢ ì‹¤ì—…íŒ€Â·ì¥ì• ì¸</div>
              <div class="target-item"><label>ì œì¬í›„ë³µê·€</label><input type="number" id="t_ì œì¬í›„ë³µê·€ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì§ì¥ìš´ë™ê²½ê¸°ë¶€</label><input type="number" id="t_ì§ì¥ìš´ë™ê²½ê¸°ë¶€" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¥ì• ì¸êµ­ê°€ëŒ€í‘œ</label><input type="number" id="t_ì¥ì• ì¸êµ­ê°€ëŒ€í‘œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¥ì• ì¸ì„ ìˆ˜</label><input type="number" id="t_ì¥ì• ì¸ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¥ì• ì¸ì§€ì›ìš”ì›</label><input type="number" id="t_ì¥ì• ì¸ì„ ìˆ˜ì§€ì›ìš”ì›" min="0"
                  oninput="updateTotal()"></div>
              <!-- í•™êµì²´ìœ¡ -->
              <div class="target-group-title">ğŸ« í•™êµì²´ìœ¡</div>
              <div class="target-item"><label>ì´ˆë“±ì„ ìˆ˜</label><input type="number" id="t_ì´ˆë“±ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì¤‘ë“±ì„ ìˆ˜</label><input type="number" id="t_ì¤‘ë“±ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê³ ë“±ì„ ìˆ˜</label><input type="number" id="t_ê³ ë“±ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì²´ìœ¡ì¤‘</label><input type="number" id="t_ì²´ìœ¡ì¤‘" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì²´ìœ¡ê³ </label><input type="number" id="t_ì²´ìœ¡ê³ " min="0"
                  oninput="updateTotal()"></div>
              <!-- ëŒ€í•™/í´ëŸ½ -->
              <div class="target-group-title">ğŸ“ ëŒ€í•™Â·í´ëŸ½</div>
              <div class="target-item"><label>í”„ë¡œìœ ìŠ¤</label><input type="number" id="t_í”„ë¡œìœ ìŠ¤" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ëŒ€í•™ì„ ìˆ˜</label><input type="number" id="t_ëŒ€í•™ì„ ìˆ˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í´ëŸ½ì„ ìˆ˜ë°˜</label><input type="number" id="t_í´ëŸ½ì„ ìˆ˜ë°˜" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>êµì‚¬</label><input type="number" id="t_êµì‚¬" min="0" oninput="updateTotal()">
              </div>
              <div class="target-item"><label>í•™ë¶€ëª¨</label><input type="number" id="t_í•™ë¶€ëª¨" min="0"
                  oninput="updateTotal()"></div>
              <!-- í”„ë¡œ -->
              <div class="target-group-title">âš½ í”„ë¡œ ìŠ¤í¬ì¸ </div>
              <div class="target-item"><label>í”„ë¡œ(KBL)</label><input type="number" id="t_í”„ë¡œKBL" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KOVO)</label><input type="number" id="t_í”„ë¡œKOVO" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KBO)</label><input type="number" id="t_í”„ë¡œKBO" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(WKBL)</label><input type="number" id="t_í”„ë¡œWKBL" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KLPGA)</label><input type="number" id="t_í”„ë¡œKLPGA" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(KPGA)</label><input type="number" id="t_í”„ë¡œKPGA" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í”„ë¡œ(Kë¦¬ê·¸)</label><input type="number" id="t_í”„ë¡œKë¦¬ê·¸" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê²½ë¥œê²½ì •</label><input type="number" id="t_ê²½ë¥œê²½ì •" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"></div>
              <!-- ì§€ë„ì ìê²© -->
              <div class="target-group-title">ğŸ“œ ì§€ë„ì ìê²©ì—°ìˆ˜</div>
              <div class="target-item"><label>1ê¸‰ì „ë¬¸</label><input type="number" id="t_1ê¸‰ì „ë¬¸" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>2ê¸‰ì „ë¬¸</label><input type="number" id="t_2ê¸‰ì „ë¬¸" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>1ê¸‰ì¥ì• </label><input type="number" id="t_1ê¸‰ì¥ì• " min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>2ê¸‰ì¥ì• </label><input type="number" id="t_2ê¸‰ì¥ì• " min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>1ê¸‰ìƒí™œ</label><input type="number" id="t_1ê¸‰ìƒí™œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>2ê¸‰ìƒí™œ</label><input type="number" id="t_2ê¸‰ìƒí™œ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê±´ìš´ì‚¬</label><input type="number" id="t_ê±´ìš´ì‚¬" min="0"
                  oninput="updateTotal()"></div>
              <!-- ê¸°íƒ€ -->
              <div class="target-group-title">ğŸ‘¥ ê¸°íƒ€</div>
              <div class="target-item"><label>ë…¸ì¸</label><input type="number" id="t_ë…¸ì¸" min="0" oninput="updateTotal()">
              </div>
              <div class="target-item"><label>ìœ ì†Œë…„</label><input type="number" id="t_ìœ ì†Œë…„" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>í–‰ì •ê°€</label><input type="number" id="t_í–‰ì •ê°€" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ì§€ë„ì</label><input type="number" id="t_ì§€ë„ì" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>íŠ¸ë ˆì´ë„ˆ</label><input type="number" id="t_íŠ¸ë ˆì´ë„ˆ" min="0"
                  oninput="updateTotal()"></div>
              <div class="target-item"><label>ê¸°íƒ€</label><input type="number" id="t_ê¸°íƒ€" min="0" oninput="updateTotal()">
              </div>
            </div>
            <div class="total-display">
              <label>í•©ê³„ (ìë™ ê³„ì‚°)</label>
              <span class="total-num" id="totalDisplay">0 ëª…</span>
            </div>
            <!-- ì›ë³¸ ë©”ëª¨ í•„ë“œ -->
            <div class="form-group" style="margin-top:10px">
              <label>ğŸ“ í˜„ì¥ í•™ìŠµì ì¸ì› ë©”ëª¨ (ì‚¬ì´íŠ¸ ì›ë¬¸)</label>
              <textarea id="f_memo_target" rows="2"
                placeholder="edu.kada.or.kr ì›ë¬¸ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸° (ì˜ˆ: ë³¼ë§ í•™ìƒì„ ìˆ˜ 88ëª…(í•™ìƒì„ ìˆ˜74ëª…/ì§€ë„ì14ëª…))"></textarea>
            </div>
          </div>

          <!-- ê¸°íƒ€ -->
          <div class="form-section">
            <div class="form-section-title">ğŸ“ ê¸°íƒ€</div>
            <div class="form-grid form-grid-2">
              <div class="form-group span-2">
                <label>ë¹„ê³ </label>
                <textarea id="f_note" rows="2" placeholder="ë¹„ê³ "></textarea>
              </div>
            </div>
          </div>

        </div><!-- End tab-info -->

      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="btnDevUnlock" onclick="devUnlock()"
          style="display:none;color:#7c3aed;border-color:#7c3aed">ğŸ”“ ê°œë°œì ìˆ˜ì •</button>
        <!-- ì‹ ê·œ ì¶”ê°€ ì‹œì—ë§Œ í‘œì‹œë˜ëŠ” ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ -->
        <div id="importBtnsInModal" style="display:none; display:flex; gap:6px;">
          <button class="btn btn-outline" style="font-size:12px;"
            onclick="document.getElementById('importFile').click()">ğŸ“‚ Excel ê°€ì ¸ì˜¤ê¸°</button>
          <button class="btn btn-outline" style="font-size:12px;"
            onclick="document.getElementById('importJsonFile').click()">ğŸ“¥ JSON ê°€ì ¸ì˜¤ê¸°</button>
        </div>
        <div style="flex:1"></div>
        <button class="btn btn-outline" onclick="closeModal('editModal')">ì·¨ì†Œ</button>
        <button class="btn btn-primary" id="btnSaveRecord" onclick="saveRecord()">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>


  <!-- ===== LOGS MODAL ===== -->
  <div class="modal-overlay" id="logsModal">
    <div class="modal-box" style="max-width:1100px">
      <div class="modal-header">
        <h2>ğŸ“‹ ìˆ˜ì • ë¡œê·¸ íˆìŠ¤í† ë¦¬</h2>
        <button class="modal-close" onclick="closeModal('logsModal')">âœ•</button>
      </div>
      <!-- ë¡œê·¸ ê²€ìƒ‰ & í•„í„° ë°” -->
      <div
        style="padding:12px 16px; border-bottom:1px solid #e5e7eb; background:#f9fafb; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input type="text" id="logSearchInput" placeholder="ğŸ” ë¡œê·¸ ê²€ìƒ‰ (êµìœ¡ëª…, í•­ëª©, ë‚´ìš©...)" oninput="renderLogs()"
          style="flex:1; min-width:200px; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
        <select id="logTypeFilter" onchange="renderLogs()"
          style="padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; background:white;">
          <option value="">ì „ì²´ ìœ í˜•</option>
          <option value="ìˆ˜ì •">âœï¸ ìˆ˜ì •</option>
          <option value="ì‹ ê·œì¶”ê°€">â• ì‹ ê·œì¶”ê°€</option>
          <option value="ì‚­ì œ">ğŸ—‘ï¸ ì‚­ì œ</option>
          <option value="ê²€ìƒ‰">ğŸ” ê²€ìƒ‰</option>
          <option value="ë³´ì•ˆ">ğŸ” ë³´ì•ˆ</option>
          <option value="ë°±ì—…">ğŸ’¾ ë°±ì—…</option>
          <option value="ë³µêµ¬">ğŸ”„ ë³µêµ¬</option>
          <option value="ë²„íŠ¼í´ë¦­">ğŸ‘† ê¸°íƒ€</option>
        </select>
        <span id="logCount" style="font-size:12px; color:var(--muted); white-space:nowrap;"></span>
        <button onclick="renderLogs()" class="btn btn-outline" style="padding:5px 12px; font-size:12px;">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div class="modal-body" style="padding:0">
        <div id="logsContainer" style="max-height:560px;overflow-y:auto">
          <div style="padding:40px;text-align:center;color:var(--muted)">ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="checkAdminAction(() => clearLogsData())" style="color:#dc2626">ğŸ—‘ï¸ ë¡œê·¸
          ì´ˆê¸°í™”</button>
        <button class="btn btn-outline" onclick="closeModal('logsModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ===== BACKUP MODAL ===== -->
  <div class="modal-overlay" id="backupModal">
    <div class="modal-box" style="max-width:650px">
      <div class="modal-header">
        <h2>ğŸ’¾ ë°ì´í„° ë°±ì—… ë° ë³µêµ¬ ê´€ë¦¬</h2>
        <button class="modal-close" onclick="closeModal('backupModal')">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="backup-info-box" id="lastBackupStatus">
          ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒíƒœë¥¼ í™•ì¸ ì¤‘...
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
          <button class="btn btn-primary" onclick="performManualBackup()" style="justify-content:center">â• ì§€ê¸ˆ ìƒˆ ë°±ì—…
            ìƒì„±</button>
          <button class="btn btn-outline" onclick="downloadCurrentData()" style="justify-content:center">ğŸ“¥ JSON
            ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:flex-end">
          <span style="font-weight:700; font-size:14px">ğŸ“ ì €ì¥ëœ ë°±ì—… ëª©ë¡ (ìµœê·¼ 15ê°œ)</span>
          <span style="font-size:11px; color:var(--muted)">2ì£¼ë§ˆë‹¤ ìë™ ë°±ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.</span>
        </div>

        <div class="backup-list-container">
          <div id="backupList" style="max-height:350px; overflow-y:auto">
            <div style="padding:40px; text-align:center; color:var(--muted)">ë°±ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="checkAdminAction(() => openLogsModal())">ğŸ“‹ ë¡œê·¸ ì´ë ¥ë³´ê¸°</button>
        <div style="flex:1"></div>
        <button class="btn btn-outline" onclick="closeModal('backupModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>


  <!-- ===== INFOGRAPHIC MODAL ===== -->
  <div class="modal-overlay" id="infographicModal">
    <div class="modal-box" style="max-width:1200px">
      <div class="modal-header" style="background:linear-gradient(135deg,#4f46e5,#7c3aed)">
        <h2>ğŸ“Š êµìœ¡ ì‹¤ì  ì¸í¬ê·¸ë˜í”½</h2>
        <button class="modal-close" onclick="closeModal('infographicModal')">âœ•</button>
      </div>
      <div class="modal-body" style="background:#f8fafc">
        <div class="infographic-grid">

          <!-- 1. ì›”ë³„ êµìœ¡ ì‹¤ì  -->
          <div class="infographic-card">
            <h3>ğŸ“… ì›”ë³„ êµìœ¡ ì‹¤ì </h3>
            <div class="chart-wrap"><canvas id="chartMonthly"></canvas></div>
          </div>

          <!-- 2. ê¶Œì—­ë³„ êµìœ¡ ì‹¤ì  (í•œêµ­ ì§€ë„) -->
          <div class="infographic-card">
            <h3>ğŸ—ºï¸ ê¶Œì—­ë³„ êµìœ¡ ì‹¤ì </h3>
            <div id="koreaMapContainer"></div>
          </div>

          <!-- 3. ìœ í˜•ë³„ êµìœ¡ ì‹¤ì  (ë„ë„›) -->
          <div class="infographic-card">
            <h3>ğŸ¯ ìœ í˜•ë³„ êµìœ¡ ì‹¤ì </h3>
            <div class="chart-wrap" style="max-width:320px;margin:0 auto"><canvas id="chartType"></canvas></div>
          </div>

          <!-- 4. ê°•ì‚¬ë³„ êµìœ¡ ì‹¤ì  -->
          <div class="infographic-card">
            <h3>ğŸ‘¨â€ğŸ« ê°•ì‚¬ë³„ êµìœ¡ ì‹¤ì </h3>
            <div class="chart-wrap"><canvas id="chartInstructor"></canvas></div>
          </div>

          <!-- 5. ê¸°ê´€ë³„ êµìœ¡ ì‹¤ì  (ê°€ë¡œ ë§‰ëŒ€) -->
          <div class="infographic-card full-width">
            <h3>ğŸ¢ ê¸°ê´€ë³„ êµìœ¡ ì‹¤ì </h3>
            <div class="chart-wrap"><canvas id="chartOrg"></canvas></div>
          </div>

          <!-- 6. ëŒ€ìƒë³„ êµìœ¡ ì‹¤ì  (ë‹¤ì¤‘ ì„ íƒ) -->
          <div class="infographic-card full-width">
            <h3>ğŸ¯ ëŒ€ìƒë³„ êµìœ¡ ì‹¤ì </h3>
            <div class="target-chip-actions">
              <button onclick="selectAllTargetChips()">ì „ì²´ ì„ íƒ</button>
              <button onclick="deselectAllTargetChips()">ì „ì²´ í•´ì œ</button>
            </div>
            <div class="target-chip-group" id="targetChipGroup"></div>
            <div class="chart-wrap"><canvas id="chartTarget"></canvas></div>
          </div>

        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('infographicModal')">ë‹«ê¸°</button>
      </div>
    </div>
  </div>


  <!-- Toast container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ================================================================
    // DATA MODEL
    // ================================================================
    const STORAGE_KEY = 'kada_edu_2026';
    const LOGS_KEY = 'kada_edu_logs_2026';
    let currentSort = { key: 'êµìœ¡ì¼', dir: 'desc' };

    function setSortKey(key) {
      if (currentSort.key === key) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = key;
        currentSort.dir = 'desc';
      }
      saveColWidths();
      buildHeader();
      restoreColWidths();
      renderTable();
    }

    function saveColWidths() {
      savedColWidths = Array.from(document.querySelectorAll('#tableHeader th')).map(th => th.style.width || '');
    }

    function restoreColWidths() {
      if (!savedColWidths.length) return;
      requestAnimationFrame(() => {
        document.querySelectorAll('#tableHeader th').forEach((th, i) => {
          if (savedColWidths[i]) {
            th.style.width = savedColWidths[i];
            th.style.minWidth = savedColWidths[i];
          }
        });
      });
    }
    const MONTHS = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
    const REGIONS = ['ì„œìš¸', 'ë¶€ì‚°', 'ì¸ì²œ', 'ëŒ€êµ¬', 'ëŒ€ì „', 'ê´‘ì£¼', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ê²½ê¸°', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼'];
    const TYPES = ['ê°•ì˜í˜•(ëŒ€ë©´)êµìœ¡', 'ì˜¨ë¼ì¸ ì‹¤ì‹œê°„', 'ì²´í—˜í˜•', 'ì•„ì›ƒë¦¬ì¹˜', 'FPG'];
    const JAWONS = ['ê¸°ê¸ˆ', 'ìì²´', 'ê¸°íƒ€'];
    const TARGET_KEYS = [
      'êµ­ê°€ëŒ€í‘œ', 'êµ­ê°€ëŒ€í‘œí›„ë³´', 'ì²­ì†Œë…„ëŒ€í‘œ', 'ê¿ˆë‚˜ë¬´ì„ ìˆ˜', 'RTPTP',
      'ì œì¬í›„ë³µê·€ì„ ìˆ˜', 'ì§ì¥ìš´ë™ê²½ê¸°ë¶€', 'ì¥ì• ì¸êµ­ê°€ëŒ€í‘œ', 'ì¥ì• ì¸ì„ ìˆ˜', 'ì¥ì• ì¸ì„ ìˆ˜ì§€ì›ìš”ì›',
      'ì´ˆë“±ì„ ìˆ˜', 'ì¤‘ë“±ì„ ìˆ˜', 'ê³ ë“±ì„ ìˆ˜', 'ì²´ìœ¡ì¤‘', 'ì²´ìœ¡ê³ ',
      'í”„ë¡œìœ ìŠ¤', 'ëŒ€í•™ì„ ìˆ˜', 'í´ëŸ½ì„ ìˆ˜ë°˜', 'êµì‚¬', 'í•™ë¶€ëª¨',
      'í”„ë¡œKBL', 'í”„ë¡œKOVO', 'í”„ë¡œKBO', 'í”„ë¡œWKBL', 'í”„ë¡œKLPGA', 'í”„ë¡œKPGA', 'í”„ë¡œKë¦¬ê·¸', 'ê²½ë¥œê²½ì •',
      '1ê¸‰ì „ë¬¸', '2ê¸‰ì „ë¬¸', '1ê¸‰ì¥ì• ', '2ê¸‰ì¥ì• ', '1ê¸‰ìƒí™œ', '2ê¸‰ìƒí™œ', 'ê±´ìš´ì‚¬',
      'ë…¸ì¸', 'ìœ ì†Œë…„', 'í–‰ì •ê°€', 'ì§€ë„ì', 'íŠ¸ë ˆì´ë„ˆ', 'ê¸°íƒ€'
    ];
    // Excel column headers (Row 3)
    const TARGET_LABELS = [
      'êµ­ê°€ëŒ€í‘œ', 'êµ­ê°€ëŒ€í‘œ\ní›„ë³´', 'ì²­ì†Œë…„ëŒ€í‘œ', 'ê¿ˆë‚˜ë¬´ì„ ìˆ˜', 'RTP/TP',
      'ì œì¬ í›„ \në³µê·€ì„ ìˆ˜', 'ì§ì¥ìš´ë™\nê²½ê¸°ë¶€', 'ì¥ì• ì¸\nêµ­ê°€ëŒ€í‘œ', 'ì¥ì• ì¸\nì„ ìˆ˜', 'ì¥ì• ì¸\nì„ ìˆ˜ì§€ì›ìš”ì›',
      'ì´ˆë“±ì„ ìˆ˜', 'ì¤‘ë“±ì„ ìˆ˜', 'ê³ ë“±ì„ ìˆ˜', 'ì²´ìœ¡ì¤‘', 'ì²´ìœ¡ê³ ',
      'í”„ë¡œìœ ìŠ¤ ', 'ëŒ€í•™ì„ ìˆ˜', 'í´ëŸ½ ì„ ìˆ˜ë°˜', 'êµì‚¬', 'í•™ë¶€ëª¨',
      'í”„ë¡œ\n(KBL)', 'í”„ë¡œ\n(KOVO)', 'í”„ë¡œ\n(KBO)', 'í”„ë¡œ\n(WKBL)', 'í”„ë¡œ\n(KLPGA)', 'í”„ë¡œ\n(KPGA)', 'í”„ë¡œ\n(Kë¦¬ê·¸)', 'ê²½ë¥œ ê²½ì •',
      '1ê¸‰ ì „ë¬¸', '2ê¸‰ ì „ë¬¸', '1ê¸‰ ì¥ì• ', '2ê¸‰ ì¥ì• ', '1ê¸‰ ìƒí™œ', '2ê¸‰ ìƒí™œ', 'ê±´ìš´ì‚¬',
      'ë…¸ì¸', 'ìœ ì†Œë…„', 'í–‰ì •ê°€', 'ì§€ë„ì', 'íŠ¸ë ˆì´ë„ˆ', 'ê¸°íƒ€'
    ];

    let records = [];
    let editingId = null; // ìˆ˜ì • ì¤‘ì¸ ë ˆì½”ë“œì˜ Firestore document ID
    let logs = [];
    let savedColWidths = []; // ì‚¬ìš©ìê°€ ì¡°ì ˆí•œ ì»¬ëŸ¼ ë„ˆë¹„ ì €ì¥

    // â”€â”€ Firestore ì—°ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FS_COL = 'ekada2026';       // êµìœ¡ ë ˆì½”ë“œ ì»¬ë ‰ì…˜
    const FS_LOG_DOC = 'logs';        // ë¡œê·¸ ë¬¸ì„œëª…
    const FS_META_DOC = 'metadata';   // ì„¤ì • ë° ìƒíƒœ ë©”íƒ€ë°ì´í„°
    const FS_BACKUP_COL = 'backups';  // ë°±ì—… ì•„ì¹´ì´ë¸Œ ì»¬ë ‰ì…˜

    // saveDataëŠ” ë” ì´ìƒ ì „ì²´ ë°°ì—´ì„ ì €ì¥í•˜ì§€ ì•ŠìŒ (ê°œë³„ ì €ì¥ ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
    // í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ë‚¨ê²¨ë‘  (import í•¨ìˆ˜ì—ì„œ ë°°ì¹˜ ì €ì¥ í›„ ë¶ˆí•„ìš”)
    function saveData() { /* no-op: ê°œë³„ Firestore ì €ì¥ ë°©ì‹ ì‚¬ìš© */ }

    function saveLogs() {
      // ì‚¬ìš©ì ìš”ì²­ ì£¼ì†Œì¸ ekada2026/logs ì— ì €ì¥ë˜ë„ë¡ ì„¤ì •
      db.collection(FS_COL).doc(FS_LOG_DOC).set({ logs: logs })
        .catch(e => console.error('saveLogs ì˜¤ë¥˜:', e));
    }

    // ì—¬ëŸ¬ ë ˆì½”ë“œ í•œë²ˆì— Firestoreì— ì¶”ê°€ (import ìš©)
    function saveBatchToFirestore(newRecords) {
      const batch = db.batch();
      newRecords.forEach(rec => {
        const ref = db.collection(FS_COL).doc(); // ìë™ ID
        batch.set(ref, rec);
      });
      return batch.commit();
    }

    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ: ì»¬ë ‰ì…˜ ì „ì²´ êµ¬ë… â†’ ëˆ„ê°€ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œí•´ë„ ëª¨ë‘ ìë™ ë°˜ì˜
    function initFirestore() {
      // 1. ë¡œê·¸ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (history í•„ë“œì™€ logs í•„ë“œ ì–‘ë°©í–¥ ì§€ì›)
      db.collection(FS_COL).doc(FS_LOG_DOC).onSnapshot(doc => {
        if (doc.exists) {
          const data = doc.data();
          logs = data.logs || data.history || [];
          // ë¡œê·¸ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ìë™ ê°±ì‹ 
          if (document.getElementById('logsModal').classList.contains('active')) {
            renderLogs();
          }
        } else {
          logs = [];
        }
      }, err => console.error('ë¡œê·¸ êµ¬ë… ì˜¤ë¥˜:', err));

      // 2. ìë™ ë°±ì—… ì²´í¬ (2ì£¼ ì£¼ê¸°)
      checkAutoBackup();

      // 3. êµìœ¡ ë°ì´í„° ì‹¤ì‹œê°„ êµ¬ë…
      db.collection(FS_COL).onSnapshot(snap => {
        let allRecords = [];
        snap.docs.forEach(doc => {
          if (doc.id === FS_LOG_DOC || doc.id === FS_META_DOC) return;

          const data = doc.data();
          let rawList = [];
          if (data.records && Array.isArray(data.records)) {
            rawList = data.records.map((r, i) => ({ _id: doc.id + '_' + i, ...r }));
          } else {
            rawList = [{ _id: doc.id, ...data }];
          }

          // ë°ì´í„° ì •ê·œí™” (ë³´ì •)
          rawList.forEach(r => {
            // 1. ì›”(Month) ë³´ì •: ì›” í•„ë“œê°€ ì—†ìœ¼ë©´ êµìœ¡ì¼ì—ì„œ ì¶”ì¶œ
            if (!r.ì›” && r.êµìœ¡ì¼) {
              const d = new Date(r.êµìœ¡ì¼);
              if (!isNaN(d.getTime())) r.ì›” = d.getMonth() + 1;
            }
            // 2. ê°•ì‚¬ ë³´ì •: 'ê°•ì‚¬' í•„ë“œë§Œ ìˆê³  'ê°•ì‚¬1'ì´ ì—†ìœ¼ë©´ ë³µì‚¬
            if (r.ê°•ì‚¬ && !r.ê°•ì‚¬1) r.ê°•ì‚¬1 = r.ê°•ì‚¬;
            // 3. ìœ í˜• ë³´ì •: 'ìœ í˜•'ê³¼ 'êµìœ¡ìœ í˜•' í˜¼ìš© ëŒ€ì‘
            if (r.ìœ í˜• && !r.êµìœ¡ìœ í˜•) r.êµìœ¡ìœ í˜• = r.ìœ í˜•;
            if (r.êµìœ¡ìœ í˜• && !r.ìœ í˜•) r.ìœ í˜• = r.êµìœ¡ìœ í˜•;

            allRecords.push(r);
          });
        });

        records = allRecords;
        renderTable();
      }, err => {
        console.error('Firestore ì˜¤ë¥˜:', err);
        showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error');
      });
    }
    function addLog(field, change, value, result) {
      if (!Array.isArray(logs)) logs = [];
      const now = new Date();
      let ts;
      try {
        ts = firebase.firestore.Timestamp.fromDate(now);
      } catch (e) {
        ts = now; // Fallback to Date if Firestore not ready
      }

      logs.push({
        timestamp: ts,
        field: field,
        change: change,
        value: value,
        result: result || ''  // ì•¡ì…˜ ê²°ê³¼: 'âœ… ì €ì¥ ì™„ë£Œ', 'âŒ ì‹¤íŒ¨' ë“±
      });
      // ìµœëŒ€ 500ê°œ ìœ ì§€
      if (logs.length > 500) logs.splice(0, logs.length - 500);
      saveLogs();
    }

    // ================================================================
    // TABLE RENDERING
    // ================================================================
    function buildHeader() {
      const tr = document.getElementById('tableHeader');
      const targetShort = ['êµ­ëŒ€', 'êµ­í›„', 'ì²­ì†Œë…„', 'ê¿ˆë‚˜ë¬´', 'RTP', 'ì œì¬ë³µ', 'ì§ì¥', 'ì¥êµ­', 'ì¥ì„ ', 'ì¥ì§€',
        'ì´ˆë“±', 'ì¤‘ë“±', 'ê³ ë“±', 'ì²´ì¤‘', 'ì²´ê³ ', 'ìœ ìŠ¤', 'ëŒ€í•™', 'í´ëŸ½', 'êµì‚¬', 'í•™ë¶€ëª¨',
        'KBL', 'KOVO', 'KBO', 'WKBL', 'KLPGA', 'KPGA', 'Kë¦¬ê·¸', 'ê²½ë¥œ',
        '1ì „', '2ì „', '1ì¥', '2ì¥', '1ìƒ', '2ìƒ', 'ê±´ìš´', 'ë…¸ì¸', 'ìœ ì†Œ', 'í–‰ì •', 'ì§€ë„', 'íŠ¸ë ˆ', 'ê¸°íƒ€'];

      function sortTh(label, key) {
        const active = currentSort.key === key;
        const icon = active ? (currentSort.dir === 'asc' ? 'â–²' : 'â–¼') : 'â‡…';
        const style = active ? 'cursor:pointer;background:#0f3470;white-space:nowrap' : 'cursor:pointer;white-space:nowrap';
        return `<th style="${style}" onclick="setSortKey('${key}')">${label} <span style="font-size:9px;opacity:.85">${icon}</span></th>`;
      }

      let html = '<th>No</th>'
        + sortTh('êµìœ¡ëª…', 'êµìœ¡ëª…')
        + sortTh('êµìœ¡ì¼', 'êµìœ¡ì¼')
        + '<th>ê¶Œì—­</th><th>ìì›</th><th>ìœ í˜•</th><th>ë‹´ë‹¹ì</th><th>ê°•ì‚¬</th><th>ê¸°ê´€ëª…</th><th>ì°¸ì—¬ì</th>';
      html += targetShort.map(c => `<th class="th-target">${c}</th>`).join('');
      html += '<th class="th-total">í•©ê³„</th><th>ì‘ì—…</th>';
      tr.innerHTML = html;
      // ê° thì— ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì‚½ì…
      tr.querySelectorAll('th').forEach(th => {
        const handle = document.createElement('div');
        handle.className = 'col-resizer';
        th.appendChild(handle);
        initColResize(th, handle);
      });
    }

    function initColResize(th, handle) {
      let startX, startW, didDrag = false;

      handle.addEventListener('mousedown', e => {
        e.preventDefault();
        e.stopPropagation();
        didDrag = false;
        startX = e.pageX;

        // ë“œë˜ê·¸ ì‹œì‘ ì „ ëª¨ë“  ì»¬ëŸ¼ ë„ˆë¹„ë¥¼ í˜„ì¬ í”½ì…€ê°’ìœ¼ë¡œ ê³ ì • â†’ ë¦¬í”Œë¡œìš° ë°©ì§€
        const allThs = document.querySelectorAll('#tableHeader th');
        allThs.forEach(t => {
          const w = t.getBoundingClientRect().width;
          t.style.width = w + 'px';
          t.style.minWidth = w + 'px';
        });
        startW = th.getBoundingClientRect().width;

        handle.classList.add('dragging');

        const onMove = ev => {
          didDrag = true;
          const w = Math.max(30, startW + ev.pageX - startX);
          th.style.width = w + 'px';
          th.style.minWidth = w + 'px';
        };

        const onUp = () => {
          handle.classList.remove('dragging');
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });

      // ë“œë˜ê·¸ í›„ click(ì •ë ¬) ë°œë™ ì°¨ë‹¨
      handle.addEventListener('click', e => {
        e.stopPropagation();
        e.preventDefault();
      });
    }

    function getTotal(r) {
      return TARGET_KEYS.reduce((s, k) => s + (parseInt(r[k]) || 0), 0);
    }

    function getSelectedFilters() {
      const months = Array.from(document.querySelectorAll('[name="filter_month"]:checked')).map(c => c.value);
      const regions = Array.from(document.querySelectorAll('[name="filter_region"]:checked')).map(c => c.value);
      const types = Array.from(document.querySelectorAll('[name="filter_type"]:checked')).map(c => c.value);
      const jawons = Array.from(document.querySelectorAll('[name="filter_jawon"]:checked')).map(c => c.value);
      const targets = Array.from(document.querySelectorAll('[name="filter_target"]:checked')).map(c => c.value);
      updateFilterBadges({ months, regions, types, jawons, targets });
      return { months, regions, types, jawons, targets };
    }

    function updateFilterBadges(f) {
      const pairs = [
        ['badge_month', f.months],
        ['badge_region', f.regions],
        ['badge_type', f.types],
        ['badge_jawon', f.jawons],
        ['badge_target', f.targets],
      ];
      let anyActive = document.getElementById('searchInput').value.trim().length > 0;
      pairs.forEach(([id, arr]) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (arr.length > 0) {
          el.textContent = arr.length;
          el.classList.add('active');
          anyActive = true;
        } else {
          el.textContent = '';
          el.classList.remove('active');
        }
      });
      const resetBtn = document.getElementById('filterResetBtn');
      if (resetBtn) resetBtn.style.display = anyActive ? 'inline-block' : 'none';
    }

    function resetAllFilters() {
      document.getElementById('searchInput').value = '';
      document.querySelectorAll('[name="filter_month"],[name="filter_region"],[name="filter_type"],[name="filter_jawon"],[name="filter_target"]')
        .forEach(c => c.checked = false);
      renderTable();
    }

    function toggleFdd(id) {
      const el = document.getElementById(id);
      const isOpen = el.classList.contains('open');
      // ëª¨ë‘ ë‹«ê¸°
      document.querySelectorAll('.fdd.open').forEach(d => d.classList.remove('open'));
      if (!isOpen) el.classList.add('open');
    }

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', e => {
      if (!e.target.closest('.fdd')) {
        document.querySelectorAll('.fdd.open').forEach(d => d.classList.remove('open'));
      }
    });

    function filteredRecords() {
      const q = document.getElementById('searchInput').value.toLowerCase().trim();
      const filters = getSelectedFilters();
      let result = records.map((r, i) => ({ r, i })).filter(({ r }) => {
        if (q) {
          // ëª¨ë“  í…ìŠ¤íŠ¸ í•„ë“œì—ì„œ ê²€ìƒ‰ (ê°•ì‚¬1~ê°•ì‚¬9 ê°œë³„ í•„ë“œ ëª¨ë‘ í¬í•¨)
          const searchFields = [
            r.êµìœ¡ëª…, r.ê¸°ê´€ëª…, r.ë‹´ë‹¹ì, r.ê¶Œì—­,
            r.êµìœ¡ìœ í˜•, r.ìì›, r.ë¹„ê³ , r.êµìœ¡ì¥ì†Œ, r.êµìœ¡ì¼,
            String(r.ì›” || ''),
            r.ê°•ì‚¬1, r.ê°•ì‚¬2, r.ê°•ì‚¬3, r.ê°•ì‚¬4, r.ê°•ì‚¬5,
            r.ê°•ì‚¬6, r.ê°•ì‚¬7, r.ê°•ì‚¬8, r.ê°•ì‚¬9
          ];
          const combined = searchFields.filter(Boolean).join(' ').toLowerCase();
          if (!combined.includes(q)) return false;
        }
        if (filters.months.length > 0 && !filters.months.includes(String(r.ì›”))) return false;
        if (filters.regions.length > 0 && !filters.regions.includes(r.ê¶Œì—­)) return false;
        if (filters.types.length > 0 && !filters.types.includes(r.êµìœ¡ìœ í˜•)) return false;
        if (filters.jawons.length > 0 && !filters.jawons.includes(r.ìì›)) return false;
        // ëŒ€ìƒë³„ í•„í„°: ì„ íƒí•œ ëŒ€ìƒ ì¤‘ í•˜ë‚˜ë¼ë„ ì¸ì›ì´ ìˆëŠ” ë ˆì½”ë“œ
        if (filters.targets.length > 0 && !filters.targets.some(t => parseInt(r[t]) > 0)) return false;
        return true;
      });
      // ì •ë ¬
      const { key, dir } = currentSort;
      result.sort((a, b) => {
        const va = (a.r[key] || '');
        const vb = (b.r[key] || '');
        const cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return dir === 'asc' ? cmp : -cmp;
      });
      return result;
    }

    let lastSearchTime = 0;
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const emptyState = document.getElementById('emptyState');

      const filtered = filteredRecords();
      updateStats(filtered.map(f => f.r));

      const searchVal = document.getElementById('searchInput').value.toLowerCase().trim();
      if (searchVal && Date.now() - lastSearchTime > 3000) {
        addLog('ê²€ìƒ‰', searchVal, `ê²°ê³¼ ${filtered.length}ê±´`);
        lastSearchTime = Date.now();
      }

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';

      // â”€â”€ ì´ê³„ í–‰ (ë°ì´í„° ìœ„ì— í‘œì‹œ) â”€â”€
      const rows = filtered.map(f => f.r);
      const ftParticipant = rows.reduce((s, r) => s + (parseInt(r.ì°¸ì—¬ììˆ˜) || parseInt(r.ì¸ì›_ê³„) || 0), 0);
      const ftInstructor = rows.filter(r => r.ê°•ì‚¬1 && String(r.ê°•ì‚¬1).trim()).length;
      const ftTargets = TARGET_KEYS.map(k => rows.reduce((s, r) => s + (parseInt(r[k]) || 0), 0));
      const ftGrandTotal = ftTargets.reduce((a, b) => a + b, 0);
      const ftTargetThs = ftTargets.map(v => `<th class="foot-target">${v || ''}</th>`).join('');
      document.getElementById('tableTotalRow').innerHTML =
        `<th class="foot-label">í•©ê³„</th>
     <th class="foot-label">${rows.length}ê±´</th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label"></th>
     <th class="foot-label">${ftInstructor}ëª…</th>
     <th class="foot-label"></th>
     <th class="foot-participant">${ftParticipant || ''}</th>
     ${ftTargetThs}
     <th class="foot-total">${ftGrandTotal || ''}</th>
     <th></th>`;

      const dataRows = filtered.map(({ r, i }, rowNo) => {
        const total = getTotal(r);
        const tCells = TARGET_KEYS.map(k => {
          const v = parseInt(r[k]) || 0;
          return `<td class="${v ? 'num-cell' : 'zero'}">${v || ''}</td>`;
        }).join('');
        const dateStr = r.êµìœ¡ì¼ ? String(r.êµìœ¡ì¼).substring(0, 10) : '';
        return `<tr>
      <td>${rowNo + 1}</td>
      <td class="name-cell" title="${r.êµìœ¡ëª… || ''}">${r.êµìœ¡ëª… || ''}</td>
      <td>${dateStr}</td>
      <td>${r.ê¶Œì—­ || ''}</td>
      <td>${r.ìì› || ''}</td>
      <td>${r.êµìœ¡ìœ í˜• || ''}</td>
      <td>${r.ë‹´ë‹¹ì || ''}</td>
      <td style="white-space:normal;min-width:80px">${[r.ê°•ì‚¬1, r.ê°•ì‚¬2, r.ê°•ì‚¬3, r.ê°•ì‚¬4, r.ê°•ì‚¬5, r.ê°•ì‚¬6, r.ê°•ì‚¬7, r.ê°•ì‚¬8, r.ê°•ì‚¬9].filter(Boolean).join(', ')}</td>
      <td style="max-width:100px;overflow:hidden;text-overflow:ellipsis">${r.ê¸°ê´€ëª… || ''}</td>
      <td style="text-align:center;font-weight:600">${r.ì°¸ì—¬ììˆ˜ != null ? r.ì°¸ì—¬ììˆ˜ : (r.ì¸ì›_ê³„ || '')}</td>
      ${tCells}
      <td class="total-cell">${total || ''}</td>
      <td>
        <button class="btn btn-outline btn-sm" onclick="openEditModal('${r._id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRecord('${r._id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
      }).join('');

      tbody.innerHTML = dataRows;

      // ì´ê³„ í–‰ ë†’ì´ ì¸¡ì • í›„ ì»¬ëŸ¼ í—¤ë” top ì§ì ‘ ì„¤ì •
      function fixHeaderTop() {
        const totalRow = document.getElementById('tableTotalRow');
        const headerRow = document.getElementById('tableHeader');
        if (!totalRow || !headerRow) return;
        const h = totalRow.offsetHeight;
        if (h > 0) {
          Array.from(headerRow.querySelectorAll('th')).forEach(th => {
            th.style.top = h + 'px';
          });
        }
      }
      requestAnimationFrame(() => requestAnimationFrame(fixHeaderTop));

      // Filter status
      const activeFilters = getSelectedFilters();
      const filters = [];
      if (document.getElementById('searchInput').value) filters.push('ê²€ìƒ‰');
      if (activeFilters.months.length > 0) filters.push(activeFilters.months.join(',') + 'ì›”');
      if (activeFilters.regions.length > 0) filters.push(activeFilters.regions.join(','));
      if (activeFilters.types.length > 0) filters.push(activeFilters.types.join(','));
      if (activeFilters.jawons.length > 0) filters.push(activeFilters.jawons.join(','));
      document.getElementById('filterStatus').textContent = filters.length ? 'í•„í„°: ' + filters.join(', ') : 'í•„í„°: ì—†ìŒ';
    }

    function updateStats(recs) {
      const sumParticipant = recs.reduce((s, r) => s + (parseInt(r.ì°¸ì—¬ììˆ˜) || parseInt(r.ì¸ì›_ê³„) || 0), 0);
      const sumInstructor = recs.filter(r => r.ê°•ì‚¬1 && String(r.ê°•ì‚¬1).trim()).length;
      const sumTargetTotal = recs.reduce((s, r) => s + getTotal(r), 0);
      document.getElementById('statCount').textContent = recs.length;
      document.getElementById('statParticipant').textContent = sumParticipant.toLocaleString();
      document.getElementById('statInstructor').textContent = sumInstructor;
      document.getElementById('statTargetTotal').textContent = sumTargetTotal.toLocaleString();
      document.getElementById('statGifund').textContent = recs.filter(r => r.ìì› === 'ê¸°ê¸ˆ').length;
      document.getElementById('statJache').textContent = recs.filter(r => r.ìì› === 'ìì²´').length;
      document.getElementById('statEtc').textContent = recs.filter(r => r.ìì› === 'ê¸°íƒ€').length;
      document.getElementById('navStat').textContent = `ì´ ${records.length}ê±´ / ${sumParticipant.toLocaleString()}ëª…`;
    }

    // ================================================================
    // MODAL MANAGEMENT
    // ================================================================
    function openAddModal() {
      addLog('ë²„íŠ¼í´ë¦­', 'ìƒˆ ë ˆì½”ë“œ ì¶”ê°€', 'ì…ë ¥ í¼ ì—´ê¸°');
      editingId = null;
      document.getElementById('modalTitle').textContent = 'ìƒˆ êµìœ¡ ë ˆì½”ë“œ ì¶”ê°€';
      clearForm();
      // ì‹ ê·œ ì¶”ê°€: ì ê¸ˆ ì—†ìŒ, ê°œë°œì ë²„íŠ¼ ìˆ¨ê¹€, ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ í‘œì‹œ
      lockBasicSections(false);
      document.getElementById('btnDevUnlock').style.display = 'none';
      document.getElementById('importBtnsInModal').style.display = 'flex';
      document.getElementById('btnSaveRecord').style.display = '';
      document.getElementById('editModal').classList.add('active');
    }

    function openEditModal(_id) {
      editingId = _id;
      // ìˆ˜ì • ëª¨ë“œ: ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ ìˆ¨ê¹€
      document.getElementById('importBtnsInModal').style.display = 'none';
      const r = records.find(rec => rec._id === _id);
      document.getElementById('modalTitle').textContent = 'êµìœ¡ ë ˆì½”ë“œ ìˆ˜ì •';
      clearForm();
      // Fill basic
      document.getElementById('f_name').value = r.êµìœ¡ëª… || '';
      document.getElementById('f_date').value = r.êµìœ¡ì¼ ? String(r.êµìœ¡ì¼).substring(0, 10) : '';
      document.getElementById('f_month').value = r.ì›” || '';
      document.getElementById('f_region').value = r.ê¶Œì—­ || '';
      document.getElementById('f_type').value = r.êµìœ¡ìœ í˜• || '';
      document.getElementById('f_jawon').value = r.ìì› || '';
      document.getElementById('f_manager').value = r.ë‹´ë‹¹ì || '';
      document.getElementById('f_org').value = r.ê¸°ê´€ëª… || '';
      document.getElementById('f_place').value = r.êµìœ¡ì¥ì†Œ || '';
      document.getElementById('f_instr_cnt').value = r.ê°•ì‚¬ìˆ˜ || 0;
      for (let i = 1; i <= 9; i++) document.getElementById('f_i' + i).value = r['ê°•ì‚¬' + i] || '';
      // Fill targets
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        if (el) {
          el.value = r[k] || '';
          el.classList.toggle('has-value', !!(r[k]));
        }
      });
      document.getElementById('f_memo_target').value = r.ë©”ëª¨_í˜„ì¥ì¸ì› || '';
      document.getElementById('f_note').value = r.ë¹„ê³  || '';
      updateTotal();
      // ìˆ˜ì • ëª¨ë“œ: ê¸°ë³¸ì •ë³´/ê°•ì‚¬ì •ë³´ ì ê¸ˆ, ê°œë°œì ë²„íŠ¼ í‘œì‹œ
      lockBasicSections(true);
      document.getElementById('btnDevUnlock').style.display = 'inline-flex';
      document.getElementById('editModal').classList.add('active');
    }

    function lockBasicSections(lock) {
      ['section-basic', 'section-instructor'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('section-locked', lock);
      });
    }

    function devUnlock() {
      const pw = prompt('ê°œë°œì ìˆ˜ì • ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw === null) return;
      if (pw !== '0318@') { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error'); return; }
      lockBasicSections(false);
      document.getElementById('btnDevUnlock').textContent = 'ğŸ”“ ì ê¸ˆ í•´ì œë¨';
      document.getElementById('btnDevUnlock').style.color = '#16a34a';
      document.getElementById('btnDevUnlock').style.borderColor = '#16a34a';
      document.getElementById('btnDevUnlock').disabled = true;
      showToast('ê¸°ë³¸ì •ë³´ ë° ê°•ì‚¬ì •ë³´ ìˆ˜ì • ê°€ëŠ¥', 'success');
    }

    // ê´€ë¦¬ì ê¸°ëŠ¥ ì‹¤í–‰ ì „ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    function checkAdminAction(callback) {
      const pw = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw === '0318@') {
        callback(); // ì½œë°± ë¨¼ì € ì‹¤í–‰ (UI ì¦‰ê°ì„±)
        addLog('ë³´ì•ˆ', 'ê´€ë¦¬ì ì¸ì¦', 'ì„±ê³µ');
      } else if (pw !== null) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
        addLog('ë³´ì•ˆ', 'ê´€ë¦¬ì ì¸ì¦', 'ì‹¤íŒ¨ (ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼)');
      }
    }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function switchModalTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.modal-tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));

      // Show selected tab
      const tabEl = document.getElementById('tab-' + tabName);
      if (tabEl) {
        tabEl.classList.add('active');
        const tabBtn = document.querySelector(`.modal-tab:nth-child(${tabName === 'info' ? '1' : '2'})`);
        if (tabBtn) tabBtn.classList.add('active');

        // Load participants if switching to that tab
        if (tabName === 'participants' && editingId) {
          loadParticipants(records.find(r => r._id === editingId));
        }
      }
    }

    function clearForm() {
      document.getElementById('f_name').value = '';
      document.getElementById('f_date').value = '';
      document.getElementById('f_month').value = '';
      document.getElementById('f_region').value = '';
      document.getElementById('f_type').value = '';
      document.getElementById('f_jawon').value = '';
      document.getElementById('f_manager').value = '';
      document.getElementById('f_org').value = '';
      document.getElementById('f_place').value = '';
      document.getElementById('f_instr_cnt').value = 0;
      for (let i = 1; i <= 9; i++) document.getElementById('f_i' + i).value = '';
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        if (el) { el.value = ''; el.classList.remove('has-value'); }
      });
      document.getElementById('f_memo_target').value = '';
      document.getElementById('f_note').value = '';
      document.getElementById('totalDisplay').textContent = '0 ëª…';
    }

    function autoMonth() {
      const d = document.getElementById('f_date').value;
      if (d) {
        const m = new Date(d).getMonth() + 1;
        document.getElementById('f_month').value = m;
      }
    }

    function updateTotal() {
      let sum = 0;
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        if (el) {
          const v = parseInt(el.value) || 0;
          sum += v;
          el.classList.toggle('has-value', v > 0);
        }
      });
      document.getElementById('totalDisplay').textContent = sum.toLocaleString() + ' ëª…';
    }

    function saveRecord() {
      const name = document.getElementById('f_name').value.trim();
      if (!name) { showToast('êµìœ¡ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

      const r = {
        êµìœ¡ëª…: name,
        êµìœ¡ì¥ì†Œ: document.getElementById('f_place').value,
        êµìœ¡ì¼: document.getElementById('f_date').value,
        ì›”: parseInt(document.getElementById('f_month').value) || null,
        ê¶Œì—­: document.getElementById('f_region').value,
        ìì›: document.getElementById('f_jawon').value,
        êµìœ¡ìœ í˜•: document.getElementById('f_type').value,
        ë‹´ë‹¹ì: document.getElementById('f_manager').value,
        ê°•ì‚¬ìˆ˜: parseInt(document.getElementById('f_instr_cnt').value) || 0,
        ê¸°ê´€ëª…: document.getElementById('f_org').value,
        ë¹„ê³ : document.getElementById('f_note').value,
        ë©”ëª¨_í˜„ì¥ì¸ì›: document.getElementById('f_memo_target').value,
      };
      for (let i = 1; i <= 9; i++) r['ê°•ì‚¬' + i] = document.getElementById('f_i' + i).value;
      TARGET_KEYS.forEach(k => {
        const el = document.getElementById('t_' + k);
        const v = el ? (parseInt(el.value) || 0) : 0;
        r[k] = v || null;
      });

      if (editingId) {
        // ìˆ˜ì •: ê¸°ì¡´ ë ˆì½”ë“œì˜ Firestore ë¬¸ì„œë§Œ ì—…ë°ì´íŠ¸
        const oldRecord = records.find(rec => rec._id === editingId);
        const updated = { ...oldRecord, ...r }; // í¼ì— ì—†ëŠ” í•„ë“œ(ì°¸ì—¬ììˆ˜ ë“±) ë³´ì¡´

        // ë°ì´í„° ë³€ê²½ ë¡œê·¸ ë‚¨ê¸°ê¸°
        for (const key in r) {
          if (JSON.stringify(oldRecord[key]) !== JSON.stringify(r[key])) {
            const before = oldRecord[key] == null ? '' : oldRecord[key];
            const after = r[key] == null ? '' : r[key];
            addLog(oldRecord.êµìœ¡ëª…, key, String(before) + ' â†’ ' + String(after));
          }
        }

        if (editingId.includes('_')) {
          // ë²Œí¬ ë°ì´í„°(ë°°ì—´) ë‚´ì˜ ë ˆì½”ë“œ ìˆ˜ì • ì²˜ë¦¬
          const [docId, index] = editingId.split('_');
          const idx = parseInt(index);
          db.collection(FS_COL).doc(docId).get().then(doc => {
            if (doc.exists) {
              const data = doc.data();
              if (data.records && Array.isArray(data.records)) {
                data.records[idx] = { ...data.records[idx], ...r };
                return db.collection(FS_COL).doc(docId).set(data);
              }
            }
            throw new Error('ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          })
            .then(() => {
              showToast('ìˆ˜ì • ì™„ë£Œ', 'success');
              addLog(oldRecord.êµìœ¡ëª…, 'ì €ì¥ê²°ê³¼', '', 'âœ… ìˆ˜ì • ì™„ë£Œ');
            })
            .catch(e => {
              console.error('ìˆ˜ì • ì‹¤íŒ¨:', e);
              showToast('ìˆ˜ì • ì‹¤íŒ¨: ' + e.message, 'error');
              addLog(oldRecord.êµìœ¡ëª…, 'ì €ì¥ê²°ê³¼', '', 'âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
            });
        } else {
          // ê°œë³„ ë¬¸ì„œ ìˆ˜ì •
          db.collection(FS_COL).doc(editingId).set(updated)
            .then(() => {
              showToast('ìˆ˜ì • ì™„ë£Œ', 'success');
              addLog(oldRecord.êµìœ¡ëª…, 'ì €ì¥ê²°ê³¼', '', 'âœ… ìˆ˜ì • ì™„ë£Œ');
            })
            .catch(e => {
              showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
              addLog(oldRecord.êµìœ¡ëª…, 'ì €ì¥ê²°ê³¼', '', 'âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
            });
        }
      } else {
        // ì‹ ê·œ: ìƒˆ Firestore ë¬¸ì„œ ì¶”ê°€ (ìë™ ID)
        db.collection(FS_COL).add(r)
          .then(() => {
            showToast('ì¶”ê°€ ì™„ë£Œ', 'success');
            addLog('ì‹ ê·œì¶”ê°€', 'êµìœ¡ëª…', name, 'âœ… ì €ì¥ ì™„ë£Œ');
          })
          .catch(e => {
            showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            addLog('ì‹ ê·œì¶”ê°€', 'êµìœ¡ëª…', name, 'âŒ ì €ì¥ ì‹¤íŒ¨');
          });
      }
      // renderTableì€ onSnapshotì´ ìë™ ì²˜ë¦¬
      closeModal('editModal');
    }

    function deleteRecord(_id) {
      const rec = records.find(r => r._id === _id);
      if (!confirm('ì´ ë ˆì½”ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const recName = rec ? rec.êµìœ¡ëª… : '';
      db.collection(FS_COL).doc(_id).delete()
        .then(() => {
          showToast('ì‚­ì œë¨');
          addLog(recName, 'ì‚­ì œ', '', 'âœ… ì‚­ì œ ì™„ë£Œ');
        })
        .catch(e => {
          showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
          addLog(recName, 'ì‚­ì œ', '', 'âŒ ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
        });
      // renderTableì€ onSnapshotì´ ìë™ ì²˜ë¦¬
    }

    function clearAllData() {
      const pw = prompt('ì „ì²´ ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw === null) return;
      if (pw !== '0318@') { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error'); return; }
      if (!confirm(`ì „ì²´ ${records.length}ê±´ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      const totalCnt = records.length;
      db.collection(FS_COL).get().then(snap => {
        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      }).then(() => {
        showToast('ì „ì²´ ì‚­ì œë¨');
        addLog('ë²„íŠ¼í´ë¦­', 'ì „ì²´ì‚­ì œ', `${totalCnt}ê±´`, 'âœ… ì „ì²´ ì‚­ì œ ì™„ë£Œ');
        logs = [];
        saveLogs();
      }).catch(e => {
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
        addLog('ë²„íŠ¼í´ë¦­', 'ì „ì²´ì‚­ì œ', `${totalCnt}ê±´`, 'âŒ ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
      });
    }

    // ================================================================
    // IMPORT / EXPORT
    // ================================================================
    function importExcel(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const wb = XLSX.read(e.target.result, { type: 'binary', cellDates: true });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

          // Find header row (row 3 in original = index 2)
          let headerRow = -1;
          for (let i = 0; i < Math.min(data.length, 10); i++) {
            if (data[i].includes('êµìœ¡ëª…') || data[i].includes('êµìœ¡ì¼')) { headerRow = i; break; }
          }
          if (headerRow < 0) { showToast('í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

          const headers = data[headerRow].map(h => String(h || '').trim().replace(/\n/g, ''));
          let imported = 0;
          const toAdd = [];
          for (let i = headerRow + 1; i < data.length; i++) {
            const row = data[i];
            if (!row[0] && !row[5]) continue; // skip empty
            const r = {};
            headers.forEach((h, ci) => { if (h) r[h] = row[ci] !== undefined ? row[ci] : ''; });
            const mapped = mapImportedRow(r, headers, row);
            if (mapped.êµìœ¡ëª…) {
              toAdd.push(mapped);
              imported++;
            }
          }
          if (toAdd.length > 0) {
            saveBatchToFirestore(toAdd)
              .then(() => {
                showToast(`${imported}ê±´ Firestore ì €ì¥ ì™„ë£Œ`, 'success');
                addLog('ë²„íŠ¼í´ë¦­', 'Excel ê°€ì ¸ì˜¤ê¸°', `${imported}ê±´`, 'âœ… ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
                renderTable();
              })
              .catch(e => {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
                addLog('ë²„íŠ¼í´ë¦­', 'Excel ê°€ì ¸ì˜¤ê¸°', `${imported}ê±´ íŒŒì‹±`, 'âŒ ì €ì¥ ì‹¤íŒ¨: ' + e.message);
              });
          } else {
            showToast('ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
            addLog('ë²„íŠ¼í´ë¦­', 'Excel ê°€ì ¸ì˜¤ê¸°', '0ê±´', 'âš ï¸ ê°€ì ¸ì˜¬ ë°ì´í„° ì—†ìŒ');
          }
        } catch (e) {
          showToast('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + e.message, 'error');
          addLog('ë²„íŠ¼í´ë¦­', 'Excel ê°€ì ¸ì˜¤ê¸°', '-', 'âŒ íŒŒì‹± ì˜¤ë¥˜: ' + e.message);
        }
      };
      reader.readAsBinaryString(file);
      input.value = '';
    }

    function mapImportedRow(r, headers, rowArr) {
      // Map from original Excel column positions
      const colIdx = (name) => headers.findIndex(h => h.includes(name));
      const get = (idx) => idx >= 0 ? rowArr[idx] : '';

      const mapped = {
        êµìœ¡ëª…: String(get(0) || '').trim(),
        êµìœ¡ì¥ì†Œ: String(get(4) || '').trim(),
        êµìœ¡ì¼: formatDate(get(5)),
        ì›”: parseInt(get(6)) || null,
        ê¶Œì—­: String(get(7) || '').trim(),
        ìì›: String(get(8) || '').trim(),
        êµìœ¡ìœ í˜•: String(get(9) || '').trim(),
        ë‹´ë‹¹ì: String(get(10) || '').trim(),
        ê°•ì‚¬ìˆ˜: parseInt(get(11)) || 0,
        ê¸°ê´€ëª…: String(get(21) || '').trim(),
        ë¹„ê³ : String(get(64) || '').trim(),
      };
      for (let i = 1; i <= 9; i++) mapped['ê°•ì‚¬' + i] = String(get(11 + i) || '').trim();
      TARGET_KEYS.forEach((k, ki) => {
        const v = parseInt(get(22 + ki)) || 0;
        mapped[k] = v || null;
      });
      return mapped;
    }

    function formatDate(v) {
      if (!v) return '';
      if (v instanceof Date) return v.toISOString().substring(0, 10);
      const s = String(v);
      if (s.includes('-') || s.includes('/')) return s.substring(0, 10);
      return s;
    }

    function exportExcel() {
      if (records.length === 0) { showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

      const wb = XLSX.utils.book_new();

      // â”€â”€ Sheet 1: 2026ë…„ êµìœ¡ì‹¤ì  â”€â”€
      const wsData = [];

      // Row 1: Group codes (empty for now, simplified)
      const row1 = new Array(65).fill('');
      [22, 23, 24, 25, 26].forEach(i => row1[i] = 2);
      [27, 28, 29, 30].forEach(i => row1[i] = 1);
      [31, 32].forEach(i => row1[i] = 3);
      [33, 34, 35, 37, 38].forEach(i => row1[i] = 4);
      [36].forEach(i => row1[i] = 3);
      [39].forEach(i => row1[i] = 6);
      row1.unshift('');
      wsData.push(row1);

      // Row 2: Section labels
      const row2 = new Array(66).fill('');
      row2[0] = 'êµìœ¡êµ¬ë¶„';
      row2[11] = 'ê°•ì‚¬ì •ë³´';
      const subtotalCols = TARGET_KEYS.map((_, ki) => 22 + ki);
      subtotalCols.forEach((ci, ki) => {
        const col = XLSX.utils.encode_col(ci);
        row2[ci] = { f: `SUBTOTAL(9,${col}4:${col}3044)` };
      });
      const lastTargetCol = XLSX.utils.encode_col(22 + TARGET_KEYS.length - 1);
      row2[63] = { f: `SUM(W2:${lastTargetCol}2)` };
      wsData.push(row2);

      // Row 3: Column headers
      const headers3 = [
        'êµìœ¡ëª…', 'êµìœ¡ì¼ ì„ë°• ë¶ˆì°¸ê±´\n(ê°ì )', 'ì˜ì–´êµìœ¡ ê±´\n(ê°€ì )', 'ê¸´ê¸‰ì¶”ì§„ ê±´\n(ê°€ì )', 'êµìœ¡ì¥ì†Œ\n(ìƒì„¸)',
        'êµìœ¡ì¼', 'ì›”', 'ì§€ì—­\n(ê¶Œì—­)', 'ìì›', 'êµìœ¡ìœ í˜•', 'ë‹´ë‹¹ì',
        'ê°•ì‚¬ ìˆ˜\n(ì „ë¬¸ê°•ì‚¬ìˆ˜)', 'ê°•ì‚¬1', 'ê°•ì‚¬2', 'ê°•ì‚¬3', 'ê°•ì‚¬4', 'ê°•ì‚¬5', 'ê°•ì‚¬6', 'ê°•ì‚¬7', 'ê°•ì‚¬8', 'ê°•ì‚¬9',
        'ê¸°ê´€ëª…',
        ...TARGET_LABELS,
        'í•©ê³„', 'ë¹„ê³ '
      ];
      wsData.push(headers3);

      // Data rows
      records.forEach((r, ri) => {
        const rowNum = ri + 4;
        const row = [
          r.êµìœ¡ëª… || '',
          '', '', '',
          r.êµìœ¡ì¥ì†Œ || '',
          r.êµìœ¡ì¼ || '',
          r.êµìœ¡ì¼ ? { f: `MONTH(F${rowNum})` } : '',
          r.ê¶Œì—­ || '',
          r.ìì› || '',
          r.êµìœ¡ìœ í˜• || '',
          r.ë‹´ë‹¹ì || '',
          r.ê°•ì‚¬ìˆ˜ || 0,
          r.ê°•ì‚¬1 || '', r.ê°•ì‚¬2 || '', r.ê°•ì‚¬3 || '', r.ê°•ì‚¬4 || '', r.ê°•ì‚¬5 || '',
          r.ê°•ì‚¬6 || '', r.ê°•ì‚¬7 || '', r.ê°•ì‚¬8 || '', r.ê°•ì‚¬9 || '',
          r.ê¸°ê´€ëª… || '',
          ...TARGET_KEYS.map(k => parseInt(r[k]) || 0),
          { f: `SUBTOTAL(9,W${rowNum}:BK${rowNum})` },
          r.ë¹„ê³  || ''
        ];
        wsData.push(row);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // Merged cells
      if (!ws['!merges']) ws['!merges'] = [];
      ws['!merges'].push({ s: { r: 1, c: 0 }, e: { r: 1, c: 5 } }); // A2:F2
      ws['!merges'].push({ s: { r: 1, c: 11 }, e: { r: 1, c: 20 } }); // L2:U2

      // Column widths
      const colWidths = [{ wch: 40 }, { wch: 6 }, { wch: 6 }, { wch: 6 }, { wch: 20 },
      { wch: 12 }, { wch: 4 }, { wch: 8 }, { wch: 6 }, { wch: 10 }, { wch: 8 },
      { wch: 6 }, ...Array(9).fill({ wch: 8 }), { wch: 12 },
      ...Array(41).fill({ wch: 5 }), { wch: 6 }, { wch: 20 }];
      ws['!cols'] = colWidths;

      XLSX.utils.book_append_sheet(wb, ws, '2026ë…„ êµìœ¡ì‹¤ì ');

      // â”€â”€ Sheet 2: BASE â”€â”€
      const baseData = [
        ['ì¬ì›', 'ê¶Œì—­', 'ê¸°ê´€ëª…', 'êµìœ¡ìœ í˜•', 'ê°•ì‚¬ëª…', 'ëŒ€ìƒ', 'ì¢…ëª©ë‹¨ì²´ëª…'],
        ['ê¸°ê¸ˆ', 'ì„œìš¸', 'ëŒ€í•œì²´ìœ¡íšŒ', 'ê°•ì˜í˜•(ëŒ€ë©´)êµìœ¡', 'ê°•ëª…ì‹ ', 'ì´ˆë“±ì„ ìˆ˜', 'Kë¦¬ê·¸'],
        ['ìì²´', 'ë¶€ì‚°', 'íšŒì›ì¢…ëª©ë‹¨ì²´', 'ì˜¨ë¼ì¸ ì‹¤ì‹œê°„', 'ê°•ë¯¼ìš°', 'ì¤‘ë“±ì„ ìˆ˜', 'KBO'],
        ['ê¸°íƒ€', 'ì¸ì²œ', 'ëŒ€í•œì¥ì• ì¸ì²´ìœ¡íšŒ', 'ì²´í—˜í˜•', 'ê°•íš¨ì°¬', 'ê³ ë“±ì„ ìˆ˜', 'KOVO'],
        ['', 'ëŒ€êµ¬', 'ê°€ë§¹ê²½ê¸°ë‹¨ì²´', 'ì•„ì›ƒë¦¬ì¹˜', 'ê³½ìƒìˆ˜', 'ëŒ€í•™ì„ ìˆ˜', 'KBL'],
        ['', 'ëŒ€ì „', 'ì‹œë„ì²´ìœ¡íšŒ', '', 'ê¶Œì§„ìˆ™', 'í´ëŸ½ ì„ ìˆ˜ë°˜', 'WKBL'],
        ['', 'ê´‘ì£¼', 'ì‹œë„ì¥ì• ì¸ì²´ìœ¡íšŒ', '', 'ê¶Œí˜„ì„', 'í•™êµìš´ë™ë¶€ì§€ë„ì', 'KPGA'],
        ['', 'ìš¸ì‚°', 'í”„ë¡œìŠ¤í¬ì¸ ë‹¨ì²´', '', 'ê¸°ë³´ë°°', 'í•™ë¶€ëª¨', 'KLPGA'],
        ['', 'ì„¸ì¢…', 'ì‹œë„êµìœ¡(ì§€ì›)ì²­', '', 'ê¹€ë‚˜ë¼', 'ì§ì¥ìš´ë™ê²½ê¸°ë¶€', ''],
        ['', 'ê²½ê¸°', 'ì²´ìœ¡ì¤‘ê³ ', '', 'ê¹€ë¯¼ì •', 'êµ­ê°€ëŒ€í‘œ', ''],
        ['', 'ê°•ì›', 'í•™êµìš´ë™ë¶€', '', 'ê¹€ë¯¼ì£¼', 'êµ­ê°€ëŒ€í‘œí›„ë³´ì„ ìˆ˜', ''],
        ['', 'ì¶©ë¶', 'ì²´ìœ¡ì§€ë„ì ìê²©ì—°ìˆ˜ê¸°ê´€', '', 'ê¹€ë°˜ì„', 'ì²­ì†Œë…„ëŒ€í‘œ', ''],
        ['', 'ì¶©ë‚¨', 'ê¸°íƒ€', '', 'ê¹€ìƒí›ˆ', 'ê¿ˆë‚˜ë¬´ì„ ìˆ˜', ''],
        ['', 'ì „ë¶', '', '', 'ê¹€ì„í˜„', 'RTPTP', ''],
        ['', 'ì „ë‚¨', '', '', 'ê¹€ì˜ë¯¸', 'ì œì¬í›„ë³µê·€ì„ ìˆ˜', ''],
        ['', 'ê²½ë¶', '', '', 'ê¹€ì¸ìˆ™', 'ì‹¬íŒì§€ë„ìê°•ìŠµíšŒ', ''],
        ['', 'ê²½ë‚¨', '', '', 'ê¹€ì¼ì‚¼', 'ì¥ì• ì„ ìˆ˜', ''],
        ['', 'ì œì£¼', '', '', 'ê¹€ì§€ì˜', 'ì¥ì• ì„ ìˆ˜ì§€ì›ìš”ì›', ''],
        ['', '', '', '', 'ê¹€ì§„í›ˆ', 'í”„ë¡œì„ ìˆ˜', ''],
        ['', '', '', '', 'ê¹€í˜„ì£¼', 'í”„ë¡œì‹ ì¸ì„ ìˆ˜', ''],
        ['', '', '', '', 'ê¹€í¬ì •', 'í”„ë¡œìœ ì†Œë…„ì„ ìˆ˜', ''],
        ['', '', '', '', 'ë‚¨ìƒì„¤', 'ìŠ¤í¬ì¸ ì§€ë„ìì—°ìˆ˜ìƒ', ''],
        ['', '', '', '', 'ë‚¨ì„±ë¯¼', 'ìŠ¤í¬ì¸ í–‰ì •ê°€', ''],
        ['', '', '', '', 'ë‚¨íƒì–¸', 'ê²€ì‚¬ëŒ€ìƒì ì‚¬ì „êµìœ¡', ''],
      ];
      const wsBase = XLSX.utils.aoa_to_sheet(baseData);
      XLSX.utils.book_append_sheet(wb, wsBase, 'BASE');

      const date = new Date().toISOString().substring(0, 10).replace(/-/g, '');
      XLSX.writeFile(wb, `êµìœ¡ì‹¤ì _2026_${date}.xlsx`);
      showToast(`${records.length}ê±´ Excel ë‚´ë³´ë‚´ê¸° ì™„ë£Œ`, 'success');
      addLog('ë²„íŠ¼í´ë¦­', 'Excel ë‚´ë³´ë‚´ê¸°', `${records.length}ê±´`, 'âœ… ë‚´ë³´ë‚´ê¸° ì™„ë£Œ');
    }



    function extractArrayFromJson(data) {
      // 1) ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ
      if (Array.isArray(data)) return data;
      // 2) {êµìœ¡ëª©ë¡:[...]} ë˜í¼ êµ¬ì¡° (eKADA ì¶”ì¶œë°ì´í„° í˜•ì‹)
      if (data && Array.isArray(data.êµìœ¡ëª©ë¡)) return data.êµìœ¡ëª©ë¡;
      // 3) ë‹¨ì¼ ê°ì²´ë©´ ë°°ì—´ë¡œ
      return [data];
    }

    function importJsonFile(input) {
      addLog('ë²„íŠ¼í´ë¦­', 'JSON íŒŒì¼ ê°€ì ¸ì˜¤ê¸°', '-');
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function (e) {
        try {
          const data = JSON.parse(e.target.result);
          const arr = extractArrayFromJson(data);
          const finalData = [];
          arr.forEach(item => {
            if (item.êµìœ¡ëª… || item.name) {
              const r = { êµìœ¡ëª…: item.êµìœ¡ëª… || item.name || '', ...item };
              delete r._id; // ê¸°ì¡´ _id ì œê±° (Firestoreê°€ ìƒˆë¡œ ë¶€ì—¬)
              finalData.push(r);
            }
          });
          await saveBatchToFirestore(finalData);
          showToast(`${finalData.length}ê±´ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`);
          addLog('ì—‘ì…€ê°€ì ¸ì˜¤ê¸°', 'ì„±ê³µ', `${finalData.length}ê±´`);
        } catch (e) {
          alert('ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: ' + e.message);
          addLog('ì—‘ì…€ê°€ì ¸ì˜¤ê¸°', 'ì‹¤íŒ¨', e.message);
        }
        input.value = '';
      };
      reader.readAsText(file, 'utf-8');
    }


    // ================================================================
    // TOAST
    // ================================================================
    function showToast(msg, type = '') {
      const c = document.getElementById('toastContainer');
      const t = document.createElement('div');
      t.className = 'toast ' + type;
      const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      t.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
      c.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // ================================================================
    // FILTER INITIALIZATION
    // ================================================================
    function initFilters() {
      // Initialize month checkboxes
      const monthGroup = document.getElementById('filterMonthGroup');
      for (let i = 1; i <= 12; i++) {
        const div = document.createElement('div');
        div.className = 'filter-check';
        div.innerHTML = `<input type="checkbox" id="filter_m${i}" name="filter_month" value="${i}" onchange="renderTable()">
      <label for="filter_m${i}">${i}ì›”</label>`;
        monthGroup.appendChild(div);
      }

      // Initialize region checkboxes
      const regionGroup = document.getElementById('filterRegionGroup');
      REGIONS.forEach(region => {
        const div = document.createElement('div');
        div.className = 'filter-check';
        const id = 'filter_r_' + region;
        div.innerHTML = `<input type="checkbox" id="${id}" name="filter_region" value="${region}" onchange="renderTable()">
      <label for="${id}">${region}</label>`;
        regionGroup.appendChild(div);
      });

      // Initialize type checkboxes
      const typeGroup = document.getElementById('filterTypeGroup');
      TYPES.forEach(type => {
        const div = document.createElement('div');
        div.className = 'filter-check';
        const id = 'filter_t_' + type.replace(/\s/g, '_');
        div.innerHTML = `<input type="checkbox" id="${id}" name="filter_type" value="${type}" onchange="renderTable()">
      <label for="${id}">${type}</label>`;
        typeGroup.appendChild(div);
      });

      // Initialize jawon checkboxes
      const jawonGroup = document.getElementById('filterJawonGroup');
      JAWONS.forEach(jawon => {
        const div = document.createElement('div');
        div.className = 'filter-check';
        const id = 'filter_j_' + jawon;
        div.innerHTML = `<input type="checkbox" id="${id}" name="filter_jawon" value="${jawon}" onchange="renderTable()">
      <label for="${id}">${jawon}</label>`;
        jawonGroup.appendChild(div);
      });

      // Initialize target checkboxes (ëŒ€ìƒë³„)
      const targetShortLabels = [
        'êµ­ëŒ€', 'êµ­í›„', 'ì²­ì†Œë…„', 'ê¿ˆë‚˜ë¬´', 'RTP', 'ì œì¬ë³µ', 'ì§ì¥', 'ì¥êµ­', 'ì¥ì„ ', 'ì¥ì§€',
        'ì´ˆë“±', 'ì¤‘ë“±', 'ê³ ë“±', 'ì²´ì¤‘', 'ì²´ê³ ', 'ìœ ìŠ¤', 'ëŒ€í•™', 'í´ëŸ½', 'êµì‚¬', 'í•™ë¶€ëª¨',
        'KBL', 'KOVO', 'KBO', 'WKBL', 'KLPGA', 'KPGA', 'Kë¦¬ê·¸', 'ê²½ë¥œ',
        '1ì „', '2ì „', '1ì¥', '2ì¥', '1ìƒ', '2ìƒ', 'ê±´ìš´', 'ë…¸ì¸', 'ìœ ì†Œ', 'í–‰ì •', 'ì§€ë„', 'íŠ¸ë ˆ', 'ê¸°íƒ€'
      ];
      const targetGroup = document.getElementById('filterTargetGroup');
      TARGET_KEYS.forEach((key, idx) => {
        const div = document.createElement('div');
        div.className = 'filter-check';
        const id = 'filter_tg_' + idx;
        div.innerHTML = `<input type="checkbox" id="${id}" name="filter_target" value="${key}" onchange="renderTable()">
      <label for="${id}">${targetShortLabels[idx] || key}</label>`;
        targetGroup.appendChild(div);
      });
    }

    // ================================================================
    // BACKUP & RESTORE
    // ================================================================
    function openBackupModal() {
      renderBackupList();
      updateBackupInfo();
      openModal('backupModal');
    }

    function updateBackupInfo() {
      db.collection(FS_COL).doc(FS_META_DOC).get().then(doc => {
        const el = document.getElementById('lastBackupStatus');
        if (doc.exists && doc.data().lastBackupAt) {
          const date = doc.data().lastBackupAt.toDate();
          const diff = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
          el.innerHTML = `âœ… <strong>ë§ˆì§€ë§‰ ë°±ì—…:</strong> ${date.toLocaleString()}<br>â° <strong>ê²½ê³¼ì¼:</strong> ${diff}ì¼ ì „ (14ì¼ ì£¼ê¸°ë¡œ ìë™ ì‹¤í–‰)`;
        } else {
          el.innerHTML = `â„¹ï¸ ìƒì„±ëœ ë°±ì—… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. (14ì¼ ì£¼ê¸°ë¡œ ìë™ ì‹¤í–‰)`;
        }
      });
    }

    function checkAutoBackup() {
      db.collection(FS_COL).doc(FS_META_DOC).get().then(doc => {
        let needsBackup = false;
        if (!doc.exists || !doc.data().lastBackupAt) {
          needsBackup = true;
        } else {
          const last = doc.data().lastBackupAt.toDate();
          const diff = Date.now() - last.getTime();
          if (diff > 14 * 24 * 60 * 60 * 1000) needsBackup = true;
        }

        if (needsBackup) {
          console.log('2ì£¼ ê²½ê³¼ - ìë™ ë°±ì—… ì‹¤í–‰ ì¤‘...');
          performBackup(true);
        }
      });
    }

    async function performBackup(isAuto = false) {
      try {
        // 1. ëª¨ë“  ë°ì´í„° ìŠ¤ëƒ…ìƒ· (logs, metadata ì œì™¸)
        const snap = await db.collection(FS_COL).get();
        const dataToBackup = [];
        snap.docs.forEach(doc => {
          if (doc.id === FS_LOG_DOC || doc.id === FS_META_DOC) return;
          dataToBackup.push({ id: doc.id, data: doc.data() });
        });

        if (dataToBackup.length === 0 && !isAuto) {
          showToast('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        // 2. ë°±ì—… ë°ì´í„° ì €ì¥
        const backupRef = db.collection(FS_BACKUP_COL).doc();
        await backupRef.set({
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          recordCount: dataToBackup.length,
          type: isAuto ? 'ìë™' : 'ìˆ˜ë™',
          payload: JSON.stringify(dataToBackup) // ë¬¸ì„œ êµ¬ì¡° ë³´ì¡´ì„ ìœ„í•´ JSON ë¬¸ìì—´ë¡œ ì €ì¥
        });

        // 3. ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸
        await db.collection(FS_COL).doc(FS_META_DOC).set({
          lastBackupAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        if (!isAuto) {
          showToast('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          renderBackupList();
          updateBackupInfo();
          addLog('ë°±ì—…', 'ìˆ˜ë™ë°±ì—… ìƒì„±', `${dataToBackup.length}ê±´`);
        } else {
          addLog('ë°±ì—…', 'ìë™ë°±ì—… ìƒì„±', `${dataToBackup.length}ê±´`);
        }
      } catch (err) {
        console.error('ë°±ì—… ì˜¤ë¥˜:', err);
        if (!isAuto) showToast('ë°±ì—… ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message, 'error');
      }
    }

    function performManualBackup() {
      performBackup(false);
    }

    function renderBackupList() {
      const container = document.getElementById('backupList');
      db.collection(FS_BACKUP_COL).orderBy('timestamp', 'desc').limit(15).get().then(snap => {
        if (snap.empty) {
          container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--muted)">ì €ì¥ëœ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        let html = '';
        snap.docs.forEach(doc => {
          const d = doc.data();
          const dateStr = d.timestamp ? d.timestamp.toDate().toLocaleString() : 'ì²˜ë¦¬ ì¤‘...';
          html += `
            <div class="backup-item">
              <div>
                <div class="backup-date">${dateStr}</div>
                <div class="backup-meta">${d.type} ë°±ì—… | ë ˆì½”ë“œ: ${d.recordCount}ê±´</div>
              </div>
              <div style="display:flex; gap:6px">
                <button class="btn btn-outline" style="font-size:11px; padding:4px 8px" onclick="restoreFromBackupId('${doc.id}')">ğŸ”„ ë³µêµ¬</button>
                <button class="btn btn-outline" style="font-size:11px; padding:4px 8px; color:#dc2626; border-color:#fee2e2" onclick="deleteBackup('${doc.id}')">ğŸ—‘ï¸</button>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      });
    }

    async function restoreFromBackupId(backupId) {
      if (!confirm('âš ï¸ ì£¼ì˜: ë³µêµ¬ ì‹œ í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë˜ê³  ë°±ì—… ì‹œì ì˜ ë°ì´í„°ë¡œ êµì²´ë©ë‹ˆë‹¤.\nì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      const pw = prompt('ë³´ì•ˆì„ ìœ„í•´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (pw !== '0318@') { if (pw !== null) alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); return; }

      showToast('ë³µêµ¬ ì‘ì—… ì‹œì‘...', 'info');

      try {
        const bDoc = await db.collection(FS_BACKUP_COL).doc(backupId).get();
        if (!bDoc.exists) throw new Error('ë°±ì—…ë³¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        const payload = JSON.parse(bDoc.data().payload);

        // 1. ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (logs, metadata ì œì™¸)
        const currentSnap = await db.collection(FS_COL).get();
        const batchDelete = db.batch();
        currentSnap.docs.forEach(doc => {
          if (doc.id === FS_LOG_DOC || doc.id === FS_META_DOC) return;
          batchDelete.delete(doc.ref);
        });
        await batchDelete.commit();

        // 2. ë°±ì—… ë°ì´í„° ë³µêµ¬
        const batchRestore = db.batch();
        payload.forEach(item => {
          const ref = db.collection(FS_COL).doc(item.id);
          batchRestore.set(ref, item.data);
        });
        await batchRestore.commit();

        showToast('ë°ì´í„° ë³µêµ¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        addLog('ë³µêµ¬', 'ë°±ì—…ë°ì´í„° ë³µì›', `ë°±ì—…ID: ${backupId}`);
        closeModal('backupModal');
      } catch (err) {
        alert('ë³µêµ¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
      }
    }

    function deleteBackup(id) {
      if (!confirm('ì´ ë°±ì—…ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      db.collection(FS_BACKUP_COL).doc(id).delete().then(() => {
        showToast('ë°±ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        renderBackupList();
      });
    }

    function downloadCurrentData() {
      const exportData = records.map(r => {
        const item = { ...r };
        delete item._id; // ë¡œì»¬ìš© ID ì œê±°
        return item;
      });
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ekada_backup_${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      addLog('ë²„íŠ¼í´ë¦­', 'JSON ë‹¤ìš´ë¡œë“œ', '-');
    }

    // ================================================================
    // LOGS MANAGEMENT
    // ================================================================
    function openLogsModal() {
      renderLogs();
      openModal('logsModal');
    }

    function renderLogs() {
      const container = document.getElementById('logsContainer');
      const logCountEl = document.getElementById('logCount');

      if (!logs || logs.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted)">ë¡œê·¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        if (logCountEl) logCountEl.textContent = '';
        return;
      }

      // í•„í„° ê°’ ì½ê¸°
      const logSearchEl = document.getElementById('logSearchInput');
      const logTypeEl = document.getElementById('logTypeFilter');
      const searchQ = logSearchEl ? logSearchEl.value.toLowerCase().trim() : '';
      const typeFilter = logTypeEl ? logTypeEl.value : '';

      // ë¡œê·¸ íƒ€ì…ë³„ ìƒ‰ìƒ/ì•„ì´ì½˜ ì„¤ì •
      const logTypeConfig = {
        'ì‹ ê·œì¶”ê°€': { icon: 'â•', color: '#16a34a', bg: '#dcfce7', label: 'ì‹ ê·œì¶”ê°€' },
        'ìˆ˜ì •': { icon: 'âœï¸', color: '#2563eb', bg: '#dbeafe', label: 'ìˆ˜ì •' },
        'ì‚­ì œ': { icon: 'ğŸ—‘ï¸', color: '#dc2626', bg: '#fee2e2', label: 'ì‚­ì œ' },
        'ê²€ìƒ‰': { icon: 'ğŸ”', color: '#7c3aed', bg: '#ede9fe', label: 'ê²€ìƒ‰' },
        'ë³´ì•ˆ': { icon: 'ğŸ”', color: '#d97706', bg: '#fef3c7', label: 'ë³´ì•ˆ' },
        'ë°±ì—…': { icon: 'ğŸ’¾', color: '#0891b2', bg: '#cffafe', label: 'ë°±ì—…' },
        'ë³µêµ¬': { icon: 'ğŸ”„', color: '#059669', bg: '#d1fae5', label: 'ë³µêµ¬' },
        'ë²„íŠ¼í´ë¦­': { icon: 'ğŸ‘†', color: '#6b7280', bg: '#f3f4f6', label: 'ê¸°íƒ€' },
        'ì—‘ì…€ê°€ì ¸ì˜¤ê¸°': { icon: 'ğŸ“¥', color: '#0369a1', bg: '#e0f2fe', label: 'ê°€ì ¸ì˜¤ê¸°' },
      };

      function getLogType(log) {
        // fieldê°€ ì‹ ê·œì¶”ê°€/ì‚­ì œ/ê²€ìƒ‰/ë³´ì•ˆ/ë°±ì—…/ë³µêµ¬/ë²„íŠ¼í´ë¦­/ì—‘ì…€ê°€ì ¸ì˜¤ê¸°ì¸ ê²½ìš°
        const knownTypes = ['ì‹ ê·œì¶”ê°€', 'ì‚­ì œ', 'ê²€ìƒ‰', 'ë³´ì•ˆ', 'ë°±ì—…', 'ë³µêµ¬', 'ë²„íŠ¼í´ë¦­', 'ì—‘ì…€ê°€ì ¸ì˜¤ê¸°'];
        if (knownTypes.includes(log.field)) return log.field;
        // changeê°€ 'ì‚­ì œ'ì¸ ê²½ìš°
        if (log.change === 'ì‚­ì œ') return 'ì‚­ì œ';
        // ê·¸ ì™¸ëŠ” 'ìˆ˜ì •' (êµìœ¡ëª…ì´ fieldì¸ ê²½ìš°)
        return 'ìˆ˜ì •';
      }

      function formatRelativeTime(date) {
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        if (diff < 60) return `${diff}ì´ˆ ì „`;
        if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
        if (diff < 604800) return `${Math.floor(diff / 86400)}ì¼ ì „`;
        return null;
      }

      function formatDate(log) {
        try {
          if (!log.timestamp) return 'ë‚ ì§œ ì—†ìŒ';
          const d = (typeof log.timestamp.toDate === 'function') ? log.timestamp.toDate() : new Date(log.timestamp);
          if (isNaN(d)) return 'ë‚ ì§œ ì˜¤ë¥˜';
          const rel = formatRelativeTime(d);
          const full = d.toLocaleString('ko-KR', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
          return rel ? `<span title="${full}">${rel}</span>` : `<span>${full}</span>`;
        } catch (e) { return 'ë‚ ì§œ ì˜¤ë¥˜'; }
      }

      // ì—­ìˆœ(ìµœì‹ ìˆœ) + í•„í„° ì ìš©
      let sorted = [...logs].reverse();

      if (typeFilter) {
        sorted = sorted.filter(log => {
          const t = getLogType(log);
          if (typeFilter === 'ë²„íŠ¼í´ë¦­') return t === 'ë²„íŠ¼í´ë¦­' || t === 'ì—‘ì…€ê°€ì ¸ì˜¤ê¸°';
          if (typeFilter === 'ìˆ˜ì •') return t === 'ìˆ˜ì •';
          return t === typeFilter;
        });
      }

      if (searchQ) {
        sorted = sorted.filter(log => {
          const combined = [log.field, log.change, log.value, log.result].filter(Boolean).join(' ').toLowerCase();
          return combined.includes(searchQ);
        });
      }

      if (logCountEl) {
        logCountEl.textContent = `ì´ ${logs.length}ê±´ ì¤‘ ${sorted.length}ê±´ í‘œì‹œ`;
      }

      if (sorted.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;color:var(--muted)">ì¡°ê±´ì— ë§ëŠ” ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      // ë‚ ì§œë³„ ê·¸ë£¹í•‘
      const groups = {};
      sorted.forEach(log => {
        let dayKey = 'ë‚ ì§œ ì—†ìŒ';
        try {
          if (log.timestamp) {
            const d = (typeof log.timestamp.toDate === 'function') ? log.timestamp.toDate() : new Date(log.timestamp);
            if (!isNaN(d)) dayKey = d.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
          }
        } catch (e) { }
        if (!groups[dayKey]) groups[dayKey] = [];
        groups[dayKey].push(log);
      });

      container.innerHTML = Object.entries(groups).map(([day, dayLogs]) => {
        const rows = dayLogs.map(log => {
          const logType = getLogType(log);
          const cfg = logTypeConfig[logType] || { icon: 'â€¢', color: '#6b7280', bg: '#f3f4f6', label: logType };
          const isMod = logType === 'ìˆ˜ì •';

          // ìˆ˜ì • ë¡œê·¸: field=êµìœ¡ëª…, change=í•„ë“œëª…, value='ì´ì „â†’ì´í›„'
          let mainTitle = '';
          let subContent = '';

          if (isMod) {
            mainTitle = `<span style="font-weight:700; color:#1e293b;">${escHtml(log.field || '')}</span>`;
            const changeParts = (log.value || '').split(' â†’ ');
            if (changeParts.length === 2) {
              subContent = `
                <span style="color:#6b7280;">[${escHtml(log.change || '')}]</span>
                <span style="background:#fee2e2; color:#dc2626; padding:1px 5px; border-radius:3px; margin:0 4px; font-size:11px;">${escHtml(changeParts[0])}</span>
                <span style="color:#9ca3af;">â†’</span>
                <span style="background:#dcfce7; color:#16a34a; padding:1px 5px; border-radius:3px; margin:0 4px; font-size:11px;">${escHtml(changeParts[1])}</span>
              `;
            } else {
              subContent = `<span style="color:#374151;">${escHtml(log.change || '')} : ${escHtml(log.value || '')}</span>`;
            }
          } else {
            mainTitle = `<span style="font-weight:700; color:#1e293b;">${escHtml(log.change || '')}</span>`;
            subContent = log.value ? `<span style="color:#6b7280;">${escHtml(log.value)}</span>` : '';
          }

          // ê²°ê³¼ ë°°ì§€ ì²˜ë¦¬
          const resultStr = log.result || '';
          let resultBadge = '';
          if (resultStr) {
            const isOk = resultStr.startsWith('âœ…');
            const isFail = resultStr.startsWith('âŒ');
            const isWarn = resultStr.startsWith('âš ï¸');
            const rColor = isOk ? '#16a34a' : isFail ? '#dc2626' : isWarn ? '#d97706' : '#6b7280';
            const rBg = isOk ? '#dcfce7' : isFail ? '#fee2e2' : isWarn ? '#fef3c7' : '#f3f4f6';
            resultBadge = `<span style="display:inline-block; padding:2px 8px; border-radius:8px; font-size:11px; font-weight:600; background:${rBg}; color:${rColor}; white-space:nowrap;">${escHtml(resultStr)}</span>`;
          }

          return `
            <div style="display:grid; grid-template-columns:100px 1fr 160px 100px; align-items:center; gap:10px; padding:8px 16px; border-bottom:1px solid #f1f5f9; transition:background 0.1s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''">
              <div style="text-align:center;">
                <span style="display:inline-block; padding:2px 7px; border-radius:10px; font-size:11px; font-weight:700; background:${cfg.bg}; color:${cfg.color};">
                  ${cfg.icon} ${cfg.label}
                </span>
              </div>
              <div style="font-size:12px; line-height:1.65; overflow:hidden;">
                <div style="font-weight:600; color:#1e293b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${mainTitle}</div>
                <div style="margin-top:2px; color:#64748b;">${subContent}</div>
              </div>
              <div style="text-align:center;">
                ${resultBadge}
              </div>
              <div style="font-size:11px; color:#9ca3af; white-space:nowrap; text-align:right;">
                ${formatDate(log)}
              </div>
            </div>
          `;
        }).join('');

        return `
          <div style="background:#f1f5f9; padding:5px 16px; font-size:11px; font-weight:700; color:#64748b; border-bottom:1px solid #e2e8f0; position:sticky; top:0; z-index:1;">
            ${day} &nbsp;Â·&nbsp; ${dayLogs.length}ê±´
          </div>
          ${rows}
        `;
      }).join('');
    }

    function escHtml(str) {
      return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function clearLogsData() {
      if (!confirm('ì •ë§ ëª¨ë“  ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      logs = [];
      db.collection(FS_COL).doc(FS_LOG_DOC).set({ logs: [] }).then(() => {
        showToast('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        renderLogs();
      });
    }


    // ================================================================
    // PARTICIPANTS LOADING
    // ================================================================
    async function loadParticipants(record) {
      const listEl = document.getElementById('participantsList');
      listEl.innerHTML = '<div style="padding:20px;text-align:center"><div class="loading-spinner"></div> eKADAì—ì„œ ì°¸ì—¬ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      // ë¹„ê³  í•„ë“œì—ì„œ eKADA ID ì¶”ì¶œ ("eKADA ID: 985" í˜•ì‹)
      const idMatch = (record.ë¹„ê³  || '').match(/eKADA ID:\s*(\d+)/);
      if (!idMatch) {
        listEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">eKADA IDê°€ ì—†ìŠµë‹ˆë‹¤. (ë¹„ê³  í•„ë“œ í™•ì¸)</div>';
        return;
      }
      const ekadaId = idMatch[1];

      try {
        const resp = await fetch(`https://edu.kada.or.kr/educations/manager/players/?education=${ekadaId}`, { credentials: 'include' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const html = await resp.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const rows = [...doc.querySelectorAll('tbody tr')];

        if (rows.length === 0) {
          listEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted)">ì°¸ì—¬ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        const tableRows = rows.map(row => {
          const tds = [...row.querySelectorAll('td')];
          const name = tds[0]?.innerText.trim() || '';
          const userid = tds[1]?.innerText.trim() || '';
          const gender = tds[2]?.innerText.trim() || '';
          const phone = tds[3]?.innerText.trim() || '';
          const email = tds[4]?.innerText.trim() || '';
          const count = tds[5]?.innerText.trim() || '';
          if (!name) return '';
          return `<tr>
        <td style="padding:5px 8px;font-weight:600">${name}</td>
        <td style="padding:5px 8px;color:var(--muted)">${userid}</td>
        <td style="padding:5px 8px;text-align:center">${gender}</td>
        <td style="padding:5px 8px">${phone}</td>
        <td style="padding:5px 8px;color:var(--muted);font-size:10px">${email}</td>
        <td style="padding:5px 8px;text-align:center;color:var(--accent);font-weight:600">${count}íšŒ</td>
      </tr>`;
        }).filter(Boolean).join('');

        listEl.innerHTML = `
      <div style="padding:8px 12px;background:var(--kada-light);font-size:11px;color:var(--muted);border-bottom:1px solid var(--border)">
        ğŸ“‹ eKADA ID: ${ekadaId} / ì´ ${rows.length}ëª…
      </div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="background:#f1f5f9;border-bottom:2px solid var(--border)">
              <th style="padding:6px 8px;text-align:left">ì´ë¦„</th>
              <th style="padding:6px 8px;text-align:left">ì•„ì´ë””</th>
              <th style="padding:6px 8px;text-align:center">ì„±ë³„</th>
              <th style="padding:6px 8px;text-align:left">ì—°ë½ì²˜</th>
              <th style="padding:6px 8px;text-align:left">ì´ë©”ì¼</th>
              <th style="padding:6px 8px;text-align:center">2026êµìœ¡</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>`;
      } catch (e) {
        listEl.innerHTML = `<div style="padding:20px;text-align:center;color:var(--danger)">
      ë¡œë“œ ì‹¤íŒ¨: ${e.message}<br>
      <span style="font-size:10px;color:var(--muted)">edu.kada.or.kr ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
    </div>`;
      }
    }


    // ================================================================
    // ë¡œì»¬ ë°ì´í„° â†’ Firestore ë§ˆì´ê·¸ë ˆì´ì…˜
    // ================================================================
    function migrateFromLocalStorage() {
      const OLD_KEY = 'kada_edu_2026';
      const OLD_LOG_KEY = 'kada_edu_logs_2026';
      const localData = localStorage.getItem(OLD_KEY);
      if (!localData) {
        showToast('ë¡œì»¬ì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
      }
      const localRecords = JSON.parse(localData);
      const localLogs = JSON.parse(localStorage.getItem(OLD_LOG_KEY) || '[]');

      if (!confirm(`ë¡œì»¬ ë°ì´í„° ${localRecords.length}ê±´ì„ Firestoreë¡œ ì˜¬ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ Firestore ë°ì´í„°ì— ì¶”ê°€ë©ë‹ˆë‹¤)`)) return;

      // ë°°ì¹˜ë¡œ ë ˆì½”ë“œ 1ê°œ = ë¬¸ì„œ 1ê°œì”© ì €ì¥
      const batch = db.batch();
      localRecords.forEach(rec => {
        const ref = db.collection(FS_COL).doc(); // ìƒˆ ìë™ ID
        const clean = { ...rec };
        delete clean._id; // ê¸°ì¡´ _id ì œê±°
        batch.set(ref, clean);
      });
      batch.commit()
        .then(() => db.collection(FS_LOG).doc('main').set({ logs: localLogs }))
        .then(() => {
          showToast(`âœ… ${localRecords.length}ê±´ Firestore ì—…ë¡œë“œ ì™„ë£Œ!`, 'success');
          document.getElementById('btnMigrate').style.display = 'none';
        })
        .catch(e => showToast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error'));
    }

    function checkMigrateButton() {
      const OLD_KEY = 'kada_edu_2026';
      if (localStorage.getItem(OLD_KEY)) {
        const btn = document.getElementById('btnMigrate');
        if (btn) btn.style.display = 'inline-flex';
      }
    }

    // ================================================================
    // INFOGRAPHIC
    // ================================================================
    let _infoCharts = {};
    let _activeTargets = new Set(TARGET_KEYS.slice(0, 10));

    function openInfographicModal() {
      openModal('infographicModal');
      setTimeout(buildInfographicCharts, 120);
    }

    function destroyInfoChart(key) {
      if (_infoCharts[key]) {
        _infoCharts[key].destroy();
        delete _infoCharts[key];
      }
    }

    function getParticipants(r) {
      return parseInt(r.ì°¸ì—¬ììˆ˜) || parseInt(r.ì¸ì›_ê³„) || 0;
    }

    function buildInfographicCharts() {
      const data = records;

      /* â”€â”€ 1. ì›”ë³„ êµìœ¡ ì‹¤ì  (ë³µí•© ì°¨íŠ¸: ìŠ¤íƒë°” + ë“€ì–¼ ë¼ì¸) â”€â”€ */
      try {
        destroyInfoChart('monthly');
        const mCount    = Array(12).fill(0);
        const mLecture  = Array(12).fill(0);
        const mActivity = Array(12).fill(0);
        const mInstr = Array(12).fill(0);

        data.forEach(r => {
          const m = parseInt(r.ì›”) || (r.êµìœ¡ì¼ ? new Date(r.êµìœ¡ì¼).getMonth() + 1 : 0);
          if (m < 1 || m > 12) return;
          const mi = m - 1;
          mCount[mi]++;
          const typ = (r.êµìœ¡ìœ í˜• || r.ìœ í˜• || '').trim();
          if (typ === 'ê°•ì˜í˜•(ëŒ€ë©´)êµìœ¡' || typ === 'ì˜¨ë¼ì¸ ì‹¤ì‹œê°„') mLecture[mi]++;
          else if (typ === 'ì²´í—˜í˜•' || typ === 'ì•„ì›ƒë¦¬ì¹˜' || typ === 'FPG') mActivity[mi]++;
          // ì´ ì¶œê°• íšŸìˆ˜: ê°•ì‚¬ìˆ˜ í•„ë“œ ìš°ì„ , ì—†ìœ¼ë©´ ê°•ì‚¬1~9 ì±„ì›Œì§„ í•„ë“œ ìˆ˜ë¡œ ê³„ì‚°
          const instrNum = parseInt(r.ê°•ì‚¬ìˆ˜);
          if (instrNum > 0) {
            mInstr[mi] += instrNum;
          } else {
            for (let i = 1; i <= 9; i++) {
              if ((r['ê°•ì‚¬' + i] || '').trim()) mInstr[mi]++;
            }
          }
        });

        // Yì¶• max: ë‹¨ì¼ ë§‰ëŒ€(ì´ê±´ìˆ˜) + 3ê°œ ë¼ì¸ ì¤‘ ìµœëŒ€ê°’ + 20% ì—¬ë°±
        const yRawMax = Math.max(...mCount, ...mInstr, ...mLecture, ...mActivity);
        const yAxisMax = yRawMax + Math.max(2, Math.ceil(yRawMax * 0.20));

        _infoCharts.monthly = new Chart(document.getElementById('chartMonthly'), {
          type: 'bar',
          plugins: [ChartDataLabels],
          data: {
            labels: MONTHS,
            datasets: [
              {
                // ì´ êµìœ¡ ê±´ìˆ˜ â†’ ë§‰ëŒ€ (ë°°ê²½ ì—­í• )
                label: 'ì´ êµìœ¡ ê±´ìˆ˜',
                type: 'bar',
                data: mCount,
                backgroundColor: 'rgba(99,102,241,0.18)',
                borderColor: 'rgba(99,102,241,0.40)',
                borderWidth: 1,
                borderRadius: 4,
                order: 4,
              },
              {
                // ì „ë¬¸ê°•ì‚¬ ìˆ˜ â†’ êº½ì€ì„ 
                label: 'ì „ë¬¸ê°•ì‚¬ ìˆ˜',
                type: 'line',
                data: mInstr,
                borderColor: '#16a34a',
                backgroundColor: 'transparent',
                fill: false,
                tension: 0.35,
                pointBackgroundColor: '#16a34a',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2,
                order: 1,
              },
              {
                // ê°•ì˜í˜• êµìœ¡ íšŸìˆ˜ â†’ êº½ì€ì„ 
                label: 'ê°•ì˜í˜• êµìœ¡',
                type: 'line',
                data: mLecture,
                borderColor: '#2563eb',
                backgroundColor: 'transparent',
                fill: false,
                tension: 0.35,
                pointBackgroundColor: '#2563eb',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2,
                order: 2,
              },
              {
                // í™œë™í˜• êµìœ¡ íšŸìˆ˜ â†’ êº½ì€ì„ 
                label: 'í™œë™í˜• êµìœ¡',
                type: 'line',
                data: mActivity,
                borderColor: '#f59e0b',
                backgroundColor: 'transparent',
                fill: false,
                tension: 0.35,
                pointBackgroundColor: '#f59e0b',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
                borderWidth: 2,
                order: 3,
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: { font: { size: 11 }, padding: 12, usePointStyle: true, pointStyleWidth: 10, color: '#374151' }
              },
              datalabels: {
                // ë§‰ëŒ€(ì´ê±´ìˆ˜)ë§Œ ë ˆì´ë¸” í‘œì‹œ, ë¼ì¸ì€ í‘œì‹œ ì•ˆ í•¨
                display: ctx => {
                  try { return ctx.dataset.type !== 'line' && ctx.parsed && ctx.parsed.y > 0; }
                  catch(e) { return false; }
                },
                anchor: 'end', align: 'top',
                font: { weight: '800', size: 10 }, color: '#6366f1',
                formatter: v => v > 0 ? v : '',
              },
              tooltip: {
                backgroundColor: 'rgba(30,41,59,0.92)', titleColor: '#e2e8f0', bodyColor: '#cbd5e1', padding: 10,
                callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y}íšŒ` }
              }
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { size: 11 } } },
              // stacked ì œê±° â†’ ë¼ì¸ì´ ëˆ„ì  ì˜¤ë¥˜ ì—†ì´ ì •í™•í•œ yê°’ì— í‘œì‹œë¨
              y: { beginAtZero: true, max: yAxisMax, ticks: { stepSize: 1 }, grid: { color: '#f1f5f9' } }
            }
          }
        });
      } catch(e) { console.error('ì›”ë³„ ì°¨íŠ¸ ì˜¤ë¥˜:', e); }

      /* â”€â”€ 2. ê¶Œì—­ë³„ ì§€ë„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      try {
        buildKoreaMap(data);
      } catch(e) {
        console.error('ê¶Œì—­ë³„ ì§€ë„ ì˜¤ë¥˜:', e);
        const mc = document.getElementById('koreaMapContainer');
        if (mc) mc.innerHTML = '<div style="padding:24px;text-align:center;color:#dc2626;font-size:12px">&#9888; ì§€ë„ ì˜¤ë¥˜: ' + (e.message || e) + '</div>';
      }

      /* â”€â”€ 3. ìœ í˜•ë³„ êµìœ¡ ì‹¤ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      try {
        destroyInfoChart('type');
        const typeCounts = {};
        data.forEach(r => {
          const t = (r.êµìœ¡ìœ í˜• || r.ìœ í˜• || 'ê¸°íƒ€').trim();
          typeCounts[t] = (typeCounts[t] || 0) + 1;
        });
        const typeLabels = Object.keys(typeCounts);
        const typeColors = ['#2563eb','#7c3aed','#0891b2','#16a34a','#dc2626','#d97706','#64748b','#0e7490'];
        _infoCharts.type = new Chart(document.getElementById('chartType'), {
          type: 'pie',
          plugins: [ChartDataLabels],
          data: {
            labels: typeLabels,
            datasets: [{ data: typeLabels.map(l => typeCounts[l]), backgroundColor: typeColors.slice(0, typeLabels.length), borderWidth: 2, borderColor: '#fff' }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 10, boxWidth: 14 } },
              datalabels: {
                formatter: (val, ctx) => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const pct = Math.round(val / total * 100);
                  return pct > 4 ? pct + '%' : '';
                },
                color: '#fff', font: { weight: '700', size: 12 }
              }
            }
          }
        });
      } catch(e) { console.error('ìœ í˜•ë³„ ì°¨íŠ¸ ì˜¤ë¥˜:', e); }

      /* â”€â”€ 4. ê°•ì‚¬ë³„ êµìœ¡ ì‹¤ì  (ìˆ˜í‰ ë¡¤ë¦¬íŒ SVG) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      try {
        destroyInfoChart('instructor');
        const iCounts = {};
        data.forEach(r => {
          for (let i = 1; i <= 9; i++) {
            const nm = (r['ê°•ì‚¬' + i] || '').trim();
            if (nm) iCounts[nm] = (iCounts[nm] || 0) + 1;
          }
        });
        const iSorted = Object.entries(iCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
        const instrCanvas = document.getElementById('chartInstructor');
        instrCanvas.style.display = 'none';
        const instrWrap = instrCanvas.parentElement;
        const oldInstr = instrWrap.querySelector('.instr-lollipop');
        if (oldInstr) oldInstr.remove();

        const lollPalette = ['#6d28d9','#7c3aed','#8b5cf6','#a78bfa','#c4b5fd',
          '#1d4ed8','#2563eb','#3b82f6','#0891b2','#0e7490',
          '#15803d','#16a34a','#d97706','#b45309','#92400e'];
        const iDiv = document.createElement('div');
        iDiv.className = 'instr-lollipop';

        if (iSorted.length === 0) {
          iDiv.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          const imaxV = iSorted[0][1];
          const LW = 90, BARW = 240, ROW = 34, PAD = 8;
          const iSvgW = LW + BARW + 48;
          const iSvgH = iSorted.length * ROW + PAD * 2;
          let svgStr = `<svg viewBox="0 0 ${iSvgW} ${iSvgH}" xmlns="http://www.w3.org/2000/svg" style="width:100%;display:block;overflow:visible">`;
          iSorted.forEach(([name, cnt], idx) => {
            const iy = PAD + idx * ROW + ROW / 2;
            const bW = Math.max(8, (cnt / imaxV) * BARW);
            const col = lollPalette[idx % lollPalette.length];
            svgStr += `<rect x="${LW}" y="${iy-6}" width="${BARW}" height="12" rx="6" fill="#f1f5f9"/>` +
              `<rect x="${LW}" y="${iy-6}" width="${bW}" height="12" rx="6" fill="${col}28"/>` +
              `<line x1="${LW+6}" y1="${iy}" x2="${LW+bW-8}" y2="${iy}" stroke="${col}" stroke-width="2" stroke-linecap="round" opacity="0.7"/>` +
              `<circle cx="${LW+bW}" cy="${iy}" r="9" fill="${col}"/>` +
              `<text x="${LW+bW}" y="${iy+4}" text-anchor="middle" font-size="9" font-weight="800" fill="#fff" font-family="sans-serif">${cnt}</text>` +
              `<text x="${LW-8}" y="${iy+4}" text-anchor="end" font-size="11" font-weight="600" fill="#374151" font-family="sans-serif">${name}</text>`;
          });
          svgStr += '</svg>';
          iDiv.innerHTML = svgStr;
        }
        instrWrap.appendChild(iDiv);
      } catch(e) { console.error('ê°•ì‚¬ë³„ ì°¨íŠ¸ ì˜¤ë¥˜:', e); }

      /* â”€â”€ 5. ê¸°ê´€ë³„ êµìœ¡ ì‹¤ì  (ë©”ë‹¬ ìˆœìœ„ ë¦¬ìŠ¤íŠ¸) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      try {
        destroyInfoChart('org');
        const oCounts = {};
        data.forEach(r => {
          const o = (r.ê¸°ê´€ëª… || '').trim();
          if (o) oCounts[o] = (oCounts[o] || 0) + 1;
        });
        const oSorted = Object.entries(oCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
        const orgCanvas = document.getElementById('chartOrg');
        orgCanvas.style.display = 'none';
        const orgWrap = orgCanvas.parentElement;
        const oldOrg = orgWrap.querySelector('.org-ranked');
        if (oldOrg) oldOrg.remove();

        const omaxV = oSorted.length ? oSorted[0][1] : 1;
        const oMedals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
        const oBgs    = ['#fffbeb','#f8fafc','#fff7ed'];
        const oBords  = ['1px solid #fde68a','1px solid #e2e8f0','1px solid #fed7aa'];

        const oDiv = document.createElement('div');
        oDiv.className = 'org-ranked';
        oDiv.style.cssText = 'max-height:380px;overflow-y:auto;padding:2px 4px 2px 2px';

        if (oSorted.length === 0) {
          oDiv.innerHTML = '<div style="padding:40px;text-align:center;color:#94a3b8">ë°ì´í„° ì—†ìŒ</div>';
        } else {
          oSorted.forEach(([name, cnt], i) => {
            const pct   = Math.round((cnt / omaxV) * 100);
            const isTop = i < 3;
            const row   = document.createElement('div');
            row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px 10px;margin-bottom:5px;' +
              'background:' + (isTop ? oBgs[i] : 'transparent') + ';' +
              'border:' + (isTop ? oBords[i] : '1px solid transparent') + ';border-radius:10px';
            const badgeHTML = isTop
              ? `<span style="font-size:17px">${oMedals[i]}</span>`
              : `<span style="width:24px;height:24px;border-radius:50%;background:#e2e8f0;color:#64748b;font-size:10px;font-weight:700;display:inline-flex;align-items:center;justify-content:center">${i+1}</span>`;
            row.innerHTML =
              `<div style="flex-shrink:0;width:28px;display:flex;align-items:center;justify-content:center">${badgeHTML}</div>` +
              `<div style="flex:1;min-width:0">` +
                `<div style="font-size:12px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px">${name}</div>` +
                `<div style="display:flex;align-items:center;gap:8px">` +
                  `<div style="flex:1;background:#f1f5f9;border-radius:99px;height:7px;overflow:hidden">` +
                    `<div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#2563eb,#7c3aed);border-radius:99px"></div>` +
                  `</div>` +
                  `<span style="font-size:14px;font-weight:800;color:#1d4ed8;min-width:24px;text-align:right">${cnt}</span>` +
                  `<span style="font-size:9px;color:#94a3b8">íšŒ</span>` +
                `</div>` +
              `</div>`;
            oDiv.appendChild(row);
          });
        }
        orgWrap.appendChild(oDiv);
      } catch(e) { console.error('ê¸°ê´€ë³„ ì°¨íŠ¸ ì˜¤ë¥˜:', e); }

      /* â”€â”€ 6. ëŒ€ìƒë³„ êµìœ¡ ì‹¤ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      try {
        buildTargetChips();
      } catch(e) { console.error('ëŒ€ìƒë³„ ì°¨íŠ¸ ì˜¤ë¥˜:', e); }
    }

    /* â”€â”€ í•œêµ­ ì§€ë„ (íƒ€ì¼ ì¹´í† ê·¸ë¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function buildKoreaMap(data) {
      const regionCount = {};
      REGIONS.forEach(r => { regionCount[r] = 0; });
      data.forEach(rec => {
        if (rec.ê¶Œì—­ && regionCount.hasOwnProperty(rec.ê¶Œì—­)) regionCount[rec.ê¶Œì—­]++;
      });

      const maxVal = Math.max(1, ...Object.values(regionCount));

      // í•œêµ­ ì§€ë¦¬ ë°°ì¹˜ ê¸°ë°˜ íƒ€ì¼ ì¹´í† ê·¸ë¨ (col 0~3, row 0~5)
      const tiles = [
        { n: 'ê°•ì›',  col:3, row:0 },
        { n: 'ì¸ì²œ',  col:0, row:1, city:true },
        { n: 'ì„œìš¸',  col:1, row:1, city:true },
        { n: 'ê²½ê¸°',  col:2, row:1 },
        { n: 'ì¶©ë‚¨',  col:0, row:2 },
        { n: 'ì„¸ì¢…',  col:1, row:2, city:true },
        { n: 'ì¶©ë¶',  col:2, row:2 },
        { n: 'ê²½ë¶',  col:3, row:2 },
        { n: 'ì „ë¶',  col:0, row:3 },
        { n: 'ëŒ€ì „',  col:1, row:3, city:true },
        { n: 'ëŒ€êµ¬',  col:2, row:3, city:true },
        { n: 'ìš¸ì‚°',  col:3, row:3, city:true },
        { n: 'ì „ë‚¨',  col:0, row:4 },
        { n: 'ê´‘ì£¼',  col:1, row:4, city:true },
        { n: 'ê²½ë‚¨',  col:2, row:4 },
        { n: 'ë¶€ì‚°',  col:3, row:4, city:true },
        { n: 'ì œì£¼',  col:1, row:5 },
      ];

      const TW = 85, TH = 62, GAP = 6;
      const svgW = 4 * (TW + GAP) + GAP;          // 370
      const svgH = 6 * (TH + GAP) + GAP + 26;     // 440 (legend í¬í•¨)

      let svg = `<svg viewBox="0 0 ${svgW} ${svgH}" xmlns="http://www.w3.org/2000/svg" style="width:100%;max-height:420px">
  <rect width="${svgW}" height="${svgH}" fill="#f8fafc" rx="10"/>`;

      tiles.forEach(t => {
        const cnt = regionCount[t.n] || 0;
        const ratio = cnt / maxVal;
        const x = t.col * (TW + GAP) + GAP;
        const y = t.row * (TH + GAP) + GAP;
        const cx = x + TW / 2;
        const cy = y + TH / 2;

        // ë„Â·êµ° = íŒŒë‘ ê³„ì—´, íŠ¹Â·ê´‘ì—­ì‹œÂ·ì„¸ì¢… = ì£¼í™© ê³„ì—´
        let fr, fg, fb;
        if (t.city) {
          fr = Math.round(255 - ratio * 90);
          fg = Math.round(237 - ratio * 150);
          fb = Math.round(213 - ratio * 160);
        } else {
          fr = Math.round(219 - ratio * 190);
          fg = Math.round(234 - ratio * 140);
          fb = Math.round(254 - ratio * 100);
        }
        const fill   = `rgb(${fr},${fg},${fb})`;
        const stroke = t.city ? (ratio > 0.3 ? '#f97316' : '#fed7aa') : (ratio > 0.3 ? '#3b82f6' : '#bfdbfe');
        const txtFill = ratio > 0.6 ? '#fff' : '#1e293b';
        const numFill = ratio > 0.6 ? 'rgba(255,255,255,0.96)'
                      : (t.city ? '#c2410c' : '#1d4ed8');

        svg += `
  <rect x="${x}" y="${y}" width="${TW}" height="${TH}" fill="${fill}" stroke="${stroke}" stroke-width="1.5" rx="10"/>
  <text x="${cx}" y="${cy - 9}" text-anchor="middle" font-size="10" font-weight="700" fill="${txtFill}" font-family="Malgun Gothic,sans-serif">${t.n}</text>
  <text x="${cx}" y="${cy + 9}" text-anchor="middle" font-size="17" font-weight="900" fill="${numFill}" font-family="Malgun Gothic,sans-serif">${cnt > 0 ? cnt : 'Â·'}</text>
  <text x="${cx}" y="${cy + 22}" text-anchor="middle" font-size="8" fill="${numFill}" font-family="Malgun Gothic,sans-serif" opacity="0.75">${cnt > 0 ? 'íšŒ' : ''}</text>`;
      });

      // ë²”ë¡€
      const ly = svgH - 12;
      svg += `
  <rect x="8"  y="${ly - 9}" width="10" height="10" fill="rgb(185,215,255)" rx="2"/>
  <text x="22" y="${ly}" font-size="8.5" fill="#64748b" font-family="Malgun Gothic,sans-serif">ë„Â·êµ°</text>
  <rect x="58" y="${ly - 9}" width="10" height="10" fill="rgb(255,205,175)" rx="2"/>
  <text x="72" y="${ly}" font-size="8.5" fill="#64748b" font-family="Malgun Gothic,sans-serif">íŠ¹Â·ê´‘ì—­ì‹œÂ·ì„¸ì¢…</text>
</svg>`;

      document.getElementById('koreaMapContainer').innerHTML = svg;
    }

    /* â”€â”€ ëŒ€ìƒ ì¹© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function buildTargetChips() {
      const group = document.getElementById('targetChipGroup');
      group.innerHTML = TARGET_KEYS.map((k, i) => {
        const label = (TARGET_LABELS[i] || k).replace(/\n/g, ' ');
        const active = _activeTargets.has(k) ? ' active' : '';
        return `<span class="target-chip${active}" onclick="toggleTargetChip('${k}',this)">${label}</span>`;
      }).join('');
      renderTargetChart();
    }

    function toggleTargetChip(key, el) {
      if (_activeTargets.has(key)) {
        _activeTargets.delete(key);
        el.classList.remove('active');
      } else {
        _activeTargets.add(key);
        el.classList.add('active');
      }
      renderTargetChart();
    }

    function selectAllTargetChips() {
      _activeTargets = new Set(TARGET_KEYS);
      buildTargetChips();
    }

    function deselectAllTargetChips() {
      _activeTargets = new Set();
      buildTargetChips();
    }

    function renderTargetChart() {
      destroyInfoChart('target');
      const selected = TARGET_KEYS.filter(k => _activeTargets.has(k));
      if (selected.length === 0) {
        const ctx = document.getElementById('chartTarget');
        if (ctx) ctx.style.display = 'none';
        return;
      }
      document.getElementById('chartTarget').style.display = '';
      const labels = selected.map(k => (TARGET_LABELS[TARGET_KEYS.indexOf(k)] || k).replace(/\n/g, ' '));
      const sums = selected.map(k => records.reduce((s, r) => s + (parseInt(r[k]) || 0), 0));
      _infoCharts.target = new Chart(document.getElementById('chartTarget'), {
        type: 'bar',
        plugins: [ChartDataLabels],
        data: {
          labels,
          datasets: [{
            data: sums,
            backgroundColor: sums.map(v => v > 0 ? 'rgba(22,163,74,0.75)' : 'rgba(203,213,225,0.4)'),
            borderRadius: 5,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end', align: 'top',
              font: { weight: '700', size: 10 },
              color: '#1e293b',
              formatter: v => v > 0 ? v.toLocaleString() : ''
            }
          },
          scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } } }
        }
      });
    }

    // ================================================================
    // INIT
    // ================================================================
    document.addEventListener('DOMContentLoaded', () => {
      initFilters();
      buildHeader();
      renderTable(); // ì´ˆê¸° ë¹ˆ í…Œì´ë¸” ë¨¼ì € í‘œì‹œ
      initFirestore(); // Firestore ì‹¤ì‹œê°„ ì—°ê²° (ë°ì´í„° ì˜¤ë©´ ìë™ renderTable)
      // checkMigrateButton(); // ë¡œì»¬ ë°ì´í„° ìˆìœ¼ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„íŠ¼ í‘œì‹œ
    });

    // (ì°¸ì—¬ìëª…ë‹¨ íƒ­ ì œê±°ë¡œ modal-tab ì´ë²¤íŠ¸ ë°”ì¸ë”© ë¶ˆí•„ìš”)

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', e => {
        if (e.target === overlay) overlay.classList.remove('active');
      });
    });
  </script>
</body>

</html>